<!DOCTYPE html><html lang="zh-CN" data-theme="light"> <head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>STM32智能小车 | 会飞的鱼</title><meta name="author" content="6+1"><meta name="copyright" content="6+1"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="智能小车">
<meta property="og:type" content="article">
<meta property="og:title" content="STM32智能小车">
<meta property="og:url" content="http://example.com/2023/11/22/STM32%E6%99%BA%E8%83%BD%E5%B0%8F%E8%BD%A6/index.html">
<meta property="og:site_name" content="会飞的鱼">
<meta property="og:description" content="智能小车">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/num10.webp">
<meta property="article:published_time" content="2023-11-22T13:10:15.000Z">
<meta property="article:modified_time" content="2023-11-25T11:35:25.718Z">
<meta property="article:author" content="6+1">
<meta property="article:tag" content="STM32">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/num10.webp"><link rel="shortcut icon" href="/img/tubiao.webp"><link rel="canonical" href="http://example.com/2023/11/22/STM32%E6%99%BA%E8%83%BD%E5%B0%8F%E8%BD%A6/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'STM32智能小车',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-11-25 19:35:25'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = url => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      link.onload = () => resolve()
      link.onerror = () => reject()
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/element-ui@2.15.6/packages/theme-chalk/lib/index.css"><link rel="stylesheet" href="https://jsd.onmicrosoft.cn/npm/izitoast@1.4.0/dist/css/iziToast.min.css" media="all" onload="this.media='all'"><link rel="stylesheet" href="/css/readPercent.css"><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css"/>
<style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style>
<link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-footer-beautify@1.0.0/lib/runtime.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.0.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/TX1.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">11</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">7</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><i class="fa-fw icon-home"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-home"></use></svg><span> 首页</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><i class="fa-fw icon-guidang"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-guidang"></use></svg><span> 归档</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/tags/"><i class="fa-fw icon-MBEfenggechangyongtubiao-biaoqian"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-MBEfenggechangyongtubiao-biaoqian"></use></svg><span> 标签</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/categories/"><i class="fa-fw icon-fenlei"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-fenlei"></use></svg><span> 分类</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-liebiao"></use></svg><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-yinlecidai">                   </use></svg><span> 音乐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/movies/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon--dianyingyuan-">                   </use></svg><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><i class="fa-fw icon-liuyanban"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-liuyanban"></use></svg><span> 留言板</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/link/"><i class="fa-fw icon-lianjie"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-lianjie"></use></svg><span> 友链</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><i class="fa-fw icon-aixin"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-aixin"></use></svg><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/num10.webp')"><nav class="fixed" id="nav"><span id="blog-info"><a href="/" title="会飞的鱼"><span class="site-name">会飞的鱼</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><svg class="faa-tada icon" style="height:24px;width:24px;fill:currentColor;position:relative;top:6px" aria-hidden="true"><use xlink:href="#icon-sousuo"></use></svg></a></div><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><i class="fa-fw icon-home"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-home"></use></svg><span> 首页</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><i class="fa-fw icon-guidang"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-guidang"></use></svg><span> 归档</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/tags/"><i class="fa-fw icon-MBEfenggechangyongtubiao-biaoqian"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-MBEfenggechangyongtubiao-biaoqian"></use></svg><span> 标签</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/categories/"><i class="fa-fw icon-fenlei"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-fenlei"></use></svg><span> 分类</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-liebiao"></use></svg><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-yinlecidai">                   </use></svg><span> 音乐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/movies/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon--dianyingyuan-">                   </use></svg><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><i class="fa-fw icon-liuyanban"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-liuyanban"></use></svg><span> 留言板</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/link/"><i class="fa-fw icon-lianjie"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-lianjie"></use></svg><span> 友链</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><i class="fa-fw icon-aixin"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-aixin"></use></svg><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">STM32智能小车</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表</span><time class="post-meta-date-created" datetime="2023-11-22T13:10:15.000Z" title="发表 2023-11-22 21:10:15">2023-11-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新</span><time class="post-meta-date-updated" datetime="2023-11-25T11:35:25.718Z" title="更新 2023-11-25 19:35:25">2023-11-25</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE/">项目</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数:</span><span class="word-count">1.9w</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p><strong><em>对应视频合集链接:</em></strong></p>
<p>【STM32智能小车V3-STM32入门教程-STM32项目-STM32循迹小车 避障 蓝牙遥控 课设 毕设 电赛 嵌入式学习 PID控制算法 编码器电机  跟随】 <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV16x4y1M7EN/?p=2&amp;share_source=copy_web&amp;vd_source=f5d5850ab773377dff308188468fbc77">https://www.bilibili.com/video/BV16x4y1M7EN/?p=2&amp;share_source=copy_web&amp;vd_source=f5d5850ab773377dff308188468fbc77</a></p>
<p><strong>项目完整资料(包含PCB与源码):</strong></p>
<p><a target="_blank" rel="noopener" href="https://item.taobao.com/item.htm?spm=a230r.1.14.11.7f004ab4xxrqip&amp;id=698097521244&amp;ns=1&amp;abbucket=10#detail">https://item.taobao.com/item.htm?spm=a230r.1.14.11.7f004ab4xxrqip&amp;id=698097521244&amp;ns=1&amp;abbucket=10#detail</a></p>
<p><strong>项目硬件购买:</strong></p>
<p><a target="_blank" rel="noopener" href="https://item.taobao.com/item.htm?spm=a230r.1.14.11.7f004ab4xxrqip&amp;id=698097521244&amp;ns=1&amp;abbucket=10#detail">https://item.taobao.com/item.htm?spm=a230r.1.14.11.7f004ab4xxrqip&amp;id=698097521244&amp;ns=1&amp;abbucket=10#detail</a></p>
<h1 id="第一章-硬件"><a href="#第一章-硬件" class="headerlink" title="第一章-硬件"></a>第一章-硬件</h1><h2 id="1-1-元件选型"><a href="#1-1-元件选型" class="headerlink" title="1.1-元件选型"></a>1.1-元件选型</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230203225615383.png" alt="image-20230203225615383"></p>
<h2 id="1-2-原理图与PCB"><a href="#1-2-原理图与PCB" class="headerlink" title="1.2-原理图与PCB"></a>1.2-原理图与PCB</h2><p>底板原理图</p>
<p>各个模块的供电电压?</p>
<p>模块接口引脚顺序？</p>
<p>如何确定使用单片机那个引脚？</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221202195108446.png" alt="image-20221202195108446"></p>
<p>STM32F103C8T6核心板原理图(可能使用不同核心板略有差异)</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220715153616072.png" alt="image-20220715153616072"></p>
<p>PCB顶层截图</p>
<p>不同类型线粗细</p>
<p>布局总线方式</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221227210621750.png" alt="image-20221227210621750"></p>
<h2 id="1-3-焊接"><a href="#1-3-焊接" class="headerlink" title="1.3-焊接"></a>1.3-焊接</h2><p>PCB正面</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221231144357465.png" alt="image-20221231144357465"></p>
<p>PCB背面</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221231144233002.png" alt="image-20221231144233002"></p>
<p>然后插上元件</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221231144943159.png" alt="image-20221231144943159"></p>
<h2 id="1-4-结构与组装"><a href="#1-4-结构与组装" class="headerlink" title="1.4-结构与组装"></a>1.4-结构与组装</h2><p>这是组装好的车体照片</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221231150645127.png" alt="image-20221231150645127"></p>
<p>然后小车安装PCB</p>
<p>注意电机和红外对管不要插错</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221231155644678.png" alt="image-20221231155644678"></p>
<h2 id="1-5-测试"><a href="#1-5-测试" class="headerlink" title="1.5-测试"></a>1.5-测试</h2><p>使用万用表 上电前测试一下</p>
<h1 id="第二章-GPIO与中断"><a href="#第二章-GPIO与中断" class="headerlink" title="第二章-GPIO与中断"></a>第二章-GPIO与中断</h1><h2 id="2-0-新建工程"><a href="#2-0-新建工程" class="headerlink" title="2.0-新建工程"></a>2.0-新建工程</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221203140147942.png" alt="image-20221203140147942"></p>
<p>建议选择和我一样的版本</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221203135524319.png" alt="image-20221203135524319"></p>
<p>新建一个工程</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220715154436669.png" alt="image-20220715154436669" style="zoom:33%;" /></p>
<p>选择芯片</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220715154552489.png" alt="image-20220715154552489" style="zoom:33%;" /></p>
<p>选择时钟源</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220715154653642.png" alt="image-20220715154653642"></p>
<p>配置时钟树</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220715155004533.png" alt="image-20220715155004533"></p>
<p>选择调试</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220715155046118.png" alt="image-20220715155046118"></p>
<p>勾选生成独立的文件</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220715155302764.png" alt="image-20220715155302764"></p>
<p>设置保存地址</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220715155657378.png" alt="image-20220715155657378"></p>
<p>勾选这个不添加没有使用库文件可以减小工程文件大小(也可以不勾选，保持默认设置)</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230112223312210.png" alt="image-20230112223312210"></p>
<p>MDK打开工程，调低优化等级</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221203142727527.png" alt="image-20221203142727527"></p>
<p>以上是每次新建工程要做的</p>
<p>以后我们不在新建工程，使用之间的工程即可</p>
<h2 id="2-1-点灯"><a href="#2-1-点灯" class="headerlink" title="2.1-点灯"></a>2.1-点灯</h2><p>这里我们点亮PC13连接的小灯</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220715154319943.png" alt="image-20220715154319943"></p>
<p>配置PC13</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220715160123821.png" alt="image-20220715160123821"></p>
<p>生成代码</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220716155929888.png" alt="image-20220716155929888"></p>
<p>生成代码后，使用MDK打开工程</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220716160106728.png" alt="image-20220716160106728"></p>
<p>先编译一下，没有报错、没有问题</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220716160157185.png" alt="image-20220716160157185" style="zoom:50%;" /></p>
<p>在BEGIN和END添加代码</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220716160451492.png" alt="image-20220716160451492"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HAL_GPIO_TogglePin(LED_GPIO_Port,LED_Pin);</span><br><span class="line">HAL_Delay(<span class="number">500</span>);</span><br></pre></td></tr></table></figure>
<p>根据自己的芯片选择</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220716162757551.png" alt="image-20220716162757551"></p>
<h3 id="烧录程序-必看-使用其中一个方法"><a href="#烧录程序-必看-使用其中一个方法" class="headerlink" title="烧录程序(必看 使用其中一个方法)"></a>烧录程序(必看 使用其中一个方法)</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221227230705273.png" alt="image-20221227230705273"></p>
<h4 id="方法一：使用DAP-LINK"><a href="#方法一：使用DAP-LINK" class="headerlink" title="方法一：使用DAP LINK"></a>方法一：使用DAP LINK</h4><p><strong>接线图</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221229210725895.png" alt="image-20221229210725895"></p>
<p>DAP 在Win 10 免驱动的</p>
<p>然后根据自己使用的工具在MDK中设置下载工具</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220716160642306.png" alt="image-20220716160642306"></p>
<p>设置下载算法</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220716163120042.png" alt="image-20220716163120042"></p>
<p>然后下载程序，复位小灯闪烁</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220716163318393.png" alt="image-20220716163318393"></p>
<p>烧录后现象</p>
<p>小灯每0.5秒闪烁一次</p>
<h4 id="方法二：使用stlink"><a href="#方法二：使用stlink" class="headerlink" title="方法二：使用stlink"></a>方法二：使用stlink</h4><p><strong>接线图</strong></p>
<p>STlink不要接3.3V </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221229211513383.png" alt="image-20221229211513383"></p>
<p>使用Stlink 前先安装驱动</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221227225436767.png" alt="image-20221227225436767"></p>
<p>双击运行</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221227225603998.png" alt="image-20221227225603998"></p>
<p>选择ST-Link</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221227224923189.png" alt="image-20221227224923189"></p>
<p>选择算法</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221227225802761.png" alt="image-20221227225802761"></p>
<p>然后点击编译，烧录</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221227230419753.png" alt="image-20221227230419753"></p>
<p>烧录后现象</p>
<p>小灯每0.5秒闪烁一次</p>
<h3 id="补充可能遇到的失败情况"><a href="#补充可能遇到的失败情况" class="headerlink" title="补充可能遇到的失败情况"></a>补充可能遇到的失败情况</h3><h4 id="使用DAP-LINK"><a href="#使用DAP-LINK" class="headerlink" title="使用DAP-LINK"></a>使用DAP-LINK</h4><p>如果我们芯片IDCODE是0x2 开头的那么我们需要替换一下Keil 的器件包</p>
<p>(如果你是0x1 开头的，如果能下载可以不替换)</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220729142306116.png" alt="image-20220729142306116"></p>
<p>STM32小车相关资料V3.3.0\04使用的软件\中科芯CKS芯片支持包</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220729142706246.png" alt="image-20220729142706246"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220729142753531.png" alt="image-20220729142753531"></p>
<p>下面这个算法就会自动切换</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220729142828921.png" alt="image-20220729142828921"></p>
<h4 id="使用stlink"><a href="#使用stlink" class="headerlink" title="使用stlink"></a>使用stlink</h4><h2 id="2-2-按键"><a href="#2-2-按键" class="headerlink" title="2.2-按键"></a>2.2-按键</h2><p>先看原理图</p>
<p>PB4—KEY1      单片机设置下拉输入-、上降沿触发</p>
<p>PA12—KEY2    单片机设置上拉输入、下降沿触发</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220716164000681.png" alt="image-20220716164000681"  /></p>
<p>开始配置</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220716165737010.png" alt="image-20220716165737010"></p>
<p>使能外部中断</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220727203928114.png" alt="image-20220727203928114"></p>
<p>然后生成代码</p>
<p>重新实现中断回调函数、编写按键检测程序</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220716170830949.png" alt="image-20220716170830949"></p>
<p>在gpio.c 中我们编写该函数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220727204139553.png" alt="image-20220727204139553"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">HAL_GPIO_EXTI_Callback</span><span class="params">(<span class="type">uint16_t</span> GPIO_Pin)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(GPIO_Pin == KEY1_Pin)&#123;<span class="comment">//判断一下那个引脚触发中断</span></span><br><span class="line">	<span class="comment">//这里编写触发中断后要执行的程序</span></span><br><span class="line">	HAL_GPIO_TogglePin(LED_GPIO_Port,LED_Pin);<span class="comment">//切换LED GPIO状态</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(GPIO_Pin == KEY2_Pin)&#123;<span class="comment">//判断一下那个引脚触发中断</span></span><br><span class="line">	<span class="comment">//这里编写触发中断后要执行的程序</span></span><br><span class="line">	HAL_GPIO_TogglePin(LED_GPIO_Port,LED_Pin);<span class="comment">//切换LED GPIO状态</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>把main中控制闪烁注释掉</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220727204442003.png" alt="image-20220727204442003"></p>
<p>烧录后的现象</p>
<p>按下KEY1 或者KEY2可以切换LED灯开关状态</p>
<h1 id="第三章-OLED使用"><a href="#第三章-OLED使用" class="headerlink" title="第三章-OLED使用"></a>第三章-OLED使用</h1><h2 id="3-1-资料准备"><a href="#3-1-资料准备" class="headerlink" title="3.1-资料准备"></a>3.1-资料准备</h2><p>我们先去下载这个OLED模块的资料</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220727205105383.png" alt="image-20220727205105383" style="zoom:33%;" /></p>
<p>这里我们下载:<strong>优信电子—0.96寸 OLED显示液晶屏模块 IIC液晶屏  四引脚</strong></p>
<p>淘宝链接:</p>
<p><a target="_blank" rel="noopener" href="https://item.taobao.com/item.htm?spm=a230r.1.14.16.504611e6WA3Clv&amp;id=562145367495&amp;ns=1&amp;abbucket=3#detail">https://item.taobao.com/item.htm?spm=a230r.1.14.16.504611e6WA3Clv&amp;id=562145367495&amp;ns=1&amp;abbucket=3#detail</a></p>
<p>OLED资料链接:</p>
<p><strong>0.96寸（4管脚）资料下载链接：</strong></p>
<p><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1J57Izsv-PKmbwVrA2ynDzg">https://pan.baidu.com/s/1J57Izsv-PKmbwVrA2ynDzg</a>            提取码：vktz</p>
<p>找到我们要的历程—中景园电子0.96OLED显示屏_STM32F103C8_IIC_V1.0</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220727210815907.png" alt="image-20220727210815907"></p>
<h2 id="3-2-相关知识"><a href="#3-2-相关知识" class="headerlink" title="3.2-相关知识"></a>3.2-相关知识</h2><p>这个OLED是IIC协议，很多都是单片机模拟IIC和模块通信的，这个也是模拟IIC控制OLED的</p>
<p>我们先看一下这个历程</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220727210946103.png" alt="image-20220727210946103"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220727211027636.png" alt="image-20220727211027636"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220727211352797.png" alt="image-20220727211352797"></p>
<p>所谓我们移植的时候替换相关初始化内容和GPIO置为函数就行</p>
<h2 id="3-3-解决一些错误"><a href="#3-3-解决一些错误" class="headerlink" title="3.3-解决一些错误"></a>3.3-解决一些错误</h2><p>把OLED文件复制过去</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220727212108337.png" alt="image-20220727212108337"></p>
<p>添加组和包含文件</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220727213102694.png" alt="image-20220727213102694" style="zoom:33%;" /></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220727213054063.png" alt="image-20220727213054063" style="zoom: 33%;" /></p>
<p>选择添加路径</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220727213257813.png" alt="image-20220727213257813" style="zoom: 25%;" /></p>
<p>编译一下—找不到sys.h 删掉sys.h </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220727213408708.png" alt="image-20220727213408708" style="zoom: 25%;" /></p>
<p>编译一下—把所有的u8都替换成uint8_t u32 替换成uint32_t</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220727214626867.png" alt="image-20220727214626867"></p>
<p>编译报错 找不到uint8_t  包含一下#include “main.h”      解决</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220727214254871.png" alt="image-20220727214254871"></p>
<p>有警告 声明加上void</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220727214420870.png" alt="image-20220727214420870" style="zoom:25%;" /></p>
<p>下面是一些GPIO的错误，我要解决初始化问题了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220727214806261.png" alt="image-20220727214806261"></p>
<h2 id="3-4-开始初始化OLED"><a href="#3-4-开始初始化OLED" class="headerlink" title="3.4-开始初始化OLED"></a>3.4-开始初始化OLED</h2><p>先看原理图  <strong>SDA-PB12  SCL-PA15</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220727215225137.png" alt="image-20220727215225137" style="zoom:25%;" /></p>
<p>然后我们开始初始两个GPIO为输出模式—上拉输出模式</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220727224538128.png" alt="image-20220727224538128"></p>
<p>然后我们生成代码，更改一下IIC协议的GPIO设置，和初始化部分</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220727230824437.png" alt="image-20220727230824437"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> OLED_SCLK_Clr() HAL_GPIO_WritePin(OLED_SCL_GPIO_Port, OLED_SCL_Pin, GPIO_PIN_RESET)<span class="comment">//设置SCL低电平</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OLED_SCLK_Set() HAL_GPIO_WritePin(OLED_SCL_GPIO_Port, OLED_SCL_Pin, GPIO_PIN_SET)<span class="comment">//设置SCL高电平</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OLED_SDIN_Clr() HAL_GPIO_WritePin(OLED_SDA_GPIO_Port,OLED_SDA_Pin,GPIO_PIN_RESET)<span class="comment">//设置SDA低电平</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OLED_SDIN_Set() HAL_GPIO_WritePin(OLED_SDA_GPIO_Port,OLED_SDA_Pin,GPIO_PIN_SET)<span class="comment">//设置SDA高电平</span></span></span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220727231448989.png" alt="image-20220727231448989"></p>
<p>下面delay函数出现报错 我们替换成HAL_Delay</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220727231848062.png" alt="image-20220727231848062"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220727232059531.png" alt="image-20220727232059531"></p>
<p>编译没有报错了，我们在主函数添加初始化和测试代码</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220727233213431.png" alt="image-20220727233213431"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">OLED_Init();			<span class="comment">//初始化OLED  </span></span><br><span class="line">OLED_Clear(); </span><br><span class="line"></span><br><span class="line">		OLED_ShowCHinese(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);<span class="comment">//中</span></span><br><span class="line">OLED_ShowCHinese(<span class="number">18</span>,<span class="number">0</span>,<span class="number">1</span>);<span class="comment">//景</span></span><br><span class="line">OLED_ShowCHinese(<span class="number">36</span>,<span class="number">0</span>,<span class="number">2</span>);<span class="comment">//园</span></span><br><span class="line">OLED_ShowCHinese(<span class="number">54</span>,<span class="number">0</span>,<span class="number">3</span>);<span class="comment">//电</span></span><br><span class="line">OLED_ShowCHinese(<span class="number">72</span>,<span class="number">0</span>,<span class="number">4</span>);<span class="comment">//子</span></span><br><span class="line">OLED_ShowCHinese(<span class="number">90</span>,<span class="number">0</span>,<span class="number">5</span>);<span class="comment">//科</span></span><br><span class="line">OLED_ShowCHinese(<span class="number">108</span>,<span class="number">0</span>,<span class="number">6</span>);<span class="comment">//技</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>烧录下载 现象OLED屏幕显示-中景园电子科技</p>
<h1 id="第四章-串口实验-简单输出"><a href="#第四章-串口实验-简单输出" class="headerlink" title="第四章-串口实验(简单输出)"></a>第四章-串口实验(简单输出)</h1><p>这里我们先初始化串口一、实现数据输出。</p>
<h2 id="4-1-串口编写"><a href="#4-1-串口编写" class="headerlink" title="4.1-串口编写"></a>4.1-串口编写</h2><p>软件初始化</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220727234545569.png" alt="image-20220727234545569"></p>
<p>然后我们实现串口数据输出</p>
<p>方法一：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220728210913655.png" alt="image-20220728210913655"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint8_t</span> c_Data[] = <span class="string">&quot;串口输出测试:好家伙VCC\r\n&quot;</span>;</span><br><span class="line">HAL_UART_Transmit(&amp;huart1,c_Data,<span class="keyword">sizeof</span>(c_Data),<span class="number">0xFFFF</span>);</span><br><span class="line">HAL_Delay(<span class="number">1000</span>);</span><br></pre></td></tr></table></figure>
<p>方法二:实现printf函数</p>
<p>打开微库</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220728211333083.png" alt="image-20220728211333083"></p>
<p>重定向fputc</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220728211730782.png" alt="image-20220728211730782"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* @brief 重定向printf (重定向fputc)，</span></span><br><span class="line"><span class="comment">					使用时候记得勾选上魔法棒-&gt;Target-&gt;UseMicro LIB </span></span><br><span class="line"><span class="comment">					可能需要在C文件加typedef struct __FILE FILE;</span></span><br><span class="line"><span class="comment">					包含这个文件#include &quot;stdio.h&quot;</span></span><br><span class="line"><span class="comment">* @param </span></span><br><span class="line"><span class="comment">* @return </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fputc</span><span class="params">(<span class="type">int</span> ch,FILE *stream)</span></span><br><span class="line">&#123;</span><br><span class="line">	HAL_UART_Transmit(&amp;huart1,( <span class="type">uint8_t</span> *)&amp;ch,<span class="number">1</span>,<span class="number">0xFFFF</span>);</span><br><span class="line">	<span class="keyword">return</span> ch;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果有错误</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220728211515588.png" alt="image-20220728211515588"></p>
<p>在usart.c添加这个typedef struct __FILE FILE;</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220728211651598.png" alt="image-20220728211651598"></p>
<p>添加一下测试(记得包含”stdio.h”)</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220728213124409.png" alt="image-20220728213124409"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;printf:好家伙VCC测试\r\n&quot;</span>);</span><br></pre></td></tr></table></figure>
<h2 id="4-2-串口实验"><a href="#4-2-串口实验" class="headerlink" title="4.2-串口实验"></a>4.2-串口实验</h2><h3 id="接线图"><a href="#接线图" class="headerlink" title="接线图"></a>接线图</h3><p>先烧录好，再连接串口查看现象</p>
<p>连接串口 可以使用  USB转TTL如CH340模块 或者 用DAP的串口功能</p>
<p><strong>使用USB转TTL如CH340模块</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221229214107521.png" alt="image-20221229214107521"></p>
<p><strong>使用DAP</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221229214655460.png" alt="image-20221229214655460"></p>
<p>然后我们打开串口助手，选择串口端口和波特率，就可以看到输出</p>
<p>蓝牙模块使用 </p>
<p>蓝牙模式使用在后面章节讲解</p>
<h1 id="第五章-PWM控制电机"><a href="#第五章-PWM控制电机" class="headerlink" title="第五章-PWM控制电机"></a>第五章-PWM控制电机</h1><h2 id="5-1-认识PWM"><a href="#5-1-认识PWM" class="headerlink" title="5.1-认识PWM"></a>5.1-认识PWM</h2><p>参数如何描述PWM</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220729093044088.png" alt="image-20220729093044088" style="zoom:33%;" /></p>
<h2 id="5-2-PWM配置"><a href="#5-2-PWM配置" class="headerlink" title="5.2-PWM配置"></a>5.2-PWM配置</h2><p>根据我们小车原理图我们知道是 <strong>PA11和PA8</strong>两个引脚要设置为PWM输出</p>
<p>这里为什么小车原理图要这样设计那?</p>
<ol>
<li>根据A4950的使用要求</li>
<li>根据STM32F103C8T6的定时器复用功能重映射</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220729102313833.png" alt="image-20220729102313833" style="zoom:33%;" /></p>
<p>我们这先介绍原因:</p>
<p>原因1：介绍电机驱动后，我们会说明</p>
<p>原因2: 因为<strong>STM32中文参考手册</strong>介绍了，TIM1_CH1和TIM1_CH4可以复用功能重映射到PA8和PA11</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220729102920289.png" alt="image-20220729102920289" style="zoom:67%;" /></p>
<p>我们使用软件配置 <strong>PA11和PA8</strong>这里配置</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220729104029766.png" alt="image-20220729104029766" style="zoom:50%;" /></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220729105524572.png" alt="image-20220729105524572"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220729105741439.png" alt="image-20220729105741439"></p>
<p>然后我们生成代码</p>
<p>PWM输出的配置就已经完成了，但是不能输出产生PWM波，因为Cube在生成代码时，有很多外设初始化完后默认是关闭的，需要我们手动开启。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220729110142345.png" alt="image-20220729110142345" style="zoom:50%;" /></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HAL_TIM_PWM_Start(&amp;htim1,TIM_CHANNEL_1);<span class="comment">//开启定时器1 通道1 PWM输出</span></span><br><span class="line">HAL_TIM_PWM_Start(&amp;htim1,TIM_CHANNEL_4);<span class="comment">//开启定时器1 通道4 PWM输出</span></span><br></pre></td></tr></table></figure>
<p>我们软件仿真一下、查看PA11与PA8波形</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220729164150949.png" alt="image-20220729164150949"></p>
<p>那么频率就是 1/0.002 = 500HZ</p>
<p>这就是我们要设置的</p>
<p>我们可以使用这个宏来修改占空比</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__HAL_TIM_SET_COMPARE(&amp;htim1, TIM_CHANNEL_1, <span class="number">40</span>);</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220729170905026.png" alt="image-20220729170905026"></p>
<h2 id="5-3-PWM测试方法"><a href="#5-3-PWM测试方法" class="headerlink" title="5.3-PWM测试方法"></a>5.3-PWM测试方法</h2><p>上面我们生成了PWM下面我们测试一下</p>
<h3 id="KEIL软件仿真方法"><a href="#KEIL软件仿真方法" class="headerlink" title="KEIL软件仿真方法:"></a>KEIL软件仿真方法:</h3><p>软件模拟仿真不需要任何硬件-下面是官方介绍</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220729145446106.png" alt="image-20220729145446106"></p>
<p>选择软件仿真</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220729150059613.png" alt="image-20220729150059613"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DARMSTM.DLL</span><br><span class="line">-pSTM32F103C8</span><br></pre></td></tr></table></figure>
<p>设置时钟频率-板子外部晶振8Mhz 这里我们选择8Mhz</p>
<p>(新版的keil5里没有那个设置频率的功能)</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220729162145332.png" alt="image-20220729162145332"></p>
<p>开启仿真</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220729150321775.png" alt="image-20220729150321775"></p>
<p>打开逻辑分析仪器</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220729150442778.png" alt="image-20220729150442778"></p>
<p>添加要观察的引脚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220729151057941.png" alt="image-20220729151057941"></p>
<p>点击全速运行</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220729151216082.png" alt="image-20220729151216082"></p>
<h3 id="使用仿真器硬件仿真"><a href="#使用仿真器硬件仿真" class="headerlink" title="使用仿真器硬件仿真"></a>使用仿真器硬件仿真</h3><p>选择仿真器仿真-检测已经识别出芯片ID</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221203144038645.png" alt="image-20221203144038645"></p>
<p>一样的可以开启仿真</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220729162843082.png" alt="image-20220729162843082"></p>
<p>但是硬件仿真好像目前还不能使用过逻辑分析仪、但是硬件仿真是在硬件上跑的，可以向硬件输入数据或者由硬件输出数据、比如按键仿真的时候就可以使用硬件仿真。</p>
<h3 id="使用示波器工具测量波形-非重点"><a href="#使用示波器工具测量波形-非重点" class="headerlink" title="使用示波器工具测量波形(非重点)"></a>使用示波器工具测量波形(非重点)</h3><h1 id="第六章-电机驱动和PWM"><a href="#第六章-电机驱动和PWM" class="headerlink" title="第六章-电机驱动和PWM"></a>第六章-电机驱动和PWM</h1><h2 id="6-1-认识电机驱动"><a href="#6-1-认识电机驱动" class="headerlink" title="6.1-认识电机驱动"></a>6.1-认识电机驱动</h2><p>示波器、硬件仿真、软件仿真</p>
<p>项目使用电机驱动芯片为A4950、下面是电机驱动的相关介绍</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220728215212236.png" alt="image-20220728215212236" style="zoom: 50%;" /></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220728215543547.png" alt="image-20220728215543547" style="zoom:50%;" /></p>
<p>我们按照这种使用方法</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220728215220067.png" alt="image-20220728215220067" style="zoom: 50%;" /></p>
<p>这我们使用一个图介绍</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220730173302397.png" alt="image-20220730173302397"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230101164812094.png" alt="image-20230101164812094"></p>
<h2 id="6-2-使用电机驱动-独立工程"><a href="#6-2-使用电机驱动-独立工程" class="headerlink" title="6.2-使用电机驱动(独立工程)"></a>6.2-使用电机驱动(独立工程)</h2><h3 id="分析和编写代码"><a href="#分析和编写代码" class="headerlink" title="分析和编写代码"></a>分析和编写代码</h3><p>综合电机使用方法、C8T6单片机硬件资源、小车原理图我们要进行如下配置</p>
<p><strong>PA11-TIM1_CH4 定时器PWM输出-PWMA 前面已经完成</strong></p>
<p><strong>PB13-GPIO输出-AIN1</strong></p>
<p><strong>PA8-TIM1_CH1 定时器PWM输出-PWMB  前面已经完成</strong></p>
<p><strong>PB3-GPIO输出-BIN1</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220730165128928.png" alt="image-20220730165128928" style="zoom:50%;" /></p>
<p>还有两个管脚没有初始化</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220730175458784.png" alt="image-20220730175458784"></p>
<p>生成代码</p>
<p>开始添加控制电机正反转与速度的代码，进行仿真和电机测试，示波器测量</p>
<p>添加AIN1、BIN1控制代码</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220806092857784.png" alt="image-20220806092857784"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HAL_GPIO_WritePin(AIN1_GPIO_Port,AIN1_Pin,GPIO_PIN_RESET);<span class="comment">//设置AIN1 PB13为 低电平</span></span><br><span class="line">HAL_GPIO_WritePin(BIN1_GPIO_Port,BIN1_Pin,GPIO_PIN_SET);  <span class="comment">//设置BIN1 PB3为高电平</span></span><br><span class="line">HAL_Delay(<span class="number">1000</span>);</span><br><span class="line"><span class="comment">//两次会使得电机反向。</span></span><br><span class="line">HAL_GPIO_WritePin(AIN1_GPIO_Port,AIN1_Pin,GPIO_PIN_SET);<span class="comment">//设置AIN1 PB13为 高电平</span></span><br><span class="line">HAL_GPIO_WritePin(BIN1_GPIO_Port,BIN1_Pin,GPIO_PIN_RESET);  <span class="comment">//设置BIN1 PB3为低电平</span></span><br></pre></td></tr></table></figure>
<h3 id="仿真测试代码"><a href="#仿真测试代码" class="headerlink" title="仿真测试代码"></a>仿真测试代码</h3><p>使用软件仿真</p>
<p>检测是否软件仿真设置正确</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220730192214904.png" alt="image-20220730192214904"></p>
<p>开启仿真-添加PB13和PB3到逻辑分析仪</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220730192626969.png" alt="image-20220730192626969"></p>
<p>全速仿真运行</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220731185432931.png" alt="image-20220731185432931"></p>
<h3 id="实物测试代码"><a href="#实物测试代码" class="headerlink" title="实物测试代码"></a>实物测试代码</h3><p>如何让电机90%电压转速 旋转</p>
<p>烧录代码</p>
<h2 id="6-3-编写电机转速开环控制函数-另外复制工程"><a href="#6-3-编写电机转速开环控制函数-另外复制工程" class="headerlink" title="6.3-编写电机转速开环控制函数(另外复制工程)"></a>6.3-编写电机转速开环控制函数(另外复制工程)</h2><p>新建motor文件</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220806094030498.png" alt="image-20220806094030498"></p>
<p>包含文件并添加编译</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220806094635879.png" alt="image-20220806094635879"></p>
<p>为了方便移植和使用，我们GPIO电平控制写成宏</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230101150840270.png" alt="image-20230101150840270"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> AIN1_RESET  HAL_GPIO_WritePin(AIN1_GPIO_Port,AIN1_Pin,GPIO_PIN_RESET)<span class="comment">//设置AIN1 PB13为 低电平</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AIN1_SET    HAL_GPIO_WritePin(AIN1_GPIO_Port,AIN1_Pin,GPIO_PIN_SET)<span class="comment">//设置AIN1 PB13为 高电平</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BIN1_RESET 	HAL_GPIO_WritePin(BIN1_GPIO_Port,BIN1_Pin,GPIO_PIN_RESET)  <span class="comment">//设置BIN1 PB3为低电平</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BIN1_SET    HAL_GPIO_WritePin(BIN1_GPIO_Port,BIN1_Pin,GPIO_PIN_SET)<span class="comment">//设置AIN1 PB13为 高电平</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>下面我们编写小车电机方向和速度控制</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*******************</span></span><br><span class="line"><span class="comment">*  @brief  设置两个电机转速和方向</span></span><br><span class="line"><span class="comment">*  @param  motor1:电机B设置参数、motor2:设置参数</span></span><br><span class="line"><span class="comment">*  @param  motor1: 输入1~100 对应控制B电机正方向速度在1%-100%、输入-1~-100 对应控制B电机反方向速度在1%-100%、motor2同理</span></span><br><span class="line"><span class="comment">*  @return  无</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">*******************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Motor_Set</span> <span class="params">(<span class="type">int</span> motor1,<span class="type">int</span> motor2)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//根据参数正负 设置选择方向</span></span><br><span class="line">	<span class="keyword">if</span>(motor1 &lt; <span class="number">0</span>) BIN1_SET;</span><br><span class="line">	   <span class="keyword">else</span>      BIN1_RESET;</span><br><span class="line">	<span class="keyword">if</span>(motor2 &lt; <span class="number">0</span>) AIN1_SET;</span><br><span class="line">		<span class="keyword">else</span>      AIN1_RESET;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//motor1 设置电机B的转速</span></span><br><span class="line">	<span class="keyword">if</span>(motor1 &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(motor1 &lt; <span class="number">-99</span>) motor1 = <span class="number">-99</span>;<span class="comment">//超过PWM幅值</span></span><br><span class="line">		<span class="comment">//负的时候绝对值越小  PWM占空比越大</span></span><br><span class="line">		<span class="comment">//现在的motor1      -1   -99</span></span><br><span class="line">		<span class="comment">//给寄存器或者函数  99  1 </span></span><br><span class="line">		 __HAL_TIM_SET_COMPARE(&amp;htim1, TIM_CHANNEL_1, (<span class="number">100</span>+motor1));<span class="comment">//修改定时器1 通道1 PA8 Pulse改变占空比</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(motor1 &gt; <span class="number">99</span>) motor1 = <span class="number">99</span>;</span><br><span class="line">		<span class="comment">//现在是   0 1  99</span></span><br><span class="line">		<span class="comment">//我们赋值 0 1 99</span></span><br><span class="line">		 __HAL_TIM_SET_COMPARE(&amp;htim1, TIM_CHANNEL_1, motor1);<span class="comment">//修改定时器1 通道1 PA8 Pulse改变占空比</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//motor2 设置电机A的转速</span></span><br><span class="line">	<span class="keyword">if</span>(motor2 &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(motor2 &lt; <span class="number">-99</span>) motor2 = <span class="number">-99</span>;<span class="comment">//超过PWM幅值</span></span><br><span class="line">		<span class="comment">//负的时候绝对值越小  PWM占空比越大</span></span><br><span class="line">		<span class="comment">//现在的motor2      -1   -99</span></span><br><span class="line">		<span class="comment">//给寄存器或者函数   99  1 </span></span><br><span class="line">		__HAL_TIM_SET_COMPARE(&amp;htim1, TIM_CHANNEL_4, (<span class="number">100</span>+motor2));<span class="comment">//修改定时器1 通道4 PA11 Pulse改变占空比</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(motor2 &gt; <span class="number">99</span>) motor2 = <span class="number">99</span>;</span><br><span class="line">		<span class="comment">//现在是   0 1 99</span></span><br><span class="line">		<span class="comment">//我们赋值 0 1 99</span></span><br><span class="line">		 __HAL_TIM_SET_COMPARE(&amp;htim1, TIM_CHANNEL_4, motor2);<span class="comment">//修改定时器1 通道4 PA11 Pulse改变占空比</span></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<p>然后我们连接电机主函数进行测试</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HAL_Delay(<span class="number">500</span>);</span><br><span class="line">Motor_Set(<span class="number">0</span>,<span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<h1 id="第七章-编码器测速"><a href="#第七章-编码器测速" class="headerlink" title="第七章-编码器测速"></a>第七章-编码器测速</h1><h2 id="7-1-认识编码器"><a href="#7-1-认识编码器" class="headerlink" title="7.1-认识编码器"></a>7.1-认识编码器</h2><p>编码器:一般按照电机尾部、用于测量电机转速、方向、位置。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230102003312991.png" alt="image-20230102003312991"></p>
<p>那么编码器的输出信号具体是什么？我们如何根据输出信号测量转速 和方向？</p>
<p>转速:  单位时间测量到的脉冲数量(比如根据每秒测量到多少个脉冲来计算转速)</p>
<p>旋转方向: 两通道信号的相对电平关系</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220806200542121.png" alt="image-20220806200542121" style="zoom: 67%;" /></p>
<h2 id="7-2单片机定时器的编码器功能"><a href="#7-2单片机定时器的编码器功能" class="headerlink" title="7.2单片机定时器的编码器功能"></a>7.2单片机定时器的编码器功能</h2><p>那么我们已经知道编码器输出的波形，我们如何通过单片机读取波形，然后计算出速度那?</p>
<p>这里STM32单片机的定时器和通用定时器具有<strong>编码器接口模式</strong>、在STM32中文参考手册13章中有详细介绍</p>
<p>STM32中文参考手册-第200页</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220806225827403.png" alt="image-20220806225827403" style="zoom:50%;" /></p>
<p>STM32中文参考手册-第267页</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220807104608031.png" alt="image-20220807104608031"></p>
<p>STM32中文参考手册-第226页</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220806222325272.png" alt="image-20220806222325272" style="zoom:67%;" /></p>
<p>这个是计数方向与编码器信号的关系、我们拆开来看</p>
<p>仅在TI1计数、电机正转、对原始数据二倍频</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220806222556492.png" alt="image-20220806222556492" style="zoom:67%;" /></p>
<p>仅在TI1计数、电机反转、对原始数据二倍频</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220806222737004.png" alt="image-20220806222737004" style="zoom:67%;" /></p>
<p>在TI1和TI2都计数</p>
<p>可以看到这样就对原始数据四倍频了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220806222848485.png" alt="image-20220806222848485" style="zoom:50%;" /></p>
<p>计数方向</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220809144105548.png" alt="image-20220809144105548" style="zoom: 67%;" /></p>
<h2 id="7-3-获得单位时间计数器值变化量"><a href="#7-3-获得单位时间计数器值变化量" class="headerlink" title="7.3-获得单位时间计数器值变化量"></a>7.3-获得单位时间计数器值变化量</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230103004459822.png" alt="image-20230103004459822"></p>
<p><strong>上一次说的方法：</strong></p>
<p>这次编码器计数值 = 计数器值+计数溢出次数 * 计数最大器计数最大值</p>
<p>计数器两次变化值 = 这次编码器计数值 - 上次编码器计数值</p>
<p>然后根据这个单位变化量计算速度</p>
<p><strong>还有一种方法：</strong></p>
<p>计数器变化量 = 当前计数器值</p>
<p>每次计数值清空</p>
<p>然后根据这个变化量 计算速度</p>
<p>然后我们再看具体到哪一款电机和编码器上如何测速</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230102161121087.png" alt="image-20230102161121087"></p>
<p>在STM32中文参考手册-第119页</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220807110602314.png" alt="image-20220807110602314"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230102235948243.png" alt="image-20230102235948243"></p>
<p>设置TIM2</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220807112130804.png" alt="image-20220807112130804"></p>
<p>设置ITM2滤波器</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220807112239092.png" alt="image-20220807112239092"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220807153021728.png" alt="image-20220807153021728"></p>
<p>同理设置TIM4</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220807112807336.png" alt="image-20220807112807336"></p>
<p>设置TIM4滤波器</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220807112858479.png" alt="image-20220807112858479"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220807153047276.png" alt="image-20220807153047276"></p>
<p>设置引脚上拉</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220807154059362.png" alt="image-20220807154059362"></p>
<p>生成代码</p>
<p>开启定时器和定时中断</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220807162341446.png" alt="image-20220807162341446"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HAL_TIM_Encoder_Start(&amp;htim2,TIM_CHANNEL_ALL);<span class="comment">//开启定时器2</span></span><br><span class="line">HAL_TIM_Encoder_Start(&amp;htim4,TIM_CHANNEL_ALL);<span class="comment">//开启定时器4</span></span><br><span class="line">HAL_TIM_Base_Start_IT(&amp;htim2);				<span class="comment">//开启定时器2 中断</span></span><br><span class="line">HAL_TIM_Base_Start_IT(&amp;htim4);                <span class="comment">//开启定时器4 中断</span></span><br></pre></td></tr></table></figure>
<p>在定义两个变量保存计数器值</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230102225054673.png" alt="image-20230102225054673"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">short</span> Encoder1Count = <span class="number">0</span>;<span class="comment">//编码器计数器值</span></span><br><span class="line"><span class="type">short</span> Encoder2Count = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>每2ms读取计数器值-&gt;清零计数器</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230102231545491.png" alt="image-20230102231545491"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Motor_Set(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line"><span class="comment">//1.保存计数器值</span></span><br><span class="line">Encoder1Count =(<span class="type">short</span>)__HAL_TIM_GET_COUNTER(&amp;htim4);</span><br><span class="line">Encoder2Count =(<span class="type">short</span>)__HAL_TIM_GET_COUNTER(&amp;htim2);</span><br><span class="line"><span class="comment">//2.清零计数器值</span></span><br><span class="line">__HAL_TIM_SET_COUNTER(&amp;htim4,<span class="number">0</span>);</span><br><span class="line">__HAL_TIM_SET_COUNTER(&amp;htim2,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Encoder1Count:%d\r\n&quot;</span>,Encoder1Count);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Encoder2Count:%d\r\n&quot;</span>,Encoder2Count);	</span><br><span class="line"></span><br><span class="line">HAL_Delay(<span class="number">2</span>);</span><br></pre></td></tr></table></figure>
<p>接好电池、烧录代码、串口一连接电脑</p>
<p>用手转动电机1或者电机2 、串口助手可以看到输出信息了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230102232135472.png" alt="image-20230102232135472"></p>
<h2 id="7-4-主函数周期测量转速"><a href="#7-4-主函数周期测量转速" class="headerlink" title="7.4-主函数周期测量转速"></a>7.4-主函数周期测量转速</h2><p>上面我们测量出来了溢出值，我们再根据当前计数器值就可以测量出计数器变化量，我们通过单位时间变量就可以计算出转速</p>
<p>下面是电机和编码器的参数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230102161121087.png" alt="image-20230102161121087"></p>
<p>我们先测试的结论是否有问题？</p>
<ol>
<li>编码器计数器会不会在计数时间内溢出？</li>
<li>车轮旋转一周，单片机编码器计数器计数多少？9.6乘11乘4</li>
<li>根据计算方法计算电机转速</li>
</ol>
<p>定义两个float变量</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230103140008234.png" alt="image-20230103140008234"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span> Motor1Speed = <span class="number">0.00</span>;</span><br><span class="line"><span class="type">float</span> Motor2Speed = <span class="number">0.00</span>;</span><br></pre></td></tr></table></figure>
<p>下面是代码(一定要把主函数没有用的删除掉)</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230103140050045.png" alt="image-20230103140050045"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//计算速度</span></span><br><span class="line">Motor1Speed = (<span class="type">float</span>)Encode1Count*<span class="number">100</span>/<span class="number">9.6</span>/<span class="number">11</span>/<span class="number">4</span>;</span><br><span class="line">Motor2Speed = (<span class="type">float</span>)Encode2Count*<span class="number">100</span>/<span class="number">9.6</span>/<span class="number">11</span>/<span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Motor1Speed:%.2f\r\n&quot;</span>,Motor1Speed);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Motor2Speed:%.2f\r\n&quot;</span>,Motor2Speed);</span><br></pre></td></tr></table></figure>
<p>编译烧录代码就会输出结果</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230103140447001.png" alt="image-20230103140447001"></p>
<h2 id="7-5-定时器中断定时测量速度"><a href="#7-5-定时器中断定时测量速度" class="headerlink" title="7.5-定时器中断定时测量速度"></a>7.5-定时器中断定时测量速度</h2><p>上面我们实现:在主函数周期，读取计数器值然后计算速度，但是如果函数加入其他内容这个周期时间就很难保证。</p>
<p>所以这节我们通过定时器，周期读取计数器，计算速度。复制一份工程开始搞!</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230103153710421.png" alt="image-20230103153710421"></p>
<p>我们先开启定时器、2ms进入一次定时器中断，中断回调函数执行咱们的代码即可。</p>
<p>为什么充分利用单片机 我们使用TIM1</p>
<ol>
<li>设置内部时钟源</li>
<li>使能自动重装载</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220809161601774.png" alt="image-20220809161601774"></p>
<p>开启定义更新中断</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220809161647624.png" alt="image-20220809161647624"></p>
<p>代码开启定时器1 中断</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220809162038626.png" alt="image-20220809162038626"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HAL_TIM_Base_Start_IT(&amp;htim1);                <span class="comment">//开启定时器1 中断</span></span><br></pre></td></tr></table></figure>
<p>定时器回调函数中添加 速度计算内容</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230103151934131.png" alt="image-20230103151934131"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*******************</span></span><br><span class="line"><span class="comment">*  @brief  定时器回调函数</span></span><br><span class="line"><span class="comment">*  @param  </span></span><br><span class="line"><span class="comment">*  @return  </span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">*******************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">HAL_TIM_PeriodElapsedCallback</span><span class="params">(TIM_HandleTypeDef *htim)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(htim == &amp;htim1)<span class="comment">//htim1 500HZ  2ms 中断一次</span></span><br><span class="line">	&#123;</span><br><span class="line">		TimerCount++;</span><br><span class="line">		<span class="keyword">if</span>(TimerCount %<span class="number">5</span> == <span class="number">0</span>)<span class="comment">//每10ms执行一次</span></span><br><span class="line">		&#123;</span><br><span class="line">			Encode1Count = (<span class="type">short</span>)__HAL_TIM_GET_COUNTER(&amp;htim4);</span><br><span class="line">			Encode2Count = (<span class="type">short</span>)__HAL_TIM_GET_COUNTER(&amp;htim2);</span><br><span class="line">			__HAL_TIM_SET_COUNTER(&amp;htim4,<span class="number">0</span>);</span><br><span class="line">			__HAL_TIM_SET_COUNTER(&amp;htim2,<span class="number">0</span>);</span><br><span class="line">			</span><br><span class="line">			Motor1Speed = (<span class="type">float</span>)Encode1Count*<span class="number">100</span>/<span class="number">9.6</span>/<span class="number">11</span>/<span class="number">4</span>;</span><br><span class="line">			Motor2Speed = (<span class="type">float</span>)Encode2Count*<span class="number">100</span>/<span class="number">9.6</span>/<span class="number">11</span>/<span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">			TimerCount=<span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>把之前的变量定义放这里</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230103152057663.png" alt="image-20230103152057663"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">short</span> Encode1Count = <span class="number">0</span>;</span><br><span class="line"><span class="type">short</span> Encode2Count = <span class="number">0</span>;</span><br><span class="line"><span class="type">float</span> Motor1Speed = <span class="number">0.00</span>;</span><br><span class="line"><span class="type">float</span> Motor2Speed = <span class="number">0.00</span>;</span><br><span class="line"><span class="type">uint16_t</span> TimerCount=<span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>主函数就输出速度大小就可以了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230103152344746.png" alt="image-20230103152344746"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Motor1Speed:%.2f\r\n&quot;</span>,Motor1Speed);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Motor2Speed:%.2f\r\n&quot;</span>,Motor2Speed);</span><br></pre></td></tr></table></figure>
<p>把变量需要声明一下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230103152521123.png" alt="image-20230103152521123"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">float</span> Motor1Speed ;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">float</span> Motor2Speed ;</span><br></pre></td></tr></table></figure>
<p>然后打开串口助手</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230103152735931.png" alt="image-20230103152735931"></p>
<p>注:</p>
<p>根据电机和实际小车调整速度测量与占空比设置函数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230103160108176.png" alt="image-20230103160108176"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230103160133008.png" alt="image-20230103160133008"></p>
<h1 id="第八章-PID-速度控制"><a href="#第八章-PID-速度控制" class="headerlink" title="第八章-PID-速度控制"></a>第八章-PID-速度控制</h1><h2 id="8-1-速度控制探索"><a href="#8-1-速度控制探索" class="headerlink" title="8.1-速度控制探索"></a>8.1-速度控制探索</h2><p>前面我们已经能够通过编码器测量出速度值，下面我们来控制速度</p>
<p>我们先编写一个简单的控制方法</p>
<p>要求：讲转速控制再2.9-3.1转每秒</p>
<p>可以把中断里面不重要的输出注释掉</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230103163851923.png" alt="image-20230103163851923"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(Motor1Speed&gt;<span class="number">3.1</span>) Motor1Pwm--;</span><br><span class="line"><span class="keyword">if</span>(Motor1Speed&lt;<span class="number">2.9</span>) Motor1Pwm++;</span><br><span class="line"><span class="keyword">if</span>(Motor2Speed&gt;<span class="number">3.1</span>) Motor2Pwm--;</span><br><span class="line"><span class="keyword">if</span>(Motor2Speed&lt;<span class="number">2.9</span>) Motor2Pwm++;</span><br><span class="line">Motor_Set(Motor1Pwm,Motor2Pwm);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Motor1Speed:%.2f Motor1Pwm:%d\r\n&quot;</span>,Motor1Speed,Motor1Pwm);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Motor2Speed:%.2f Motor2Pwm:%d\r\n&quot;</span>,Motor2Speed,Motor2Pwm);</span><br><span class="line"></span><br><span class="line">HAL_Delay(<span class="number">100</span>);</span><br></pre></td></tr></table></figure>
<p>开始实验</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230103164021564.png" alt="image-20230103164021564"></p>
<p>现象就开始电机没有到达3转每秒，PWM占空比逐渐增大，电机<strong>逐渐</strong>达到要求转速、到达要求转速后我们增加阻力，电机<strong>变慢</strong>，阻力大小不边PWM占空比逐渐更大转速<strong>逐渐更大</strong>。</p>
<p>这样我们就把转速控制到我们想要的范围，但是我们并不满意、能够看出来控制的速度很慢，给电机一些阻力电机至少要2-3秒能够调整过来，这在一些场景是不允许的。</p>
<p>我们理想的控制效果是：在电机转速很慢的是时候能快速调整，在电机一直转的不能达到要求时候能够更快速度调整</p>
<h2 id="8-2-准备工作-匿名上位机曲线显示速度波形方便观察数据"><a href="#8-2-准备工作-匿名上位机曲线显示速度波形方便观察数据" class="headerlink" title="8.2-准备工作-匿名上位机曲线显示速度波形方便观察数据"></a>8.2-准备工作-匿名上位机曲线显示速度波形方便观察数据</h2><p>为了方便观察电机速度数据，我们通过上位机曲线显示一下。</p>
<p>这里我们使用的上位机是匿名上位机-大佬写的非常稳定功能也很多</p>
<p>我使用的版本是:<strong>匿名上位机V7.2.2.8版本</strong>推荐大家和我使用一样</p>
<p>匿名上位机官方下载链接:<a target="_blank" rel="noopener" href="http://www.anotc.com/wiki/%E5%8C%BF%E5%90%8D%E4%BA%A7%E5%93%81%E8%B5%84%E6%96%99/%E8%B5%84%E6%96%99%E4%B8%8B%E8%BD%BD%E9%93%BE%E6%8E%A5%E6%B1%87%E6%80%BB">http://www.anotc.com/wiki/%E5%8C%BF%E5%90%8D%E4%BA%A7%E5%93%81%E8%B5%84%E6%96%99/%E8%B5%84%E6%96%99%E4%B8%8B%E8%BD%BD%E9%93%BE%E6%8E%A5%E6%B1%87%E6%80%BB</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220818223304266.png" alt="image-20220818223304266" style="zoom: 25%;" /></p>
<p>我们要把STM32数据发送到匿名上位机，就要满足匿名上位机的数据协议要求</p>
<p>在匿名上位机资料下载链接，可以下载到协议介绍</p>
<ul>
<li>匿名上位机V7通信协议，20210528发布：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1nGrIGWj6qr9DWOcGpKR51g">https://pan.baidu.com/s/1nGrIGWj6qr9DWOcGpKR51g</a> 提取码：z8d1</li>
<li>CSDN <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_44339029">慕羽★</a>大佬写的协议解析教程博客:<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_44339029/article/details/106004997">https://blog.csdn.net/qq_44339029/article/details/106004997</a></li>
</ul>
<p><strong>1.先补充一下大小端模式</strong></p>
<p>这是因为在计算机系统中，我们是以字节为单位的，每个地址单元都对应着一个字节，一个字节为 8bit。但是在C语言中除了8bit的char之外，还有16bit的short型，32bit的long型（要看具体的编译器），另外，对于位数大于8位的处理器，例如16位或者32位的处理器，由于寄存器宽度大于一个字节，那么<strong>必然存在着一个如和将多个字节安排的问题</strong>。因此就导致了大端存储模式和小端存储模式。例如一个16bit的short型x，在内存中的地址为0x0010，x的值为0x1122，那么0x11为高字节，0x22为低字节。对于大端模式，就将0x11放在低地址中，即0x0010中，0x22放在高地址中，即0x0011中。</p>
<ul>
<li><p><strong>所谓的大端模式（BE big-endian），是指数据的低位保存在内存的高地址中，而数据的高位，保存在内存的低地址中（低对高，高对低）；</strong></p>
</li>
<li><p><strong>所谓的小端模式（LE little-endian），是指数据的低位保存在内存的低地址中，而数据的高位保存在内存的高地址中（低对低，高对高）。</strong></p>
<h5 id="常见的单片机大小端模式：（1）KEIL-C51中，变量都是大端模式的，而KEIL-MDK中，变量是小端模式的。（2）SDCC-C51是小端寻址，AVRGCC-小端寻址-（3）PC小端，大部分ARM是小端-（4）总起来说51单片机一般是大端模式，32单片机一般是小端模式"><a href="#常见的单片机大小端模式：（1）KEIL-C51中，变量都是大端模式的，而KEIL-MDK中，变量是小端模式的。（2）SDCC-C51是小端寻址，AVRGCC-小端寻址-（3）PC小端，大部分ARM是小端-（4）总起来说51单片机一般是大端模式，32单片机一般是小端模式" class="headerlink" title="常见的单片机大小端模式：（1）KEIL C51中，变量都是大端模式的，而KEIL MDK中，变量是小端模式的。（2）SDCC-C51是小端寻址，AVRGCC 小端寻址.（3）PC小端，大部分ARM是小端 （4）总起来说51单片机一般是大端模式，32单片机一般是小端模式."></a>常见的<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=单片机&amp;spm=1001.2101.3001.7020">单片机</a>大小端模式：（1）KEIL C51中，变量都是大端模式的，而KEIL MDK中，变量是小端模式的。（2）SDCC-C51是小端寻址，AVRGCC 小端寻址.（3）PC小端，大部分ARM是小端 （4）总起来说51单片机一般是大端模式，32单片机一般是小端模式.</h5></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230103211719535.png" alt="image-20230103211719535"></p>
<p><strong>2.看一下上位机要求的协议</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220818230815447.png" alt="image-20220818230815447" style="zoom: 50%;" /></p>
<p>灵活格式帧(用户自定义帧)</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220818231041314.png" alt="image-20220818231041314" style="zoom:50%;" /></p>
<p>前面我们好理解</p>
<p>0xAA:一个字节表示开始</p>
<p>0xFF:一个字节表示目标地址</p>
<p>0xF1:一个字节表示发送功能码</p>
<p>1-40：一个字节表示数据长度</p>
<p>数据内容有多个字节如何发送</p>
<p><strong>因为串口每次发送一个字节，但是数据可能是int16_t 16位的数据，或者int32_t 32位数据，每次发送16位数据,先发送数据低八位，还是先发送数据高八位那?</strong></p>
<p>匿名协议通信介绍给出：<strong>DATA 数据内容中的数据，采用小端模式传送，低字节在前，高字节在后。</strong></p>
<p>那么就要求，比如我们在发送16位数据0x2314我们要先发送低字节0x14,然后发送高字节0x23</p>
<p>那么如何解析出低字节或者高字节，就需要知道多字节数据在单片机里面是怎么存的，因为STM32是小端存储，所以低字节就在低位地址中，高字节高位地址中。</p>
<p>如果使用32单片机 小端模式，0x23高地址，0x14在低地址，所以我们要先发低地址，再发高地址。</p>
<p>下面就是对16位数据，或者32位数据的拆分</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//需要发送16位,32位数据，对数据拆分，之后每次发送单个字节</span></span><br><span class="line"><span class="comment">//拆分过程：对变量dwTemp 去地址然后将其转化成char类型指针，最后再取出指针所指向的内容</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BYTE0(dwTemp)  (*(char *)(&amp;dwTemp))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BYTE1(dwTemp)  (*((char *)(&amp;dwTemp) + 1))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BYTE2(dwTemp)  (*((char *)(&amp;dwTemp) + 2))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BYTE3(dwTemp)  (*((char *)(&amp;dwTemp) + 3))</span></span><br></pre></td></tr></table></figure>
<p>拆分后我们按照协议要求发送数据就可以了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220819104451257.png" alt="image-20220819104451257"></p>
<p>niming.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;niming.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;main.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;usart.h&quot;</span></span></span><br><span class="line"><span class="type">uint8_t</span> data_to_send[<span class="number">100</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过F1帧发送4个uint16类型的数据</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ANO_DT_Send_F1</span><span class="params">(<span class="type">uint16_t</span> _a, <span class="type">uint16_t</span> _b, <span class="type">uint16_t</span> _c, <span class="type">uint16_t</span> _d)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> _cnt = <span class="number">0</span>;		<span class="comment">//计数值</span></span><br><span class="line">    <span class="type">uint8_t</span> sumcheck = <span class="number">0</span>;  <span class="comment">//和校验</span></span><br><span class="line">    <span class="type">uint8_t</span> addcheck = <span class="number">0</span>; <span class="comment">//附加和校验</span></span><br><span class="line">    <span class="type">uint8_t</span> i = <span class="number">0</span>;</span><br><span class="line">	data_to_send[_cnt++] = <span class="number">0xAA</span>;<span class="comment">//帧头</span></span><br><span class="line">    data_to_send[_cnt++] = <span class="number">0xFF</span>;<span class="comment">//目标地址</span></span><br><span class="line">    data_to_send[_cnt++] = <span class="number">0xF1</span>;<span class="comment">//功能码</span></span><br><span class="line">    data_to_send[_cnt++] = <span class="number">8</span>; <span class="comment">//数据长度</span></span><br><span class="line">	<span class="comment">//单片机为小端模式-低地址存放低位数据，匿名上位机要求先发低位数据，所以先发低地址</span></span><br><span class="line">	data_to_send[_cnt++] = BYTE0(_a);       </span><br><span class="line">    data_to_send[_cnt++] = BYTE1(_a);</span><br><span class="line">	</span><br><span class="line">    data_to_send[_cnt++] = BYTE0(_b);</span><br><span class="line">    data_to_send[_cnt++] = BYTE1(_b);</span><br><span class="line">	</span><br><span class="line">    data_to_send[_cnt++] = BYTE0(_c);</span><br><span class="line">    data_to_send[_cnt++] = BYTE1(_c);</span><br><span class="line">	</span><br><span class="line">    data_to_send[_cnt++] = BYTE0(_d);</span><br><span class="line">    data_to_send[_cnt++] = BYTE1(_d);</span><br><span class="line">	 <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; data_to_send[<span class="number">3</span>]+<span class="number">4</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        sumcheck += data_to_send[i];<span class="comment">//和校验</span></span><br><span class="line">        addcheck += sumcheck;<span class="comment">//附加校验</span></span><br><span class="line">    &#125;</span><br><span class="line">    data_to_send[_cnt++] = sumcheck;</span><br><span class="line">    data_to_send[_cnt++] = addcheck;</span><br><span class="line">	HAL_UART_Transmit(&amp;huart1,data_to_send,_cnt,<span class="number">0xFFFF</span>);<span class="comment">//这里是串口发送函数</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//，通过F2帧发送4个int16类型的数据</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ANO_DT_Send_F2</span><span class="params">(<span class="type">int16_t</span> _a, <span class="type">int16_t</span> _b, <span class="type">int16_t</span> _c, <span class="type">int16_t</span> _d)</span>   <span class="comment">//F2帧  4个  int16 参数</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> _cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="type">uint8_t</span> sumcheck = <span class="number">0</span>; <span class="comment">//和校验</span></span><br><span class="line">    <span class="type">uint8_t</span> addcheck = <span class="number">0</span>; <span class="comment">//附加和校验</span></span><br><span class="line">    <span class="type">uint8_t</span> i=<span class="number">0</span>;</span><br><span class="line">   data_to_send[_cnt++] = <span class="number">0xAA</span>;</span><br><span class="line">    data_to_send[_cnt++] = <span class="number">0xFF</span>;</span><br><span class="line">    data_to_send[_cnt++] = <span class="number">0xF2</span>;</span><br><span class="line">    data_to_send[_cnt++] = <span class="number">8</span>; <span class="comment">//数据长度</span></span><br><span class="line">	<span class="comment">//单片机为小端模式-低地址存放低位数据，匿名上位机要求先发低位数据，所以先发低地址</span></span><br><span class="line">    data_to_send[_cnt++] = BYTE0(_a);</span><br><span class="line">    data_to_send[_cnt++] = BYTE1(_a);</span><br><span class="line">	</span><br><span class="line">    data_to_send[_cnt++] = BYTE0(_b);</span><br><span class="line">    data_to_send[_cnt++] = BYTE1(_b);</span><br><span class="line">	</span><br><span class="line">    data_to_send[_cnt++] = BYTE0(_c);</span><br><span class="line">    data_to_send[_cnt++] = BYTE1(_c);</span><br><span class="line">	</span><br><span class="line">    data_to_send[_cnt++] = BYTE0(_d);</span><br><span class="line">    data_to_send[_cnt++] = BYTE1(_d);</span><br><span class="line">	</span><br><span class="line">	  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; data_to_send[<span class="number">3</span>]+<span class="number">4</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        sumcheck += data_to_send[i];</span><br><span class="line">        addcheck += sumcheck;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    data_to_send[_cnt++] = sumcheck;</span><br><span class="line">    data_to_send[_cnt++] = addcheck;</span><br><span class="line">	</span><br><span class="line">	HAL_UART_Transmit(&amp;huart1,data_to_send,_cnt,<span class="number">0xFFFF</span>);<span class="comment">//这里是串口发送函数</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//通过F3帧发送2个int16类型和1个int32类型的数据</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ANO_DT_Send_F3</span><span class="params">(<span class="type">int16_t</span> _a, <span class="type">int16_t</span> _b, <span class="type">int32_t</span> _c )</span>   <span class="comment">//F3帧  2个  int16 参数   1个  int32  参数</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> _cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="type">uint8_t</span> sumcheck = <span class="number">0</span>; <span class="comment">//和校验</span></span><br><span class="line">    <span class="type">uint8_t</span> addcheck = <span class="number">0</span>; <span class="comment">//附加和校验</span></span><br><span class="line">    <span class="type">uint8_t</span> i=<span class="number">0</span>;</span><br><span class="line">    data_to_send[_cnt++] = <span class="number">0xAA</span>;</span><br><span class="line">    data_to_send[_cnt++] = <span class="number">0xFF</span>;</span><br><span class="line">    data_to_send[_cnt++] = <span class="number">0xF3</span>;</span><br><span class="line">    data_to_send[_cnt++] = <span class="number">8</span>; <span class="comment">//数据长度</span></span><br><span class="line">	<span class="comment">//单片机为小端模式-低地址存放低位数据，匿名上位机要求先发低位数据，所以先发低地址</span></span><br><span class="line">    data_to_send[_cnt++] = BYTE0(_a);</span><br><span class="line">    data_to_send[_cnt++] = BYTE1(_a);</span><br><span class="line">	</span><br><span class="line">    data_to_send[_cnt++] = BYTE0(_b);</span><br><span class="line">    data_to_send[_cnt++] = BYTE1(_b);</span><br><span class="line">	</span><br><span class="line">    data_to_send[_cnt++] = BYTE0(_c);</span><br><span class="line">    data_to_send[_cnt++] = BYTE1(_c);</span><br><span class="line">    data_to_send[_cnt++] = BYTE2(_c);</span><br><span class="line">    data_to_send[_cnt++] = BYTE3(_c);</span><br><span class="line">	</span><br><span class="line">	  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; data_to_send[<span class="number">3</span>]+<span class="number">4</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        sumcheck += data_to_send[i];</span><br><span class="line">        addcheck += sumcheck;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    data_to_send[_cnt++] = sumcheck;</span><br><span class="line">    data_to_send[_cnt++] = addcheck;</span><br><span class="line"></span><br><span class="line">	HAL_UART_Transmit(&amp;huart1,data_to_send,_cnt,<span class="number">0xFFFF</span>);<span class="comment">//这里是串口发送函数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>niming.h</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span>  NIMING_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>  NIMING_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;main.h&quot;</span></span></span><br><span class="line"><span class="comment">//需要发送16位,32位数据，对数据拆分，之后每次发送单个字节</span></span><br><span class="line"><span class="comment">//拆分过程：对变量dwTemp 去地址然后将其转化成char类型指针，最后再取出指针所指向的内容</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BYTE0(dwTemp)  (*(char *)(&amp;dwTemp))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BYTE1(dwTemp)  (*((char *)(&amp;dwTemp) + 1))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BYTE2(dwTemp)  (*((char *)(&amp;dwTemp) + 2))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BYTE3(dwTemp)  (*((char *)(&amp;dwTemp) + 3))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">ANO_DT_Send_F1</span><span class="params">(<span class="type">uint16_t</span>, <span class="type">uint16_t</span> _b, <span class="type">uint16_t</span> _c, <span class="type">uint16_t</span> _d)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">ANO_DT_Send_F2</span><span class="params">(<span class="type">int16_t</span> _a, <span class="type">int16_t</span> _b, <span class="type">int16_t</span> _c, <span class="type">int16_t</span> _d)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">ANO_DT_Send_F3</span><span class="params">(<span class="type">int16_t</span> _a, <span class="type">int16_t</span> _b, <span class="type">int32_t</span> _c )</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>添加测试代码</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230103214655364.png" alt="image-20230103214655364"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//电机速度等信息发送到上位机</span></span><br><span class="line"><span class="comment">//注意上位机不支持浮点数，所以要乘100</span></span><br><span class="line">ANO_DT_Send_F2(Motor1Speed*<span class="number">100</span>, <span class="number">3.0</span>*<span class="number">100</span>,Motor2Speed*<span class="number">100</span>,<span class="number">3.0</span>*<span class="number">100</span>);</span><br></pre></td></tr></table></figure>
<p>下面设置上位机-数据解析</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220819192140541.png" alt="image-20220819192140541"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220819191949193.png" alt="image-20220819191949193"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220820125740753.png" alt="image-20220820125740753"></p>
<p>这个是控制效果，并不理想，后面我们介绍PID控制</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220820125338506.png" alt="image-20220820125338506"></p>
<h2 id="8-3-P-I-D-逐个参数理解"><a href="#8-3-P-I-D-逐个参数理解" class="headerlink" title="8.3-P I D 逐个参数理解"></a>8.3-P I D 逐个参数理解</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220820173540806.png" alt="image-20220820173540806" style="zoom:50%;" /></p>
<p>加入的现在 过去 未来概念</p>
<p>p:现在</p>
<p>i:过去</p>
<p>d:未来</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220820140658286.png" alt="image-20220820140658286"></p>
<p>那么我们就开始写PID</p>
<p>PID的结构体类型变量、里面成员都是浮点类型</p>
<p>先在pid.h声明一个结构体类型、声明.c中的函数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230104132732080.png" alt="image-20230104132732080"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __PID_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __PID_H</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//声明一个结构体类型</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="type">float</span> target_val;<span class="comment">//目标值</span></span><br><span class="line">	<span class="type">float</span> actual_val;<span class="comment">//实际值</span></span><br><span class="line">	<span class="type">float</span> err;<span class="comment">//当前偏差</span></span><br><span class="line">	<span class="type">float</span> err_last;<span class="comment">//上次偏差</span></span><br><span class="line">	<span class="type">float</span> err_sum;<span class="comment">//误差累计值</span></span><br><span class="line">	<span class="type">float</span> Kp,Ki,Kd;<span class="comment">//比例，积分，微分系数</span></span><br><span class="line">	</span><br><span class="line">&#125; tPid;</span><br><span class="line"></span><br><span class="line"><span class="comment">//声明函数</span></span><br><span class="line"><span class="type">float</span> <span class="title function_">P_realize</span><span class="params">(tPid * pid,<span class="type">float</span> actual_val)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">PID_init</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">float</span> <span class="title function_">PI_realize</span><span class="params">(tPid * pid,<span class="type">float</span> actual_val)</span>;</span><br><span class="line"><span class="type">float</span> <span class="title function_">PID_realize</span><span class="params">(tPid * pid,<span class="type">float</span> actual_val)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>然后在pid.c中定义结构体类型变量</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230104132821912.png" alt="image-20230104132821912"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pid.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//定义一个结构体类型变量</span></span><br><span class="line">tPid pidMotor1Speed;</span><br><span class="line"><span class="comment">//给结构体类型变量赋初值</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">PID_init</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	pidMotor1Speed.actual_val=<span class="number">0.0</span>;</span><br><span class="line">	pidMotor1Speed.target_val=<span class="number">0.00</span>;</span><br><span class="line">	pidMotor1Speed.err=<span class="number">0.0</span>;</span><br><span class="line">	pidMotor1Speed.err_last=<span class="number">0.0</span>;</span><br><span class="line">	pidMotor1Speed.err_sum=<span class="number">0.0</span>;</span><br><span class="line">	pidMotor1Speed.Kp=<span class="number">0</span>;</span><br><span class="line">	pidMotor1Speed.Ki=<span class="number">0</span>;</span><br><span class="line">	pidMotor1Speed.Kd=<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//比例p调节控制函数</span></span><br><span class="line"><span class="type">float</span> <span class="title function_">P_realize</span><span class="params">(tPid * pid,<span class="type">float</span> actual_val)</span></span><br><span class="line">&#123;</span><br><span class="line">	pid-&gt;actual_val = actual_val;<span class="comment">//传递真实值</span></span><br><span class="line">	pid-&gt;err = pid-&gt;target_val - pid-&gt;actual_val;<span class="comment">//当前误差=目标值-真实值</span></span><br><span class="line">	<span class="comment">//比例控制调节   输出=Kp*当前误差</span></span><br><span class="line">	pid-&gt;actual_val = pid-&gt;Kp*pid-&gt;err;</span><br><span class="line">	<span class="keyword">return</span> pid-&gt;actual_val;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//比例P 积分I 控制函数</span></span><br><span class="line"><span class="type">float</span> <span class="title function_">PI_realize</span><span class="params">(tPid * pid,<span class="type">float</span> actual_val)</span></span><br><span class="line">&#123;</span><br><span class="line">	pid-&gt;actual_val = actual_val;<span class="comment">//传递真实值</span></span><br><span class="line">	pid-&gt;err = pid-&gt;target_val - pid-&gt;actual_val;<span class="comment">//当前误差=目标值-真实值</span></span><br><span class="line">	pid-&gt;err_sum += pid-&gt;err;<span class="comment">//误差累计值 = 当前误差累计和</span></span><br><span class="line">	<span class="comment">//使用PI控制 输出=Kp*当前误差+Ki*误差累计值</span></span><br><span class="line">	pid-&gt;actual_val = pid-&gt;Kp*pid-&gt;err + pid-&gt;Ki*pid-&gt;err_sum;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> pid-&gt;actual_val;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// PID控制函数</span></span><br><span class="line"><span class="type">float</span> <span class="title function_">PID_realize</span><span class="params">(tPid * pid,<span class="type">float</span> actual_val)</span></span><br><span class="line">&#123;</span><br><span class="line">	pid-&gt;actual_val = actual_val;<span class="comment">//传递真实值</span></span><br><span class="line">	pid-&gt;err = pid-&gt;target_val - pid-&gt;actual_val;<span class="comment">////当前误差=目标值-真实值</span></span><br><span class="line">	pid-&gt;err_sum += pid-&gt;err;<span class="comment">//误差累计值 = 当前误差累计和</span></span><br><span class="line">	<span class="comment">//使用PID控制 输出 = Kp*当前误差  +  Ki*误差累计值 + Kd*(当前误差-上次误差)</span></span><br><span class="line">	pid-&gt;actual_val = pid-&gt;Kp*pid-&gt;err + pid-&gt;Ki*pid-&gt;err_sum + pid-&gt;Kd*(pid-&gt;err - pid-&gt;err_last);</span><br><span class="line">	<span class="comment">//保存上次误差: 这次误差赋值给上次误差</span></span><br><span class="line">	pid-&gt;err_last = pid-&gt;err;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> pid-&gt;actual_val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>然后在main中要调用PID_init();函数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230104132925536.png" alt="image-20230104132925536"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PID_init();</span><br></pre></td></tr></table></figure>
<p><strong>p调节函数</strong>函数只根据当前误差进行控制</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//比例p调节控制函数</span></span><br><span class="line"><span class="type">float</span> <span class="title function_">P_realize</span><span class="params">(tPid * pid,<span class="type">float</span> actual_val)</span></span><br><span class="line">&#123;</span><br><span class="line">	pid-&gt;actual_val = actual_val;<span class="comment">//传递真实值</span></span><br><span class="line">	pid-&gt;err = pid-&gt;target_val - pid-&gt;actual_val;<span class="comment">//目标值减去实际值等于误差值</span></span><br><span class="line">	<span class="comment">//比例控制调节</span></span><br><span class="line">	pid-&gt;actual_val = pid-&gt;Kp*pid-&gt;err;</span><br><span class="line">	<span class="keyword">return</span> pid-&gt;actual_val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主函数-可以估算当p=10 就有较好的响应速度</p>
<p>先看根据p比例控制的效果</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220820160006470.png" alt="image-20220820160006470"></p>
<p>p调节 电机稳态后还是存在误差。</p>
<p>下面加入i 调节也就是加入历史误差</p>
<p><strong>pi的控制函数</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//比例P 积分I 控制函数</span></span><br><span class="line"><span class="type">float</span> <span class="title function_">PI_realize</span><span class="params">(tPid * pid,<span class="type">float</span> actual_val)</span></span><br><span class="line">&#123;</span><br><span class="line">	pid-&gt;actual_val = actual_val;<span class="comment">//传递真实值</span></span><br><span class="line">	pid-&gt;err = pid-&gt;target_val - pid-&gt;actual_val;<span class="comment">//目标值减去实际值等于误差值</span></span><br><span class="line">	pid-&gt;err_sum += pid-&gt;err;<span class="comment">//误差累计求和</span></span><br><span class="line">	<span class="comment">//使用PI控制</span></span><br><span class="line">	pid-&gt;actual_val = pid-&gt;Kp*pid-&gt;err + pid-&gt;Ki*pid-&gt;err_sum;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> pid-&gt;actual_val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为实际值1.6的时候误差为1.4 上次偏差1.4和这次偏差1.4相加2.8 我们乘5 等于10点多就会有较好控制效果</p>
<p>这是pi 调节的控制效果</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220820161527982.png" alt="image-20220820161527982"></p>
<p><strong>下面是PID调节的</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PID控制函数</span></span><br><span class="line"><span class="type">float</span> <span class="title function_">PID_realize</span><span class="params">(tPid * pid,<span class="type">float</span> actual_val)</span></span><br><span class="line">&#123;</span><br><span class="line">	pid-&gt;actual_val = actual_val;<span class="comment">//传递真实值</span></span><br><span class="line">	pid-&gt;err = pid-&gt;target_val - pid-&gt;actual_val;<span class="comment">//目标值减去实际值等于误差值</span></span><br><span class="line">	pid-&gt;err_sum += pid-&gt;err;<span class="comment">//误差累计求和</span></span><br><span class="line">	<span class="comment">//使用PID控制</span></span><br><span class="line">	pid-&gt;actual_val = pid-&gt;Kp*pid-&gt;err + pid-&gt;Ki*pid-&gt;err_sum + pid-&gt;Kd*(pid-&gt;err - pid-&gt;err_last);</span><br><span class="line">	<span class="comment">//保存上次误差:最近一次 赋值给上次</span></span><br><span class="line">	pid-&gt;err_last = pid-&gt;err;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> pid-&gt;actual_val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="8-4-加入cJSON方便上位机调参"><a href="#8-4-加入cJSON方便上位机调参" class="headerlink" title="8.4-加入cJSON方便上位机调参"></a>8.4-加入cJSON方便上位机调参</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230104152600270.png" alt="image-20230104152600270"></p>
<p>调大堆栈</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220821142654358.png" alt="image-20220821142654358"></p>
<p>软件开启中断</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220821141804356.png" alt="image-20220821141804356" style="zoom: 25%;" /></p>
<p>开启接收中断</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220821142200828.png" alt="image-20220821142200828"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__HAL_UART_ENABLE_IT(&amp;huart1,UART_IT_RXNE);	<span class="comment">//开启串口1接收中断</span></span><br></pre></td></tr></table></figure>
<p>中断回调函数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220821142512762.png" alt="image-20220821142512762"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint8_t</span> Usart1_ReadBuf[<span class="number">256</span>];	<span class="comment">//串口1 缓冲数组</span></span><br><span class="line"><span class="type">uint8_t</span> Usart1_ReadCount = <span class="number">0</span>;	<span class="comment">//串口1 接收字节计数</span></span><br><span class="line">  <span class="keyword">if</span>(__HAL_UART_GET_FLAG(&amp;huart1,UART_FLAG_RXNE))<span class="comment">//判断huart1 是否读到字节</span></span><br><span class="line">  &#123;</span><br><span class="line">		<span class="keyword">if</span>(Usart1_ReadCount &gt;= <span class="number">255</span>) Usart1_ReadCount = <span class="number">0</span>;</span><br><span class="line">		HAL_UART_Receive(&amp;huart1,&amp;Usart1_ReadBuf[Usart1_ReadCount++],<span class="number">1</span>,<span class="number">1000</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>编写函数用于判断串口是否发送完一帧数据</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220821143245954.png" alt="image-20220821143245954"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">uint8_t</span> Usart1_ReadBuf[<span class="number">255</span>];	<span class="comment">//串口1 缓冲数组</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">uint8_t</span> Usart1_ReadCount;	<span class="comment">//串口1 接收字节计数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//判断否接收完一帧数据</span></span><br><span class="line"><span class="type">uint8_t</span> <span class="title function_">Usart_WaitReasFinish</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">static</span> <span class="type">uint16_t</span> Usart_LastReadCount = <span class="number">0</span>;<span class="comment">//记录上次的计数值</span></span><br><span class="line">	<span class="keyword">if</span>(Usart1_ReadCount == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		Usart_LastReadCount = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;<span class="comment">//表示没有在接收数据</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(Usart1_ReadCount == Usart_LastReadCount)<span class="comment">//如果这次计数值等于上次计数值</span></span><br><span class="line">	&#123;</span><br><span class="line">		Usart1_ReadCount = <span class="number">0</span>;</span><br><span class="line">		Usart_LastReadCount = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;<span class="comment">//已经接收完成了</span></span><br><span class="line">	&#125;</span><br><span class="line">	Usart_LastReadCount = Usart1_ReadCount;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">2</span>;<span class="comment">//表示正在接受中</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们把cJSON库放入工程里面</p>
<p>下载cJSON新版</p>
<p>gtihub链接:<a target="_blank" rel="noopener" href="https://github.com/DaveGamble/cJSON">https://github.com/DaveGamble/cJSON</a></p>
<p>百度网盘链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1AcNHtZuv5bokMQ2f6QoG7Q">https://pan.baidu.com/s/1AcNHtZuv5bokMQ2f6QoG7Q</a></p>
<p>提取码：a422</p>
<p>和添加其他文件一样，加入工程，然后指定路径</p>
<p>编写解析指令的函数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230104173819026.png" alt="image-20230104173819026"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;cJSON.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line">   cJSON *cJsonData ,*cJsonVlaue;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(Usart_WaitReasFinish() == <span class="number">0</span>)<span class="comment">//是否接收完毕</span></span><br><span class="line">	&#123;</span><br><span class="line">		cJsonData  = cJSON_Parse((<span class="type">const</span> <span class="type">char</span> *)Usart1_ReadBuf);</span><br><span class="line">		<span class="keyword">if</span>(cJSON_GetObjectItem(cJsonData,<span class="string">&quot;p&quot;</span>) !=<span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			cJsonVlaue = cJSON_GetObjectItem(cJsonData,<span class="string">&quot;p&quot;</span>);	</span><br><span class="line">		    p = cJsonVlaue-&gt;valuedouble;</span><br><span class="line">			pidMotor1Speed.Kp = p;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(cJSON_GetObjectItem(cJsonData,<span class="string">&quot;i&quot;</span>) !=<span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			cJsonVlaue = cJSON_GetObjectItem(cJsonData,<span class="string">&quot;i&quot;</span>);	</span><br><span class="line">		    i = cJsonVlaue-&gt;valuedouble;</span><br><span class="line">			pidMotor1Speed.Ki = i;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(cJSON_GetObjectItem(cJsonData,<span class="string">&quot;d&quot;</span>) !=<span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			cJsonVlaue = cJSON_GetObjectItem(cJsonData,<span class="string">&quot;d&quot;</span>);	</span><br><span class="line">		    d = cJsonVlaue-&gt;valuedouble;</span><br><span class="line">			pidMotor1Speed.Kd = d;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(cJSON_GetObjectItem(cJsonData,<span class="string">&quot;a&quot;</span>) !=<span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">		</span><br><span class="line">			cJsonVlaue = cJSON_GetObjectItem(cJsonData,<span class="string">&quot;a&quot;</span>);	</span><br><span class="line">		    a = cJsonVlaue-&gt;valuedouble;</span><br><span class="line">			pidMotor1Speed.target_val =a;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(cJsonData != <span class="literal">NULL</span>)&#123;</span><br><span class="line">		  cJSON_Delete(cJsonData);<span class="comment">//释放空间、但是不能删除cJsonVlaue不然会 出现异常错误</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">memset</span>(Usart1_ReadBuf,<span class="number">0</span>,<span class="number">255</span>);<span class="comment">//清空接收buf，注意这里不能使用strlen	</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;P:%.3f  I:%.3f  D:%.3f A:%.3f\r\n&quot;</span>,p,i,d,a);</span><br></pre></td></tr></table></figure>
<p>测试发送cJSON数据就会解析收到数据</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220821151428650.png" alt="image-20220821151428650" style="zoom: 33%;" /></p>
<p>然后我们赋值改变一个电机的PID参数和目标转速</p>
<p>然后我们通过串口发送命令，就会改变PID的参数了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220821163121273.png" alt="image-20220821163121273"></p>
<h1 id="第九章-PID整定方法"><a href="#第九章-PID整定方法" class="headerlink" title="第九章-PID整定方法"></a>第九章-PID整定方法</h1><h2 id="9-1-调整合适的采样周期和PID调参方法"><a href="#9-1-调整合适的采样周期和PID调参方法" class="headerlink" title="9.1-调整合适的采样周期和PID调参方法"></a>9.1-调整合适的采样周期和PID调参方法</h2><p>正如之前所说，现在我们PID控制函数是在主函数中循环调用，这样的调用方式并不能保证实时性，不能保证周期得到调用</p>
<p>所以我们要把PID控制函数放到中断里面定时执行，那么如何放到中断里面执行，执行的周期是多少合适那？</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230104180752706.png" alt="image-20230104180752706" style="zoom:67%;" /></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230104184558395.png" alt="image-20230104184558395"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">	<span class="keyword">if</span>(TimerCount %<span class="number">10</span> ==<span class="number">0</span>)<span class="comment">//每20ms一次</span></span><br><span class="line">	&#123;</span><br><span class="line">		Motor_Set(PID_realize(&amp;pidMotor1Speed,Motor1Speed),<span class="number">0</span>);</span><br><span class="line">	    TimerCount=<span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>烧录测试一下，是否可以改变波形和调整参数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220821180525104.png" alt="image-20220821180525104"></p>
<p><strong>借助上位机调节PID</strong></p>
<ol>
<li>调节P  把I=0、D=0先给正值或负值值测试P 正负、然后根据PID函数输入和输出估算P 大小，然后I=0 D=0去测试，调节一个较大值</li>
<li>调节I  把P等于前面的值 然后测试I给较大正值和负值 测试出I正负，然后I从小值调节，直到没有偏差存在</li>
<li>一般系统不使用D </li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220821205656468.png" alt="image-20220821205656468"></p>
<p>然后当前系统特点 :I 对于系统更重要</p>
<p>下面我们调节I</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220821211930247.png" alt="image-20220821211930247"></p>
<p>给一个较小的i 发现 有一个大的超调，我们就减少p 、减小一半p</p>
<p>下面是减少一半p 的效果</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220821212416979.png" alt="image-20220821212416979"></p>
<p>这个效果还可以</p>
<p><strong>整理双电机速度控制</strong></p>
<p>首先我们的需要是控制两个电机，那么这两个电机的特点不同，他们的P I D 参数不同，要控制不同的目标速度，那么他们的目标值、实际值、偏差等都会不同，所以我们的PID函数就要能够根据输入参数控制电机</p>
<p>我们增加tPid 类型函数的定义用于控制电机</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220822142131051.png" alt="image-20220822142131051"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">tPid pid1_speed;<span class="comment">//电机1的转速控制</span></span><br><span class="line">tPid pid2_speed;<span class="comment">//电机2的转速控制</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化PID参数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">PID_init</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	pid1_speed.actual_val=<span class="number">0.0</span>;<span class="comment">//初始化电机1转速PID 结构体</span></span><br><span class="line">	pid1_speed.target_val=<span class="number">0.0</span>;</span><br><span class="line">	pid1_speed.err=<span class="number">0.0</span>;</span><br><span class="line">	pid1_speed.err_last=<span class="number">0.0</span>;</span><br><span class="line">	pid1_speed.err_sum=<span class="number">0.0</span>;</span><br><span class="line">	pid1_speed.Kp=<span class="number">0.0</span>;</span><br><span class="line">	pid1_speed.Ki=<span class="number">0.0</span>;</span><br><span class="line">	pid1_speed.Kd=<span class="number">0.0</span>;</span><br><span class="line">	</span><br><span class="line">	pid2_speed.actual_val=<span class="number">0.0</span>;<span class="comment">//初始化电机2转速PID 结构体</span></span><br><span class="line">	pid2_speed.target_val=<span class="number">0.0</span>;</span><br><span class="line">	pid2_speed.err=<span class="number">0.0</span>;</span><br><span class="line">	pid2_speed.err_last=<span class="number">0.0</span>;</span><br><span class="line">	pid2_speed.err_sum=<span class="number">0.0</span>;</span><br><span class="line">	pid2_speed.Kp=<span class="number">0.0</span>;</span><br><span class="line">	pid2_speed.Ki=<span class="number">0.0</span>;</span><br><span class="line">	pid2_speed.Kd=<span class="number">0.0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>更改一下PID函数，这里我们使用结构体作为函数地址</p>
<p>访问因为是地址，访问结构体变量要用-&gt;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span> <span class="title function_">PID_realize</span><span class="params">(tPid * pid,<span class="type">float</span> actual_val)</span></span><br><span class="line">&#123;</span><br><span class="line">	pid-&gt;actual_val = actual_val;<span class="comment">//传递真实值</span></span><br><span class="line">	pid-&gt;err = pid-&gt;target_val - pid-&gt;actual_val;<span class="comment">//目标值减去实际值等于误差值</span></span><br><span class="line">	pid-&gt;err_sum += pid-&gt;err;<span class="comment">//误差累计求和</span></span><br><span class="line">	<span class="comment">//使用PID控制</span></span><br><span class="line">	pid-&gt;actual_val = pid-&gt;Kp*pid-&gt;err + pid-&gt;Ki*pid-&gt;err_sum + pid-&gt;Kd*(pid-&gt;err - pid-&gt;err_last);</span><br><span class="line">	<span class="comment">//保存上次误差:最近一次 赋值给上次</span></span><br><span class="line">	pid-&gt;err_last = pid-&gt;err;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> pid-&gt;actual_val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>更改主函数，对PID函数的使用</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220822143256375.png" alt="image-20220822143256375"></p>
<p>然后可以分别调节电机1的参数和电机二的参数</p>
<p>把测试好的PID 参数分别写在PID_init里面</p>
<h1 id="以上是入门篇"><a href="#以上是入门篇" class="headerlink" title="以上是入门篇"></a>以上是入门篇</h1><p>通过上面的学习与实操，大家对:PWM、电机驱动、PID闭环控制、串口通信等有了一定掌握，如果上面那个章节掌握不好，一定要多看两遍视频，多敲边代码，还有疑惑可以百度查找或者留言问题。</p>
<p>后面的内容就是偏应用比较简单了。</p>
<h1 id="下面应用篇"><a href="#下面应用篇" class="headerlink" title="下面应用篇"></a>下面应用篇</h1><h1 id="第10章-小车跑一跑"><a href="#第10章-小车跑一跑" class="headerlink" title="第10章-小车跑一跑"></a>第10章-小车跑一跑</h1><h2 id="如何实现小车的前、后、左、右、停"><a href="#如何实现小车的前、后、左、右、停" class="headerlink" title="如何实现小车的前、后、左、右、停"></a>如何实现小车的前、后、左、右、停</h2><p>控制电机速度就可以控制小车运动</p>
<p>如何控制电机速度？</p>
<p>改变小车速度PID的目标值，然后定时器里面的PID控制函数就会计算输占空比然后控制小车。</p>
<p>代码如下:</p>
<p>定时器里面有电机控制，我们这里还增加Motor_Set(PID_realize(&amp;pidMotor1Speed,Motor1Speed),PID_realize(&amp;pidMotor2Speed,Motor2Speed));</p>
<p>是为了提高实时性。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230105131132508.png" alt="image-20230105131132508"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*******************</span></span><br><span class="line"><span class="comment">*  @brief  通过PID控制电机转速</span></span><br><span class="line"><span class="comment">*  @param  Motor1Speed:电机1 目标速度、Motor2Speed:电机2 目标速度</span></span><br><span class="line"><span class="comment">*  @return  无</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">*******************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">motorPidSetSpeed</span><span class="params">(<span class="type">float</span> Motor1SetSpeed,<span class="type">float</span> Motor2SetSpeed)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//改变电机PID参数的目标速度</span></span><br><span class="line">	pidMotor1Speed.target_val = Motor1SetSpeed;</span><br><span class="line">	pidMotor2Speed.target_val = Motor2SetSpeed;</span><br><span class="line">	<span class="comment">//根据PID计算 输出作用于电机</span></span><br><span class="line">	Motor_Set(PID_realize(&amp;pidMotor1Speed,Motor1Speed),PID_realize(&amp;pidMotor2Speed,Motor2Speed));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很容易得到一下控制方式</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//	motorPidSetSpeed(1,2);//向右转弯</span></span><br><span class="line"><span class="comment">//	motorPidSetSpeed(2,1);//向左转弯</span></span><br><span class="line"><span class="comment">//	motorPidSetSpeed(1,1);//前进</span></span><br><span class="line"><span class="comment">//	motorPidSetSpeed(-1,-1);//后退</span></span><br><span class="line"><span class="comment">//	motorPidSetSpeed(0,0);//停止</span></span><br></pre></td></tr></table></figure>
<h2 id="向左原地转弯、向原地转弯"><a href="#向左原地转弯、向原地转弯" class="headerlink" title="向左原地转弯、向原地转弯"></a>向左原地转弯、向原地转弯</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230105143208101.png" alt="image-20230105143208101"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//	motorPidSetSpeed(-1,1);//右原地旋转</span></span><br><span class="line"><span class="comment">//	motorPidSetSpeed(1,-1);//左原地旋转</span></span><br></pre></td></tr></table></figure>
<h2 id="加速减速函数"><a href="#加速减速函数" class="headerlink" title="加速减速函数"></a>加速减速函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//向前加速函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">motorSpeedUp</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">static</span> <span class="type">float</span> MotorSetSpeedUp=<span class="number">0.5</span>;<span class="comment">//静态变量 函数结束 变量不会销毁</span></span><br><span class="line">	<span class="keyword">if</span>(MotorSetSpeedUp &lt;= MAX_SPEED_UP) MotorSetSpeedUp +=<span class="number">0.5</span> ;  <span class="comment">//如果没有超过最大值就增加0.5</span></span><br><span class="line">	motorPidSetSpeed(MotorSetSpeedUp,MotorSetSpeedUp);<span class="comment">//设置到电机</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//向前减速函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">motorSpeedCut</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">static</span> <span class="type">float</span>  MotorSetSpeedCut=<span class="number">3</span>;<span class="comment">//静态变量 函数结束 变量不会销毁</span></span><br><span class="line">	<span class="keyword">if</span>(MotorSetSpeedCut &gt;=<span class="number">0.5</span>) MotorSetSpeedCut-=<span class="number">0.5</span>;<span class="comment">//判断是否速度太小</span></span><br><span class="line">	motorPidSetSpeed(MotorSetSpeedCut,MotorSetSpeedCut);<span class="comment">//设置到电机</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="第11章-OLED速度与历程显示"><a href="#第11章-OLED速度与历程显示" class="headerlink" title="第11章-OLED速度与历程显示"></a>第11章-OLED速度与历程显示</h1><p>这节我们显示两轮速度和里程</p>
<p>两轮速度很简单 之前已经计算过，那么如何计算里程那？</p>
<p>里程:小车行驶的路程长度。</p>
<p>这里我们只要计算出每个单位时间小车行驶的长度然后一直相加，就是这一段时间行驶的总里程长度了。</p>
<p>我们20ms计算一次,20ms走过了多少距离，然后一直相加，就是走的总距离，就是里程。这里我们使用使用电机1 车轮1进行计算。你也可以电机1 和电机2相加然后除2。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230105235911920.png" alt="image-20230105235911920"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230105221819413.png" alt="image-20230105221819413"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*里程数(cm) += 时间周期（s）*车轮转速(转/s)*车轮周长(cm)*/</span></span><br><span class="line">Mileage += <span class="number">0.02</span>*Motor1Speed*<span class="number">22</span>;</span><br></pre></td></tr></table></figure>
<p>然后主函数我们通过OLED显示电机速度和小车里程</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230105234102312.png" alt="image-20230105234102312"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">   <span class="built_in">sprintf</span>((<span class="type">char</span> *)OledString,<span class="string">&quot;V1:%.2fV2:%.2f&quot;</span>, Motor1Speed,Motor2Speed);<span class="comment">//显示两个电机的速度</span></span><br><span class="line">OLED_ShowString(<span class="number">0</span>,<span class="number">0</span>,OledString,<span class="number">12</span>);<span class="comment">//这个是oled驱动里面的，是显示位置的一个函数</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">sprintf</span>((<span class="type">char</span> *)OledString,<span class="string">&quot;Mileage:%.2f   &quot;</span>,Mileage);<span class="comment">//显示里程数</span></span><br><span class="line">OLED_ShowString(<span class="number">0</span>,<span class="number">1</span>,OledString,<span class="number">12</span>);<span class="comment">//这个是oled驱动里面的，是显示位置的一个函数</span></span><br></pre></td></tr></table></figure>
<h1 id="第12章-ADC采集电压和显示"><a href="#第12章-ADC采集电压和显示" class="headerlink" title="第12章-ADC采集电压和显示"></a>第12章-ADC采集电压和显示</h1><p><strong>什么是ADC</strong></p>
<p>百度百科介绍：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221108210407873.png" alt="image-20221108210407873"></p>
<p>我们知道万用表 电压表可以测量电池，或者电路电压。那么我们是否可以通过单片机获得电压，方便我 们监控电池状态</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221108210425866.png" alt="image-20221108210425866" style="zoom: 33%;" /></p>
<p>如何测量我们的锂电池电压那？锂电池电压12V左右，单片机ADC最大测量电压3.3V，这里我们需要分 压电路分压。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221108211039622.png" alt="image-20221108211039622"></p>
<p>然后我们通过电阻分压，显而易见 ADC点的电压是VBAT_IN的 五分之一</p>
<ol>
<li>软件初始化一下ADC 。</li>
<li>然后注意调长一点采样时间、这样精度才会更高一点。</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221109232125714.png" alt="image-20221109232125714"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221108213505630.png" alt="image-20221108213505630"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221108213614198.png" alt="image-20221108213614198"></p>
<p>在adc.c文件添加ADC相关函数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230106230750593.png" alt="image-20230106230750593"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*******************</span></span><br><span class="line"><span class="comment">*  @brief  电池电压测量计算函数</span></span><br><span class="line"><span class="comment">*  @param  无</span></span><br><span class="line"><span class="comment">*  @return 小车电池电压</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">*******************/</span></span><br><span class="line"><span class="type">float</span> <span class="title function_">adcGetBatteryVoltage</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	HAL_ADC_Start(&amp;hadc2);<span class="comment">//启动ADC转化</span></span><br><span class="line">	<span class="keyword">if</span>(HAL_OK == HAL_ADC_PollForConversion(&amp;hadc2,<span class="number">50</span>))<span class="comment">//等待转化完成、超时时间50ms</span></span><br><span class="line">		<span class="keyword">return</span> (<span class="type">float</span>)HAL_ADC_GetValue(&amp;hadc2)/<span class="number">4096</span>*<span class="number">3.3</span>*<span class="number">5</span>;<span class="comment">//计算电池电压</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在main中调用显示函数显示电压</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230106230924860.png" alt="image-20230106230924860"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sprintf</span>((<span class="type">char</span>*)OledString, <span class="string">&quot;U:%.2fV&quot;</span>, adcGetBatteryVoltage());</span><br><span class="line">OLED_ShowString(<span class="number">0</span>,<span class="number">2</span>,OledString,<span class="number">12</span>);<span class="comment">//这个是oled驱动里面的，是显示位置的一个函数，</span></span><br></pre></td></tr></table></figure>
<h1 id="第13章-循迹功能"><a href="#第13章-循迹功能" class="headerlink" title="第13章-循迹功能"></a>第13章-循迹功能</h1><h2 id="13-1-非PID循迹功能完成"><a href="#13-1-非PID循迹功能完成" class="headerlink" title="13.1-非PID循迹功能完成"></a>13.1-非PID循迹功能完成</h2><h3 id="先红外对管调试"><a href="#先红外对管调试" class="headerlink" title="先红外对管调试"></a>先红外对管调试</h3><p>我们这里学习一下，如何实现循迹功能</p>
<p>如何才能让小车沿着黑线运动、要让小车感知到黑线的位置，使用这种传感器就可以反馈黑线是否存在</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221110222632542.png" alt="image-20221110222632542" style="zoom: 80%;" /></p>
<p>根据传感器特性，我们检测红外对管DO引脚的电压就可以知道，下面有没有黑线</p>
<p><strong>DO 高电平-&gt;有黑线 小灯灭</strong></p>
<p><strong>DO低电平-&gt;没有黑线 小灯亮</strong></p>
<p>这是好多地方对这个产品的说明</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221110153310630.png" alt="image-20221110153310630" style="zoom: 33%;" /></p>
<p>然后我们组合上面的红外对管，安装到小车上，就可以知道小车是否偏离了黑线，</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230107012917946.png" alt="image-20230107012917946"></p>
<p>下面我们通过单片机读取红外对管DO口的电压，就知道黑线在小车下面的位置了</p>
<p> <strong>STM32初始化</strong></p>
<p>先看原理图需要初始化那些引脚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221110224613242.png" alt="image-20221110224613242" style="zoom:67%;" /></p>
<p>把<strong>OUT_1-PA5、OUT_2-PA7、OUT_3-PB0、OUT_4-PB1</strong>初始化为输入模式</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221110230859290.png" alt="image-20221110230859290"></p>
<p>重新生成</p>
<p>然后我们在gpio.h 添加读取GPIO的宏，使得程序更简洁</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221110232405800.png" alt="image-20221110232405800"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> READ_HW_OUT_1   HAL_GPIO_ReadPin(HW_OUT_1_GPIO_Port,HW_OUT_1_Pin) <span class="comment">//读取红外对管连接的GPIO电平</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> READ_HW_OUT_2   HAL_GPIO_ReadPin(HW_OUT_2_GPIO_Port,HW_OUT_2_Pin)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> READ_HW_OUT_3   HAL_GPIO_ReadPin(HW_OUT_3_GPIO_Port,HW_OUT_3_Pin)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> READ_HW_OUT_4   HAL_GPIO_ReadPin(HW_OUT_4_GPIO_Port,HW_OUT_4_Pin)</span></span><br></pre></td></tr></table></figure>
<p>根据红外对管状态控制电机速度</p>
<p>注意：整个主函数不要加入延时，这样实时性更高，可以根据红外对管状态做出及时控制</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230107165249367.png" alt="image-20230107165249367"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(READ_HW_OUT_1 == <span class="number">0</span>&amp;&amp;READ_HW_OUT_2 == <span class="number">0</span>&amp;&amp;READ_HW_OUT_3 == <span class="number">0</span>&amp;&amp;READ_HW_OUT_4 == <span class="number">0</span> )</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;应该前进\r\n&quot;</span>);</span><br><span class="line">	motorPidSetSpeed(<span class="number">1</span>,<span class="number">1</span>);<span class="comment">//前运动</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(READ_HW_OUT_1 == <span class="number">0</span>&amp;&amp;READ_HW_OUT_2 == <span class="number">1</span>&amp;&amp;READ_HW_OUT_3 == <span class="number">0</span>&amp;&amp;READ_HW_OUT_4 == <span class="number">0</span> )</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;应该右转\r\n&quot;</span>);</span><br><span class="line">	motorPidSetSpeed(<span class="number">0.5</span>,<span class="number">2</span>);<span class="comment">//右边运动</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(READ_HW_OUT_1 == <span class="number">1</span>&amp;&amp;READ_HW_OUT_2 == <span class="number">0</span>&amp;&amp;READ_HW_OUT_3 == <span class="number">0</span>&amp;&amp;READ_HW_OUT_4 == <span class="number">0</span> )</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;快速右转\r\n&quot;</span>);</span><br><span class="line">	motorPidSetSpeed(<span class="number">0.5</span>,<span class="number">2.5</span>);<span class="comment">//快速右转</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(READ_HW_OUT_1 == <span class="number">0</span>&amp;&amp;READ_HW_OUT_2 == <span class="number">0</span>&amp;&amp;READ_HW_OUT_3 == <span class="number">1</span>&amp;&amp;READ_HW_OUT_4 == <span class="number">0</span> )</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;应该左转\r\n&quot;</span>);</span><br><span class="line">	motorPidSetSpeed(<span class="number">2</span>,<span class="number">0.5</span>);<span class="comment">//左边运动</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(READ_HW_OUT_1 == <span class="number">0</span>&amp;&amp;READ_HW_OUT_2 == <span class="number">0</span>&amp;&amp;READ_HW_OUT_3 == <span class="number">0</span>&amp;&amp;READ_HW_OUT_4 == <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;快速左转\r\n&quot;</span>);</span><br><span class="line">	motorPidSetSpeed(<span class="number">2.5</span>,<span class="number">0.5</span>);<span class="comment">//快速左转</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后测试</p>
<ol>
<li>测试红外对管灵敏度，放在有黑线的地上或者纸上，然后把小车黑线比如放到最右边 及第一个红外对管，观察红外对管小灯变化情况和串口输出情况，如果小灯没有灭，就调节红外对管灵敏度和室内灯光，直到每个红外对管都可以感应到小灯。</li>
<li>然后在黑线上让小车循迹</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230107152753253.png" alt="image-20230107152753253"></p>
<h3 id="然后循迹功能完成"><a href="#然后循迹功能完成" class="headerlink" title="然后循迹功能完成"></a>然后循迹功能完成</h3><p>然后放到地上</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230107185627568.png" alt="image-20230107185627568"></p>
<h2 id="13-2-加入循迹PID"><a href="#13-2-加入循迹PID" class="headerlink" title="13.2-加入循迹PID"></a>13.2-加入循迹PID</h2><p>前面的代码我们对循迹是判断的几个状态，然后PID控制电机不同速度，但是我们可以使用红外对管状态作为PID控制的输入然后再控制电机。</p>
<p>PID的输入是红外对管状态，我们设计 PID输入是红外对管的状态、然后输出一个速度值，然后左右电机去加或者减这个值，就可以完成根据红外对管输入对电机的差速控制</p>
<p>主函数添加的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230107210726187.png" alt="image-20230107210726187"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> tPid pidHW_Tracking;<span class="comment">//红外循迹的PID</span></span><br><span class="line"><span class="type">uint8_t</span> g_ucaHW_Read[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;<span class="comment">//保存红外对管电平的数组</span></span><br><span class="line"><span class="type">int8_t</span> g_cThisState = <span class="number">0</span>;<span class="comment">//这次状态</span></span><br><span class="line"><span class="type">int8_t</span> g_cLastState = <span class="number">0</span>; <span class="comment">//上次状态</span></span><br><span class="line"><span class="type">float</span> g_fHW_PID_Out;<span class="comment">//红外对管PID计算输出速度</span></span><br><span class="line"><span class="type">float</span> g_fHW_PID_Out1;<span class="comment">//电机1的最后循迹PID控制速度</span></span><br><span class="line"><span class="type">float</span> g_fHW_PID_Out2;<span class="comment">//电机2的最后循迹PID控制速度</span></span><br></pre></td></tr></table></figure>
<p>然后实现PID循迹控制、注意为了更加快，要减少没有必要的程序和优化判断、将没有必要的输出都注释掉</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230107210854550.png" alt="image-20230107210854550"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">	g_ucaHW_Read[<span class="number">0</span>] = READ_HW_OUT_1;<span class="comment">//读取红外对管状态、这样相比于写在if里面更高效</span></span><br><span class="line">	g_ucaHW_Read[<span class="number">1</span>] = READ_HW_OUT_2;</span><br><span class="line">	g_ucaHW_Read[<span class="number">2</span>] = READ_HW_OUT_3;</span><br><span class="line">	g_ucaHW_Read[<span class="number">3</span>] = READ_HW_OUT_4;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(g_ucaHW_Read[<span class="number">0</span>] == <span class="number">0</span>&amp;&amp;g_ucaHW_Read[<span class="number">1</span>] == <span class="number">0</span>&amp;&amp;g_ucaHW_Read[<span class="number">2</span>] == <span class="number">0</span>&amp;&amp;g_ucaHW_Read[<span class="number">3</span>] == <span class="number">0</span> )</span><br><span class="line">	&#123;</span><br><span class="line"><span class="comment">//		printf(&quot;应该前进\r\n&quot;);//注释掉更加高效，减少无必要程序执行</span></span><br><span class="line">		g_cThisState = <span class="number">0</span>;<span class="comment">//前进</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(g_ucaHW_Read[<span class="number">0</span>] == <span class="number">0</span>&amp;&amp;g_ucaHW_Read[<span class="number">1</span>] == <span class="number">1</span>&amp;&amp;g_ucaHW_Read[<span class="number">2</span>] == <span class="number">0</span>&amp;&amp;g_ucaHW_Read[<span class="number">3</span>] == <span class="number">0</span> )<span class="comment">//使用else if更加合理高效</span></span><br><span class="line">	&#123;</span><br><span class="line"><span class="comment">//		printf(&quot;应该右转\r\n&quot;);</span></span><br><span class="line">		g_cThisState = <span class="number">-1</span>;<span class="comment">//应该右转</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(g_ucaHW_Read[<span class="number">0</span>] == <span class="number">1</span>&amp;&amp;g_ucaHW_Read[<span class="number">1</span>] == <span class="number">0</span>&amp;&amp;g_ucaHW_Read[<span class="number">2</span>] == <span class="number">0</span>&amp;&amp;g_ucaHW_Read[<span class="number">3</span>] == <span class="number">0</span> )</span><br><span class="line">	&#123;</span><br><span class="line"><span class="comment">//		printf(&quot;快速右转\r\n&quot;);</span></span><br><span class="line">		g_cThisState = <span class="number">-2</span>;<span class="comment">//快速右转</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(g_ucaHW_Read[<span class="number">0</span>] == <span class="number">1</span>&amp;&amp;g_ucaHW_Read[<span class="number">1</span>] == <span class="number">1</span>&amp;&amp;g_ucaHW_Read[<span class="number">2</span>] == <span class="number">0</span>&amp;&amp;g_ucaHW_Read[<span class="number">3</span>] == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line"><span class="comment">//		printf(&quot;快速右转\r\n&quot;);</span></span><br><span class="line">		g_cThisState = <span class="number">-3</span>;<span class="comment">//快速右转</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(g_ucaHW_Read[<span class="number">0</span>] == <span class="number">0</span>&amp;&amp;g_ucaHW_Read[<span class="number">1</span>] == <span class="number">0</span>&amp;&amp;g_ucaHW_Read[<span class="number">2</span>] == <span class="number">1</span>&amp;&amp;g_ucaHW_Read[<span class="number">3</span>] == <span class="number">0</span> )</span><br><span class="line">	&#123;</span><br><span class="line"><span class="comment">//		printf(&quot;应该左转\r\n&quot;);</span></span><br><span class="line">		g_cThisState = <span class="number">1</span>;<span class="comment">//应该左转	</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(g_ucaHW_Read[<span class="number">0</span>] == <span class="number">0</span>&amp;&amp;g_ucaHW_Read[<span class="number">1</span>] == <span class="number">0</span>&amp;&amp;g_ucaHW_Read[<span class="number">2</span>] == <span class="number">0</span>&amp;&amp;g_ucaHW_Read[<span class="number">3</span>] == <span class="number">1</span> )</span><br><span class="line">	&#123;</span><br><span class="line"><span class="comment">//		printf(&quot;快速左转\r\n&quot;);</span></span><br><span class="line">		g_cThisState = <span class="number">2</span>;<span class="comment">//快速左转</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(g_ucaHW_Read[<span class="number">0</span>] == <span class="number">0</span>&amp;&amp;g_ucaHW_Read[<span class="number">1</span>] == <span class="number">0</span>&amp;&amp;g_ucaHW_Read[<span class="number">2</span>] == <span class="number">1</span>&amp;&amp;g_ucaHW_Read[<span class="number">3</span>] == <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line"><span class="comment">//	    printf(&quot;快速左转\r\n&quot;);</span></span><br><span class="line">		g_cThisState = <span class="number">3</span>;<span class="comment">//快速左转</span></span><br><span class="line">	&#125;</span><br><span class="line">	g_fHW_PID_Out = PID_realize(&amp;pidHW_Tracking,g_cThisState);<span class="comment">//PID计算输出目标速度 这个速度，会和基础速度加减</span></span><br><span class="line"></span><br><span class="line">	g_fHW_PID_Out1 = <span class="number">3</span> + g_fHW_PID_Out;<span class="comment">//电机1速度=基础速度+循迹PID输出速度</span></span><br><span class="line">	g_fHW_PID_Out2 = <span class="number">3</span> - g_fHW_PID_Out;<span class="comment">//电机1速度=基础速度-循迹PID输出速度</span></span><br><span class="line">	<span class="keyword">if</span>(g_fHW_PID_Out1 &gt;<span class="number">5</span>) g_fHW_PID_Out1 =<span class="number">5</span>;<span class="comment">//进行限幅 限幅速度在0-5之间</span></span><br><span class="line">	<span class="keyword">if</span>(g_fHW_PID_Out1 &lt;<span class="number">0</span>) g_fHW_PID_Out1 =<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(g_fHW_PID_Out2 &gt;<span class="number">5</span>) g_fHW_PID_Out2 =<span class="number">5</span>;</span><br><span class="line">	<span class="keyword">if</span>(g_fHW_PID_Out2 &lt;<span class="number">0</span>) g_fHW_PID_Out2 =<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(g_cThisState != g_cLastState)<span class="comment">//如何这次状态不等于上次状态、就进行改变目标速度和控制电机、在定时器中依旧定时控制电机</span></span><br><span class="line">	&#123;</span><br><span class="line">		motorPidSetSpeed(g_fHW_PID_Out1,g_fHW_PID_Out2);<span class="comment">//通过计算的速度控制电机</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	g_cLastState = g_cThisState;<span class="comment">//保存上次红外对管状态</span></span><br></pre></td></tr></table></figure>
<p>在pid.中</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230107211037921.png" alt="image-20230107211037921"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tPid pidHW_Tracking;<span class="comment">//红外循迹的PID</span></span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230107211104780.png" alt="image-20230107211104780"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pidHW_Tracking.actual_val=<span class="number">0.0</span>;</span><br><span class="line">pidHW_Tracking.target_val=<span class="number">0.00</span>;<span class="comment">//红外循迹PID 的目标值为0</span></span><br><span class="line">pidHW_Tracking.err=<span class="number">0.0</span>;</span><br><span class="line">pidHW_Tracking.err_last=<span class="number">0.0</span>;</span><br><span class="line">pidHW_Tracking.err_sum=<span class="number">0.0</span>;</span><br><span class="line">pidHW_Tracking.Kp=<span class="number">-1.50</span>;</span><br><span class="line">pidHW_Tracking.Ki=<span class="number">0</span>;</span><br><span class="line">pidHW_Tracking.Kd=<span class="number">0.80</span>;</span><br></pre></td></tr></table></figure>
<p>然后就可以跑一下试试了。</p>
<p>可以改进的地方</p>
<ol>
<li>红外对管影响差速转向，也影响基础直行的速度 ，会有更好控制效果，所以可以加入每种红外对管状态下对基础速度的影响。</li>
<li>红外对管的数量越多，效果会越好。</li>
</ol>
<h1 id="第14章-手机遥控功能"><a href="#第14章-手机遥控功能" class="headerlink" title="第14章-手机遥控功能"></a>第14章-手机遥控功能</h1><p>我们要实现蓝牙遥控功能，蓝牙遥控功能要使用:1.单片机的串口、2.蓝牙通信模块</p>
<p>所以我们先调试好:单片机的串口-&gt;蓝牙模块-&gt;接到一起联调</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230108094941496.png" alt="image-20230108094941496"></p>
<h2 id="14-1-电脑控制小车"><a href="#14-1-电脑控制小车" class="headerlink" title="14.1-电脑控制小车"></a>14.1-电脑控制小车</h2><p>完成功能:电脑连接单片机串口三 控制小车前进后退</p>
<p><strong>先看原理图</strong></p>
<p>通过原理图可以看出这是使用的串口3 在使用的时候注意把跳线帽，跳线到蓝牙通信位置</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221113145542144.png" alt="image-20221113145542144"></p>
<p>打开初始化软件</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221113161440641.png" alt="image-20221113161440641"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221113162259965.png" alt="image-20221113162259965"></p>
<p>生成代码</p>
<p>在main 定义全局变量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint8_t</span> g_ucUsart3ReceiveData;  <span class="comment">//保存串口三接收的数据</span></span><br></pre></td></tr></table></figure>
<p>开启串口三中断接收</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230108011852886.png" alt="image-20230108011852886"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HAL_UART_Receive_IT(&amp;huart3,&amp;g_ucUsart3ReceiveData,<span class="number">1</span>);  <span class="comment">//串口三接收数据</span></span><br></pre></td></tr></table></figure>
<p>在<strong>usart.c</strong> 重新实现串口中断回调函数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221113163755469.png" alt="image-20221113163755469"></p>
<p>然后我们可以在中断回调函数里面中编写遥控命令控制逻辑了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230108021416560.png" alt="image-20230108021416560"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//串口接收回调函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">HAL_UART_RxCpltCallback</span><span class="params">(UART_HandleTypeDef *huart)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>( huart == &amp;huart3)<span class="comment">//判断中断源</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(g_ucUsart3ReceiveData == <span class="string">&#x27;A&#x27;</span>) motorPidSetSpeed(<span class="number">1</span>,<span class="number">1</span>);<span class="comment">//前运动</span></span><br><span class="line">		<span class="keyword">if</span>(g_ucUsart3ReceiveData == <span class="string">&#x27;B&#x27;</span>) motorPidSetSpeed(<span class="number">-1</span>,<span class="number">-1</span>);<span class="comment">//后运动</span></span><br><span class="line">		<span class="keyword">if</span>(g_ucUsart3ReceiveData == <span class="string">&#x27;C&#x27;</span>) motorPidSetSpeed(<span class="number">0</span>,<span class="number">0</span>);<span class="comment">//停止</span></span><br><span class="line">		<span class="keyword">if</span>(g_ucUsart3ReceiveData == <span class="string">&#x27;D&#x27;</span>) motorPidSetSpeed(<span class="number">1</span>,<span class="number">2</span>);<span class="comment">//右边运动	</span></span><br><span class="line">		<span class="keyword">if</span>(g_ucUsart3ReceiveData == <span class="string">&#x27;E&#x27;</span>) motorPidSetSpeed(<span class="number">2</span>,<span class="number">1</span>);<span class="comment">//左边运动</span></span><br><span class="line">		<span class="keyword">if</span>(g_ucUsart3ReceiveData == <span class="string">&#x27;F&#x27;</span>) motorPidSpeedUp();<span class="comment">//加速</span></span><br><span class="line">		<span class="keyword">if</span>(g_ucUsart3ReceiveData == <span class="string">&#x27;G&#x27;</span>) motorPidSpeedCut();<span class="comment">//减速</span></span><br><span class="line">		</span><br><span class="line">		HAL_UART_Receive_IT( &amp;huart3, &amp;g_ucUsart3ReceiveData, <span class="number">1</span>);<span class="comment">//继续进行中断接收</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在usart.c中声明外部变量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">uint8_t</span> g_ucUsart3ReceiveData;  <span class="comment">//保存串口三接收的数据</span></span><br></pre></td></tr></table></figure>
<p>然后我们更改一下 主函数内容，把PID红外循迹代码注释掉，然后我们增加串口三的输出，以便我们后面观察数据。</p>
<p><strong>串口不定长输出</strong></p>
<p>我们把转速等信息都可以显示在OLED上，那么如何通过串口输出那？</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230108115259681.png" alt="image-20230108115259681"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sprintf</span>((<span class="type">char</span> *)Usart3String,<span class="string">&quot;V1:%.2fV2:%.2f\r\n&quot;</span>,Motor1Speed,Motor2Speed);<span class="comment">//显示两个电机转速 单位：转/秒</span></span><br><span class="line">HAL_UART_Transmit(&amp;huart3,( <span class="type">uint8_t</span> *)Usart3String,<span class="built_in">strlen</span>(( <span class="type">const</span>  <span class="type">char</span>  *)Usart3String),<span class="number">50</span>);<span class="comment">//阻塞式发送通过串口三输出字符 strlen:计算字符串大小</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">sprintf</span>((<span class="type">char</span> *)Usart3String,<span class="string">&quot;Mileage%.2f\r\n&quot;</span>,Mileage);<span class="comment">//计算小车里程 单位cm</span></span><br><span class="line">HAL_UART_Transmit(&amp;huart3,( <span class="type">uint8_t</span> *)Usart3String,<span class="built_in">strlen</span>(( <span class="type">const</span>  <span class="type">char</span>  *)Usart3String),<span class="number">50</span>);<span class="comment">//阻塞式发送通过串口三输出字符 strlen:计算字符串大小</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">sprintf</span>((<span class="type">char</span> *)Usart3String,<span class="string">&quot;U:%.2fV\r\n&quot;</span>,adcGetBatteryVoltage());<span class="comment">//显示电池电压</span></span><br><span class="line">HAL_UART_Transmit(&amp;huart3,( <span class="type">uint8_t</span> *)Usart3String,<span class="built_in">strlen</span>(( <span class="type">const</span>  <span class="type">char</span>  *)Usart3String),<span class="number">50</span>);<span class="comment">//阻塞式发送通过串口三输出字符 strlen:计算字符串大小	</span></span><br><span class="line">HAL_Delay(<span class="number">5</span>);</span><br></pre></td></tr></table></figure>
<p>把之前PID初始化时候速度PID目标值改成0</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230108113408329.png" alt="image-20230108113408329"></p>
<p><strong>然后我们测试</strong></p>
<p><strong>硬件连接</strong></p>
<p>我们现在使用USB-TTL连接串口三，单片机串口三与电脑通信(<strong>底板不需要插入蓝牙</strong>)</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230108121744588.png" alt="image-20230108121744588"></p>
<p> 然后打开软件</p>
<p>发送指令小车就会对应运动</p>
<p>在电脑串口软件查看输出信息、发送 指令控制小车运动</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230108115952589.png" alt="image-20230108115952589"></p>
<h2 id="14-2-手机蓝牙控制小车"><a href="#14-2-手机蓝牙控制小车" class="headerlink" title="14.2-手机蓝牙控制小车"></a>14.2-手机蓝牙控制小车</h2><p>功能:蓝牙遥控小车前进、后退、停止、左右转、加速、减速、手机显示数据</p>
<h3 id="蓝牙模块和电脑通信"><a href="#蓝牙模块和电脑通信" class="headerlink" title="蓝牙模块和电脑通信"></a>蓝牙模块和电脑通信</h3><p><strong>蓝牙模块-硬件介绍</strong></p>
<p>使用：HC-05 主从机一体蓝牙串口透传模块 </p>
<p>注意： 供电3.6V-6V(最好5V)</p>
<p>引脚顺序 VCC GND TXD RXD</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221114115307410.png" alt="image-20221114115307410"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221114115640083.png" alt="image-20221114115640083"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221114115333609.png" alt="image-20221114115333609"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221114115624973.png" alt="image-20221114115624973"></p>
<p><strong>先调试蓝牙模块-设置波特率</strong></p>
<p>如图先把蓝牙模块通过USB-TTL模块相连接，然后</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230108124818109.png" alt="image-20230108124818109"></p>
<p>如果反复测试不能进入AT模式，可能是新版蓝牙模块，</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230108140057987.png" alt="image-20230108140057987"></p>
<ol>
<li><p>先连接好蓝牙模块的几根线，然后按住蓝牙模块的按键</p>
</li>
<li><p>然后连接电脑，然后几秒后蓝牙小灯慢闪，说明进入AT模式</p>
</li>
<li><p>然后串口助手通过38400发送设置指令:AT+UART=115200,0,0</p>
</li>
<li><p>然后收到OK数据，说明设置成功。</p>
</li>
</ol>
<p>这个是设置波特率截图</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221114120715660.png" alt="image-20221114120715660"></p>
<ol>
<li><p>然后重新拔插蓝牙模块(不用按按键)</p>
</li>
<li><p>在手机系统蓝牙配对HC-50 密码1234</p>
</li>
<li><p>串口助手设置波特率115200，然后打开手机APP发送任意内容测试</p>
</li>
</ol>
<p>这个是后面通信测试截图</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221114125011810.png" alt="image-20221114125011810"></p>
<ol>
<li>设置按键-按照代码设置按下发送的数据</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230108125417623.png" alt="image-20230108125417623"></p>
<h3 id="蓝牙模块连接单片机"><a href="#蓝牙模块连接单片机" class="headerlink" title="蓝牙模块连接单片机"></a>蓝牙模块连接单片机</h3><p>把蓝牙插入到底板、跳线帽选择蓝牙通信</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221114131242210.png" alt="image-20221114131242210"></p>
<p>按下不同按钮小车会对应控制</p>
<h1 id="第A章-定位程序异常位置"><a href="#第A章-定位程序异常位置" class="headerlink" title="第A章-定位程序异常位置"></a>第A章-定位程序异常位置</h1><p>参考连接:<a target="_blank" rel="noopener" href="https://blog.csdn.net/supermuscleman/article/details/103929606">https://blog.csdn.net/supermuscleman/article/details/103929606</a></p>
<p>程序功能多 代码较多、可能会出现一些异常，如何锁定程序异常位置非常重要</p>
<ol>
<li><p>进入硬件调试-点击全速运行</p>
<p> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221116173624343.png" alt="image-20221116173624343"></p>
<p> 通过LR的值确定当前堆栈使用的PSP或者MSP</p>
<p> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221116173713147.png" alt="image-20221116173713147"></p>
<p> 然后在memory中定位到堆栈地址、然后就找到LR=08000F2D、PC=08000A02</p>
<p> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221116173741022.png" alt="image-20221116173741022"></p>
<p> <strong>Disassembly中,查找定位代码</strong></p>
<p> 在反汇编窗口中点击右键，选中show disassembly at address 。</p>
<p> 输入LR地址：为发生异常后调用的下一条指令的地址，可看到发生异常的为</p>
<p> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221116173813090.png" alt="image-20221116173813090"></p>
<p> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221116173845927.png" alt="image-20221116173845927"></p>
<p>  输入PC地址：可以定位到发生异常的调用语句</p>
<p> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221116173915126.png" alt="image-20221116173915126"></p>
</li>
</ol>
<p>然后我们通过上面的方法就找到了异常位置</p>
<h1 id="第15章-超声波避障功能"><a href="#第15章-超声波避障功能" class="headerlink" title="第15章-超声波避障功能"></a>第15章-超声波避障功能</h1><h2 id="15-1-超声波测距"><a href="#15-1-超声波测距" class="headerlink" title="15.1-超声波测距"></a>15.1-超声波测距</h2><p>完成超声波测距功能、测量数据显示在OLED屏幕上</p>
<p><strong>硬件介绍</strong></p>
<p>使用：HC-SR04 超声波测距模块 </p>
<p>注意： 绘制PCB注意四个引脚顺序 Vcc Trig Echo Gnd</p>
<p> 供电3.3V-5V(最好5V)</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221114164857506.png" alt="image-20221114164857506" style="zoom:50%;" /></p>
<p>测距原理</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221114164920111.png" alt="image-20221114164920111" style="zoom:50%;" /></p>
<p>不同模式</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221114164940804.png" alt="image-20221114164940804" style="zoom:50%;" /></p>
<p>GPIO模式</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221114165014422.png" alt="image-20221114165014422" style="zoom: 67%;" /></p>
<p> <strong>查看原理图</strong></p>
<p>通过超声波的硬件介绍我们知道</p>
<p> MCU给Trig脚一个大于10us的高电平脉冲；然后读取Echo脚的高电平信号时间，通过公式：距离 = T* 声速/2 就可以算出来距离。</p>
<p>Trig(PB5)我们配置为GPIO输出</p>
<p>Echo(PA6)我们配置GPIO输入功能</p>
<p><strong>注：这里大家可能会问，为什么不使用定时器捕获功能？</strong></p>
<p><strong>原因:</strong></p>
<ol>
<li>留一个定时器 方便以后扩展FreeRTOS使用</li>
<li>或者扩展其他舵机、电机等</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221114165508600.png" alt="image-20221114165508600"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230108171955643.png" alt="image-20230108171955643" style="zoom: 67%;" /></p>
<p><strong>软件初始化</strong></p>
<p>设置PB5输出模式然后起别名</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221114195822786.png" alt="image-20221114195822786"></p>
<p>设置PA6输入模式、</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221114195850027.png" alt="image-20221114195850027"></p>
<p>然后生成代码</p>
<p>自己新建HC_SR04.c和HC_SR04.h 然后加入工程，指定路径</p>
<p>防止溢出 把之前使用的数组调整大一些</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230108180914033.png" alt="image-20230108180914033"></p>
<p>因为我们不适用定时器所以我们需要自己写一个us级延时函数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221115164450164.png" alt="image-20221115164450164"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*******************</span></span><br><span class="line"><span class="comment">*  @brief  us级延时</span></span><br><span class="line"><span class="comment">*  @param  usdelay:要延时的us时间</span></span><br><span class="line"><span class="comment">*  @return  </span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">*******************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">HC_SR04_Delayus</span><span class="params">(<span class="type">uint32_t</span> usdelay)</span></span><br><span class="line">&#123;</span><br><span class="line">  __IO <span class="type">uint32_t</span> Delay = usdelay * (SystemCoreClock / <span class="number">8U</span> / <span class="number">1000U</span>/<span class="number">1000</span>);<span class="comment">//SystemCoreClock:系统频率</span></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    __NOP();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> (Delay --);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221115165416779.png" alt="image-20221115165416779"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*******************</span></span><br><span class="line"><span class="comment">*  @brief  HC_SR04读取超声波距离</span></span><br><span class="line"><span class="comment">*  @param  无</span></span><br><span class="line"><span class="comment">*  @return 障碍物距离单位:cm (静止表面平整精度更高) </span></span><br><span class="line"><span class="comment">*注意:两个HC_SR04_Read()函数调用的时间间隔要2ms及以上，测量范围更大 精度更高 </span></span><br><span class="line"><span class="comment">*******************/</span></span><br><span class="line"><span class="type">float</span> <span class="title function_">HC_SR04_Read</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint32_t</span> i = <span class="number">0</span>;</span><br><span class="line">	<span class="type">float</span> Distance;</span><br><span class="line">	HAL_GPIO_WritePin(HC_SR04_Trig_GPIO_Port,HC_SR04_Trig_Pin,GPIO_PIN_SET);<span class="comment">//输出15us高电平</span></span><br><span class="line">	HC_SR04_Delayus(<span class="number">15</span>);</span><br><span class="line">	HAL_GPIO_WritePin(HC_SR04_Trig_GPIO_Port,HC_SR04_Trig_Pin,GPIO_PIN_RESET);<span class="comment">//高电平输出结束，设置为低电平</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(HAL_GPIO_ReadPin(HC_SR04_Echo_GPIO_Port,HC_SR04_Echo_Pin) == GPIO_PIN_RESET)<span class="comment">//等待回响高电平</span></span><br><span class="line">	&#123;</span><br><span class="line">		i++;</span><br><span class="line">		HC_SR04_Delayus(<span class="number">1</span>);</span><br><span class="line">		<span class="keyword">if</span>(i&gt;<span class="number">100000</span>) <span class="keyword">return</span> <span class="number">-1</span>;<span class="comment">//超时退出循环、防止程序卡死这里</span></span><br><span class="line">	&#125;</span><br><span class="line">	i = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(HAL_GPIO_ReadPin(HC_SR04_Echo_GPIO_Port,HC_SR04_Echo_Pin) == GPIO_PIN_SET)<span class="comment">//下面的循环是2us</span></span><br><span class="line">	&#123;</span><br><span class="line">		i = i+<span class="number">1</span>;</span><br><span class="line">		HC_SR04_Delayus(<span class="number">1</span>);<span class="comment">//1us 延时，但是整个循环大概2us左右</span></span><br><span class="line">		<span class="keyword">if</span>(i &gt;<span class="number">100000</span>) <span class="keyword">return</span> <span class="number">-2</span>;<span class="comment">//超时退出循环</span></span><br><span class="line">	&#125;</span><br><span class="line">	Distance = i*<span class="number">2</span>*<span class="number">0.033</span>/<span class="number">2</span>;<span class="comment">//这里乘2的原因是上面是2微妙</span></span><br><span class="line">	<span class="keyword">return</span> Distance	;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后就可以读距离了、连上蓝牙可以显示数据</p>
<p><strong>注意:两个HC_SR04_Read()函数调用的时间间隔要2ms及以上，测量范围更大 精度更高</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230108182646710.png" alt="image-20230108182646710"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sprintf</span>((<span class="type">char</span> *)Usart3String,<span class="string">&quot;HC_SR04:%.2fcm\r\n&quot;</span>,HC_SR04_Read());<span class="comment">//显示超声波数据</span></span><br><span class="line">HAL_UART_Transmit(&amp;huart3,( <span class="type">uint8_t</span> *)Usart3String,<span class="built_in">strlen</span>(( <span class="type">const</span>  <span class="type">char</span>  *)Usart3String),<span class="number">0xFFFF</span>);<span class="comment">//通过串口三输出字符 strlen:计算字符串大小	</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>然后把我们的手机蓝牙和小车蓝牙连接</p>
<p>手机显示</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230108182544348.png" alt="image-20230108182544348" style="zoom:33%;" /></p>
<h2 id="15-2-避障逻辑编写"><a href="#15-2-避障逻辑编写" class="headerlink" title="15.2-避障逻辑编写"></a>15.2-避障逻辑编写</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221203220125504.png" alt="image-20221203220125504" style="zoom: 67%;" /></p>
<p>然后我们编写循迹逻辑，我们的逻辑时</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230109001446486.png" alt="image-20230109001446486"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//**************避障功能********************//</span></span><br><span class="line"><span class="comment">//避障逻辑</span></span><br><span class="line">	<span class="keyword">if</span>(HC_SR04_Read() &gt; <span class="number">25</span>)<span class="comment">//前方无障碍物</span></span><br><span class="line">	&#123;</span><br><span class="line">		motorPidSetSpeed(<span class="number">1</span>,<span class="number">1</span>);<span class="comment">//前运动</span></span><br><span class="line">		HAL_Delay(<span class="number">100</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;	<span class="comment">//前方有障碍物</span></span><br><span class="line">		motorPidSetSpeed(<span class="number">-1</span>,<span class="number">1</span>);<span class="comment">//右边运动 原地	</span></span><br><span class="line">		HAL_Delay(<span class="number">500</span>);</span><br><span class="line">		<span class="keyword">if</span>(HC_SR04_Read() &gt; <span class="number">25</span>)<span class="comment">//右边无障碍物</span></span><br><span class="line">		&#123;</span><br><span class="line">			motorPidSetSpeed(<span class="number">1</span>,<span class="number">1</span>);<span class="comment">//前运动</span></span><br><span class="line">			HAL_Delay(<span class="number">100</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;<span class="comment">//右边有障碍物</span></span><br><span class="line">			motorPidSetSpeed(<span class="number">1</span>,<span class="number">-1</span>);<span class="comment">//左边运动 原地</span></span><br><span class="line">			HAL_Delay(<span class="number">1000</span>);</span><br><span class="line">			<span class="keyword">if</span>(HC_SR04_Read() &gt;<span class="number">25</span>)<span class="comment">//左边无障碍物</span></span><br><span class="line">			&#123;</span><br><span class="line">				 motorPidSetSpeed(<span class="number">1</span>,<span class="number">1</span>);<span class="comment">//前运动</span></span><br><span class="line">				HAL_Delay(<span class="number">100</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span>&#123;</span><br><span class="line">				motorPidSetSpeed(<span class="number">-1</span>,<span class="number">-1</span>);<span class="comment">//后运动</span></span><br><span class="line">				HAL_Delay(<span class="number">1000</span>);</span><br><span class="line">				motorPidSetSpeed(<span class="number">-1</span>,<span class="number">1</span>);<span class="comment">//右边运动</span></span><br><span class="line">				HAL_Delay(<span class="number">50</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h1 id="第16章-超声波跟随功能"><a href="#第16章-超声波跟随功能" class="headerlink" title="第16章-超声波跟随功能"></a>第16章-超声波跟随功能</h1><h2 id="无PID跟随功能"><a href="#无PID跟随功能" class="headerlink" title="无PID跟随功能"></a>无PID跟随功能</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221203220330848.png" alt="image-20221203220330848"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230109013951233.png" alt="image-20230109013951233"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//超声波跟随</span></span><br><span class="line">	<span class="keyword">if</span>(HC_SR04_Read() &gt; <span class="number">25</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		motorForward();<span class="comment">//前进</span></span><br><span class="line">		HAL_Delay(<span class="number">100</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(HC_SR04_Read() &lt; <span class="number">20</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		motorBackward();<span class="comment">//后退</span></span><br><span class="line">		HAL_Delay(<span class="number">100</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h2 id="PID跟随功能"><a href="#PID跟随功能" class="headerlink" title="PID跟随功能"></a>PID跟随功能</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230111101326946.png" alt="image-20230111101326946"></p>
<p>在pid.c中定义一组PID参数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tPid pidFollow;    <span class="comment">//定距离跟随PID</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pidFollow.actual_val=<span class="number">0.0</span>;</span><br><span class="line">pidFollow.target_val=<span class="number">22.50</span>;<span class="comment">//定距离跟随 目标距离22.5cm</span></span><br><span class="line">pidFollow.err=<span class="number">0.0</span>;</span><br><span class="line">pidFollow.err_last=<span class="number">0.0</span>;</span><br><span class="line">pidFollow.err_sum=<span class="number">0.0</span>;</span><br><span class="line">pidFollow.Kp=<span class="number">-0.5</span>;<span class="comment">//定距离跟随的Kp大小通过估算PID输入输出数据，确定大概大小，然后在调试</span></span><br><span class="line">pidFollow.Ki=<span class="number">-0.001</span>;<span class="comment">//Ki小一些</span></span><br><span class="line">pidFollow.Kd=<span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230109141345691.png" alt="image-20230109141345691"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//**********PID跟随功能***********//</span></span><br><span class="line">    g_fHC_SR04_Read=HC_SR04_Read();<span class="comment">//读取前方障碍物距离</span></span><br><span class="line">	<span class="keyword">if</span>(g_fHC_SR04_Read &lt; <span class="number">60</span>)&#123;  <span class="comment">//如果前60cm 有东西就启动跟随</span></span><br><span class="line">		g_fFollow_PID_Out = PID_realize(&amp;pidFollow,g_fHC_SR04_Read);<span class="comment">//PID计算输出目标速度 这个速度，会和基础速度加减</span></span><br><span class="line">		<span class="keyword">if</span>(g_fFollow_PID_Out &gt; <span class="number">6</span>) g_fFollow_PID_Out = <span class="number">6</span>;<span class="comment">//对输出速度限幅</span></span><br><span class="line">		<span class="keyword">if</span>(g_fFollow_PID_Out &lt; <span class="number">-6</span>) g_fFollow_PID_Out = <span class="number">-6</span>;</span><br><span class="line">		motorPidSetSpeed(g_fFollow_PID_Out,g_fFollow_PID_Out);<span class="comment">//速度作用与电机上</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> motorPidSetSpeed(<span class="number">0</span>,<span class="number">0</span>);<span class="comment">//如果前面60cm 没有东西就停止</span></span><br><span class="line">	HAL_Delay(<span class="number">10</span>);<span class="comment">//读取超声波传感器不能过快</span></span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230109141645038.png" alt="image-20230109141645038"></p>
<p>然后编译，烧录测试 。</p>
<h1 id="第17章-用6050走直线和转90度功能"><a href="#第17章-用6050走直线和转90度功能" class="headerlink" title="第17章-用6050走直线和转90度功能"></a>第17章-用6050走直线和转90度功能</h1><h2 id="17-1-6050姿态数据读取"><a href="#17-1-6050姿态数据读取" class="headerlink" title="17.1-6050姿态数据读取"></a>17.1-6050姿态数据读取</h2><h3 id="STM32读取6050数据"><a href="#STM32读取6050数据" class="headerlink" title="STM32读取6050数据"></a>STM32读取6050数据</h3><p>先把我们的参考历程里面的6050文件复制过去</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230109185706496.png" alt="image-20230109185706496"></p>
<p>添加文件</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221116231529074.png" alt="image-20221116231529074"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221117170521769.png" alt="image-20221117170521769"></p>
<p>然后在魔术棒添加上面两个的路径，不再截图了。</p>
<p>简单阅读代码，知道 我们需要设置两个引脚，这两个引脚使用模拟IIC读取6050数据</p>
<p>1.在<strong>mpuiic.c</strong>延时使用自己写的、引脚需要使用两个先设置推挽输出、高电平</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221116232049948.png" alt="image-20221116232049948"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">mpuiic_Delayus</span><span class="params">(<span class="type">uint32_t</span> usdelay)</span></span><br><span class="line">&#123;</span><br><span class="line">  __IO <span class="type">uint32_t</span> Delay = usdelay * (SystemCoreClock /<span class="number">8U</span>/<span class="number">1000U</span>/<span class="number">1000</span>);<span class="comment">//SystemCoreClock:系统频率</span></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    __NOP();<span class="comment">//使用空指令延时、移植不同单片机注意__NOP(); 执行时间</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> (Delay --);</span><br><span class="line">&#125;</span><br><span class="line">  <span class="comment">//MPU IIC 延时函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">MPU_IIC_Delay</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	mpuiic_Delayus(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化IIC</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">MPU_IIC_Init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;					     </span><br><span class="line"><span class="comment">//  GPIO_InitTypeDef  GPIO_InitStructure;</span></span><br><span class="line"><span class="comment">//	</span></span><br><span class="line"><span class="comment">//	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB,ENABLE);//先使能外设IO PORTB时钟 </span></span><br><span class="line"><span class="comment">//		</span></span><br><span class="line"><span class="comment">//  GPIO_InitStructure.GPIO_Pin = GPIO_Pin_10|GPIO_Pin_11;	 // 端口配置</span></span><br><span class="line"><span class="comment">//  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP; 		 //推挽输出</span></span><br><span class="line"><span class="comment">//  GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;		 //IO口速度为50MHz</span></span><br><span class="line"><span class="comment">//  GPIO_Init(GPIOB, &amp;GPIO_InitStructure);					 //根据设定参数初始化GPIO </span></span><br><span class="line"><span class="comment">//	</span></span><br><span class="line"><span class="comment">//  GPIO_SetBits(GPIOB,GPIO_Pin_10|GPIO_Pin_11);						 //PB10,PB11 输出高	</span></span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用软件初始化两个引脚</p>
<p><strong>6050_SDA—PB9</strong></p>
<p><strong>6050_SCL—PB8</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221116232525601.png" alt="image-20221116232525601" style="zoom: 67%;" /></p>
<p><strong>PB8-输出模式-起始输出高电平</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221117172343943.png" alt="image-20221117172343943"></p>
<p><strong>PB9 输出模式 起始状态高电平</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221117172405281.png" alt="image-20221117172405281"></p>
<p>生成代码</p>
<p><strong>打开我们的代码，是通过模拟IIC 读取6050数据的，我们知道SDA是模拟IIC的数据线 所以通信过程中是再输入和输出模式中切换的，但是我们的STM32CubeMX是设置的输出，是在哪里更改的模式那？</strong></p>
<p><strong>是通过寄存器设置的，在mpuiic.h可以看到</strong></p>
<p>删除掉#include “sys.h”</p>
<p>把这个修改了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221116233155491.png" alt="image-20221116233155491"></p>
<p>2.在<strong>mpuiic.h</strong>更改相内容</p>
<p>改成下面这样的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230109224033045.png" alt="image-20230109224033045"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//IO方向设置 设置SDA-PB9为输入或者输出</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MPU_SDA_IN()  &#123;GPIOB-&gt;CRH&amp;=0XFFFFFF0F;GPIOB-&gt;CRH|=8&lt;&lt;4;&#125;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MPU_SDA_OUT() &#123;GPIOB-&gt;CRH&amp;=0XFFFFFF0F;GPIOB-&gt;CRH|=3&lt;&lt;4;&#125;</span></span><br></pre></td></tr></table></figure>
<ol>
<li><p>这是通过<strong>按位与后赋值 &amp;=</strong> 和 <strong>按位或后赋值 |=</strong> </p>
</li>
<li><p>设置<strong>端口配置高寄存器</strong>指定位。</p>
</li>
</ol>
<p>先看一个例子</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230110094443036.png" alt="image-20230110094443036"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230110000816677.png" alt="image-20230110000816677"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221117133006922.png" alt="image-20221117133006922"></p>
<p>更改设置SDA与SCL电平的宏</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221117143405668.png" alt="image-20221117143405668"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//IO操作函数	 </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MPU_IIC_SCL_Hige    	HAL_GPIO_WritePin(SCL_6050_GPIO_Port,SCL_6050_Pin,GPIO_PIN_SET)<span class="comment">//设置SCL高电平</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MPU_IIC_SCL_Low      	HAL_GPIO_WritePin(SCL_6050_GPIO_Port,SCL_6050_Pin,GPIO_PIN_RESET)<span class="comment">//设置SCL低电平</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MPU_IIC_SDA_Hige        HAL_GPIO_WritePin(SDA_6050_GPIO_Port,SDA_6050_Pin,GPIO_PIN_SET)   <span class="comment">//设置SDA高电平</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MPU_IIC_SDA_Low         HAL_GPIO_WritePin(SDA_6050_GPIO_Port,SDA_6050_Pin,GPIO_PIN_RESET) <span class="comment">//设置SDA低电平</span></span></span><br><span class="line">  	 </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MPU_READ_SDA            HAL_GPIO_ReadPin(SDA_6050_GPIO_Port,SDA_6050_Pin)    <span class="comment">//读SDA电平</span></span></span><br></pre></td></tr></table></figure>
<p><strong>更改一下 mupiic.c文件</strong>  </p>
<p>把</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//把之前的MPU_IIC_SDA=1;	 换成 MPU_IIC_SDA_Hige;</span></span><br><span class="line"><span class="comment">//MPU_IIC_SDA=0;	 换成 MPU_IIC_SDA_Low;</span></span><br><span class="line"><span class="comment">//MPU_IIC_SCL=1;  换成 MPU_IIC_SCL_Hige;</span></span><br><span class="line"><span class="comment">//MPU_IIC_SCL=0;  换成 MPU_IIC_SCL_Low;</span></span><br><span class="line"><span class="comment">//</span></span><br></pre></td></tr></table></figure>
<p>编译一下、删掉没有用的文件</p>
<p>把u8 替换为uint8_t</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221117144658042.png" alt="image-20221117144658042"></p>
<p>t替换一下，u8 替换为uint8_t  u32替换为uint32_t </p>
<p>可以一个文件一个文件的替换掉，如果整个工程替换其他HAL库文件内容也可能改变了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221117144918696.png" alt="image-20221117144918696"></p>
<p>删除多余的库文件</p>
<p>注释掉</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221117164409292.png" alt="image-20221117164409292"></p>
<p><strong>如果有其他的delay_ms 都替换为HAL_Delay</strong></p>
<p>还有一个错误</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>((txd&amp;<span class="number">0x80</span>)&gt;&gt;<span class="number">7</span>) MPU_IIC_SDA_Hige;</span><br><span class="line"><span class="keyword">else</span> MPU_IIC_SDA_Low;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221117164701076.png" alt="image-20221117164701076"></p>
<p>编译一下 、没有错误和警告</p>
<p>然后在main.c中定义变量和添加同文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span> pitch,roll,yaw; <span class="comment">// 俯仰角 横滚角 航向角</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;mpu6050.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;inv_mpu.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;inv_mpu_dmp_motion_driver.h&quot;</span> </span></span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221117165511717.png" alt="image-20221117165511717"></p>
<p>替换inv_mpu.h的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;stm32f1xx_it.h&quot;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221117165920050.png" alt="image-20221117165920050"></p>
<p>初始化6050</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HAL_Delay(<span class="number">500</span>);<span class="comment">//延时0.5秒 6050上电稳定后初始化</span></span><br><span class="line">MPU_Init(); <span class="comment">//初始化MPU6050</span></span><br><span class="line"><span class="keyword">while</span>(MPU_Init()!=<span class="number">0</span>);</span><br><span class="line"><span class="keyword">while</span>(mpu_dmp_init()!=<span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230109213955121.png" alt="image-20230109213955121"></p>
<p>我们通过下面的代码获得数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  	<span class="built_in">sprintf</span>((<span class="type">char</span> *)Usart3String,<span class="string">&quot;pitch:%.2f roll:%.2f yaw:%.2f\r\n&quot;</span>,pitch,roll,yaw);<span class="comment">//显示6050数据</span></span><br><span class="line">HAL_UART_Transmit(&amp;huart3,( <span class="type">uint8_t</span> *)Usart3String,<span class="built_in">strlen</span>(( <span class="type">const</span>  <span class="type">char</span>  *)Usart3String),<span class="number">0xFFFF</span>);<span class="comment">//通过串口三输出字符 strlen:计算字符串大小	</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">//mpu_dmp_get_data(&amp;pitch,&amp;roll,&amp;yaw);//返回值:0,DMP成功解出欧拉角</span></span><br><span class="line">   <span class="keyword">while</span>(mpu_dmp_get_data(&amp;pitch,&amp;roll,&amp;yaw)!=<span class="number">0</span>)&#123;&#125;  <span class="comment">//这个可以解决经常读不出数据的问题</span></span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230109214556197.png" alt="image-20230109214556197"></p>
<p>然后我看一下 这个Usart3String 现在发送的大概多大的？</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230109215719786.png" alt="image-20230109215719786"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint8_t</span> OledString[<span class="number">50</span>];</span><br><span class="line"><span class="type">uint8_t</span> Usart3String[<span class="number">50</span>];</span><br></pre></td></tr></table></figure>
<p>编译、烧录、然后就可以连接手机蓝牙，在蓝牙软件查看数据了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230109225000072.png" alt="image-20230109225000072" style="zoom:50%;" /></p>
<h2 id="17-2-利用6050直线和90度-有代码"><a href="#17-2-利用6050直线和90度-有代码" class="headerlink" title="17.2-利用6050直线和90度(有代码)"></a>17.2-利用6050直线和90度(有代码)</h2><p><strong>为什么小车还是不能走直线</strong></p>
<p>为什么两个电机转速一样不能走非常正直线，如何控制小车转弯90度。</p>
<p>当然，我们可以开环控制，但是控制效果可能不好，受外界影响比较大。</p>
<p>如果我们使用闭环控制，就要使用一个传感器来获得现在小车角度。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221203222808445.png" alt="image-20221203222808445"></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1UV4y1p7Hd/?spm_id_from=333.337.search-card.all.click">https://www.bilibili.com/video/BV1UV4y1p7Hd/?spm_id_from=333.337.search-card.all.click</a></p>
<h3 id="走直线-控制朝一个方向运动"><a href="#走直线-控制朝一个方向运动" class="headerlink" title="走直线(控制朝一个方向运动)"></a>走直线(控制朝一个方向运动)</h3><p>在pid.c中定义一个姿态控制使用的PID</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230110160756280.png" alt="image-20230110160756280"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tPid pidMPU6050YawMovement;  <span class="comment">//利用6050偏航角 进行姿态控制的PID</span></span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230110163152585.png" alt="image-20230110163152585"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pidMPU6050YawMovement.actual_val=<span class="number">0.0</span>;</span><br><span class="line">pidMPU6050YawMovement.target_val=<span class="number">0.00</span>;<span class="comment">//设定姿态目标值</span></span><br><span class="line">pidMPU6050YawMovement.err=<span class="number">0.0</span>;</span><br><span class="line">pidMPU6050YawMovement.err_last=<span class="number">0.0</span>;</span><br><span class="line">pidMPU6050YawMovement.err_sum=<span class="number">0.0</span>;</span><br><span class="line">pidMPU6050YawMovement.Kp=<span class="number">2</span>;<span class="comment">//定距离跟随的Kp大小通过估算PID输入输出数据，确定大概大小，然后在调试</span></span><br><span class="line">pidMPU6050YawMovement.Ki=<span class="number">0</span>;</span><br><span class="line">pidMPU6050YawMovement.Kd=<span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>仿照之前红外循迹代码编写姿态控制函数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230110163514918.png" alt="image-20230110163514918"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span>  g_fMPU6050YawMovePidOut = <span class="number">0.00f</span>; <span class="comment">//姿态PID运算输出</span></span><br><span class="line"><span class="type">float</span>  g_fMPU6050YawMovePidOut1 = <span class="number">0.00f</span>; <span class="comment">//第一个电机控制输出</span></span><br><span class="line"><span class="type">float</span>  g_fMPU6050YawMovePidOut2 = <span class="number">0.00f</span>; <span class="comment">//第一个电机控制输出</span></span><br></pre></td></tr></table></figure>
<p>走直线程序如下(因为上电初始化时候航向角是0、而且pidMPU6050YawMovementPID结构体的目标值target_val 也是0)</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230110165825685.png" alt="image-20230110165825685"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//*************MPU6050航向角 PID转向控制*****************//</span></span><br><span class="line"></span><br><span class="line">   	<span class="built_in">sprintf</span>((<span class="type">char</span> *)Usart3String,<span class="string">&quot;pitch:%.2f roll:%.2f yaw:%.2f\r\n&quot;</span>,pitch,roll,yaw);<span class="comment">//显示6050数据 俯仰角 横滚角 航向角</span></span><br><span class="line">	HAL_UART_Transmit(&amp;huart3,( <span class="type">uint8_t</span> *)Usart3String,<span class="built_in">strlen</span>(( <span class="type">const</span>  <span class="type">char</span>  *)Usart3String),<span class="number">0xFFFF</span>);<span class="comment">//通过串口三输出字符 strlen:计算字符串大小	</span></span><br><span class="line">   </span><br><span class="line">   <span class="comment">//mpu_dmp_get_data(&amp;pitch,&amp;roll,&amp;yaw);//返回值:0,DMP成功解出欧拉角</span></span><br><span class="line">    <span class="keyword">while</span>(mpu_dmp_get_data(&amp;pitch,&amp;roll,&amp;yaw)!=<span class="number">0</span>)&#123;&#125;  <span class="comment">//这个可以解决经常读不出数据的问题</span></span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	g_fMPU6050YawMovePidOut = PID_realize(&amp;pidMPU6050YawMovement,yaw);<span class="comment">//PID计算输出目标速度 这个速度，会和基础速度加减</span></span><br><span class="line"></span><br><span class="line">	g_fMPU6050YawMovePidOut1 = <span class="number">1.5</span> + g_fMPU6050YawMovePidOut;<span class="comment">//基础速度加减PID输出速度</span></span><br><span class="line">	g_fMPU6050YawMovePidOut2 = <span class="number">1.5</span> - g_fMPU6050YawMovePidOut;</span><br><span class="line">	<span class="keyword">if</span>(g_fMPU6050YawMovePidOut1 &gt;<span class="number">3.5</span>) g_fMPU6050YawMovePidOut1 =<span class="number">3.5</span>;<span class="comment">//进行限幅</span></span><br><span class="line">	<span class="keyword">if</span>(g_fMPU6050YawMovePidOut1 &lt;<span class="number">0</span>) g_fMPU6050YawMovePidOut1 =<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(g_fMPU6050YawMovePidOut2 &gt;<span class="number">3.5</span>) g_fMPU6050YawMovePidOut2 =<span class="number">3.5</span>;</span><br><span class="line">	<span class="keyword">if</span>(g_fMPU6050YawMovePidOut2 &lt;<span class="number">0</span>) g_fMPU6050YawMovePidOut2 =<span class="number">0</span>;</span><br><span class="line">	motorPidSetSpeed(g_fMPU6050YawMovePidOut1,g_fMPU6050YawMovePidOut2);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>然后调节PID参数</p>
<p>顺序 先确定P 正负 然后P大小 </p>
<p>然后D正负 然后D大小</p>
<p>最后调节的参数如下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230110170011105.png" alt="image-20230110170011105"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pidMPU6050YawMovement.Kp=<span class="number">0.02</span>;<span class="comment">//6050航向角PID运动控制 </span></span><br><span class="line">pidMPU6050YawMovement.Ki=<span class="number">0</span>;</span><br><span class="line">pidMPU6050YawMovement.Kd=<span class="number">0.1</span>;</span><br></pre></td></tr></table></figure>
<p>然后我们把小车放在地上就可以完成一直朝着初始方向前进，如果往侧面推也会马上矫正。</p>
<h3 id="转弯90度功能-控制转弯角度"><a href="#转弯90度功能-控制转弯角度" class="headerlink" title="转弯90度功能(控制转弯角度)"></a>转弯90度功能(控制转弯角度)</h3><p>然后我们增加一下，如何旋转90度程序</p>
<p>在串口接收回调函数表姿态PID的目标值</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230110184914912.png" alt="image-20230110184914912"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> tPid pidMPU6050YawMovement;  <span class="comment">//利用6050偏航角 进行姿态控制的PID</span></span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230110185214565.png" alt="image-20230110185214565"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(g_ucUsart3ReceiveData == <span class="string">&#x27;H&#x27;</span>)<span class="comment">//转向90度</span></span><br><span class="line">&#123;				</span><br><span class="line">	<span class="keyword">if</span>(pidMPU6050YawMovement.target_val &lt;= <span class="number">180</span>)pidMPU6050YawMovement.target_val += <span class="number">90</span>;<span class="comment">//目标值</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(g_ucUsart3ReceiveData == <span class="string">&#x27;I&#x27;</span>)<span class="comment">//转回90度</span></span><br><span class="line">&#123;				</span><br><span class="line">	<span class="keyword">if</span>(pidMPU6050YawMovement.target_val &gt;= <span class="number">-180</span>)pidMPU6050YawMovement.target_val -= <span class="number">90</span>;<span class="comment">//目标值</span></span><br><span class="line">      &#125;	</span><br></pre></td></tr></table></figure>
<p>然后我们的蓝牙APP增加两个发送按钮的设置</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221117224841058.png" alt="image-20221117224841058"></p>
<p>现象 是上电小车向初始方向直行，如果推小车车头方向，小车能够立马矫正。</p>
<p>然后连接蓝牙发送转90度 小车会转90度，按下 转回90度小车回转回。</p>
<h1 id="第18章-综合以上功能"><a href="#第18章-综合以上功能" class="headerlink" title="第18章-综合以上功能"></a>第18章-综合以上功能</h1><h2 id="18-按键和app按钮切换功能"><a href="#18-按键和app按钮切换功能" class="headerlink" title="18-按键和app按钮切换功能"></a>18-按键和app按钮切换功能</h2><p>根据上面介绍，我们的模式可以有：</p>
<p><strong>OLED显示模式: 速度、里程、电压、超声波数据、MPU6050俯仰角、横滚角、航向角 数据显示在OLED上和通过串口发送蓝牙APP </strong> </p>
<p><strong>PID循迹模式:红外对管PID循迹</strong></p>
<p><strong>手机遥控普通运动模式:遥控前、后、左、右加速运动</strong></p>
<p><strong>超声波避障模式</strong></p>
<p><strong>PID跟随模式:超声波PID定距离跟随</strong></p>
<p><strong>手机遥控角度闭环模式：MPU6050角度PID控制</strong></p>
<p>可以设置标志位通过按键改变标志位，以实现功能切换。</p>
<p>定义一个全局变量，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint8_t</span> g_ucMode = <span class="number">0</span>; </span><br><span class="line"><span class="comment">//小车运动模式标志位 0:显示功能、1:PID循迹模式、2:手机遥控普通运动模式、3.超声波避障模式、4:PID跟随模式、5:遥控角度闭环</span></span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230111120620970.png" alt="image-20230111120620970"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint8_t</span> g_ucMode = <span class="number">0</span>; <span class="comment">//小车运动模式标志位</span></span><br></pre></td></tr></table></figure>
<p>在gpio.h声明一下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230111120725049.png" alt="image-20230111120725049"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">uint8_t</span> g_ucMode ; <span class="comment">//小车运动模式标志位</span></span><br></pre></td></tr></table></figure>
<p>按键中断回调函数里面补充按下按键后的处理</p>
<p>先不进行消抖，如果后面KEY1 KEY2效果不好再消抖</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230111123626386.png" alt="image-20230111123626386"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">HAL_GPIO_EXTI_Callback</span><span class="params">(<span class="type">uint16_t</span> GPIO_Pin)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(GPIO_Pin == KEY1_Pin) <span class="comment">//判断一下那个引脚触发中断</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//这里编写触发中断后要执行的程序</span></span><br><span class="line">		<span class="keyword">if</span>(g_ucMode == <span class="number">5</span>) g_ucMode = <span class="number">1</span>;<span class="comment">//g_ucMode模式是0 1 2 3 4 5 </span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			g_ucMode+=<span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		HAL_GPIO_TogglePin(LED_GPIO_Port,LED_Pin);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(GPIO_Pin == KEY2_Pin) <span class="comment">//判断一下那个引脚触发中断</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//这里编写触发中断后要执行的程序</span></span><br><span class="line">		g_ucMode=<span class="number">0</span>;</span><br><span class="line">		HAL_GPIO_TogglePin(LED_GPIO_Port,LED_Pin);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后主函数显示当前处于的模式</p>
<p>然后判断当前模式 执行不同代码</p>
<p>方法：一个功能一个功能的添加代码，添加好一个调试测试一下，然后再添加下一个</p>
<p>下面这个就是我们主函数的代码。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line">	<span class="built_in">sprintf</span>((<span class="type">char</span> *)OledString,<span class="string">&quot; g_ucMode:%d&quot;</span>,g_ucMode);<span class="comment">//显示g_ucMode 当前模式</span></span><br><span class="line">	OLED_ShowString(<span class="number">0</span>,<span class="number">6</span>,OledString,<span class="number">12</span>);	<span class="comment">//显示在OLED上</span></span><br><span class="line">	</span><br><span class="line">	<span class="built_in">sprintf</span>((<span class="type">char</span> *)Usart3String,<span class="string">&quot; g_ucMode:%d&quot;</span>,g_ucMode);<span class="comment">//蓝牙APP显示</span></span><br><span class="line">	HAL_UART_Transmit(&amp;huart3,( <span class="type">uint8_t</span> *)Usart3String,<span class="built_in">strlen</span>(( <span class="type">const</span>  <span class="type">char</span>  *)Usart3String),<span class="number">50</span>);<span class="comment">//阻塞式发送通过串口三输出字符 strlen:计算字符串大小</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(g_ucMode == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="comment">//0LED显示功能</span></span><br><span class="line">		<span class="built_in">sprintf</span>((<span class="type">char</span>*)OledString, <span class="string">&quot;V1:%.2fV2:%.2f&quot;</span>, Motor1Speed,Motor2Speed);<span class="comment">//显示速度</span></span><br><span class="line">		OLED_ShowString(<span class="number">0</span>,<span class="number">0</span>,OledString,<span class="number">12</span>);<span class="comment">//这个是oled驱动里面的，是显示位置的一个函数，</span></span><br><span class="line">		</span><br><span class="line">		<span class="built_in">sprintf</span>((<span class="type">char</span>*)OledString, <span class="string">&quot;Mileage:%.2f&quot;</span>, Mileage);<span class="comment">//显示里程</span></span><br><span class="line">		OLED_ShowString(<span class="number">0</span>,<span class="number">1</span>,OledString,<span class="number">12</span>);<span class="comment">//这个是oled驱动里面的，是显示位置的一个函数，</span></span><br><span class="line">		</span><br><span class="line">		<span class="built_in">sprintf</span>((<span class="type">char</span>*)OledString, <span class="string">&quot;U:%.2fV&quot;</span>, adcGetBatteryVoltage());<span class="comment">//显示电池电压</span></span><br><span class="line">		OLED_ShowString(<span class="number">0</span>,<span class="number">2</span>,OledString,<span class="number">12</span>);<span class="comment">//这个是oled驱动里面的，是显示位置的一个函数，</span></span><br><span class="line">		</span><br><span class="line">		<span class="built_in">sprintf</span>((<span class="type">char</span> *)OledString,<span class="string">&quot;HC_SR04:%.2fcm\r\n&quot;</span>,HC_SR04_Read());<span class="comment">//显示超声波数据</span></span><br><span class="line">		OLED_ShowString(<span class="number">0</span>,<span class="number">3</span>,OledString,<span class="number">12</span>);<span class="comment">//这个是oled驱动里面的，是显示位置的一个函数，</span></span><br><span class="line">		</span><br><span class="line">		<span class="built_in">sprintf</span>((<span class="type">char</span> *)OledString,<span class="string">&quot;p:%.2f r:%.2f \r\n&quot;</span>,pitch,roll);<span class="comment">//显示6050数据 俯仰角 横滚角</span></span><br><span class="line">		OLED_ShowString(<span class="number">0</span>,<span class="number">4</span>,OledString,<span class="number">12</span>);<span class="comment">//这个是oled驱动里面的，是显示位置的一个函数，</span></span><br><span class="line">		</span><br><span class="line">		<span class="built_in">sprintf</span>((<span class="type">char</span> *)OledString,<span class="string">&quot;y:%.2f  \r\n&quot;</span>,yaw);<span class="comment">//显示6050数据  航向角</span></span><br><span class="line">		OLED_ShowString(<span class="number">0</span>,<span class="number">5</span>,OledString,<span class="number">12</span>);<span class="comment">//这个是oled驱动里面的，是显示位置的一个函数，</span></span><br><span class="line">		</span><br><span class="line">	<span class="comment">//蓝牙APP显示</span></span><br><span class="line">		<span class="built_in">sprintf</span>((<span class="type">char</span>*)Usart3String, <span class="string">&quot;V1:%.2fV2:%.2f&quot;</span>, Motor1Speed,Motor2Speed);<span class="comment">//显示速度</span></span><br><span class="line">		HAL_UART_Transmit(&amp;huart3,( <span class="type">uint8_t</span> *)Usart3String,<span class="built_in">strlen</span>(( <span class="type">const</span>  <span class="type">char</span>  *)Usart3String),<span class="number">50</span>);<span class="comment">//阻塞式发送通过串口三输出字符 strlen:计算字符串大小</span></span><br><span class="line">		<span class="comment">//阻塞方式发送可以保证数据发送完毕，中断发送不一定可以保证数据已经发送完毕才启动下一次发送</span></span><br><span class="line">		<span class="built_in">sprintf</span>((<span class="type">char</span>*)Usart3String, <span class="string">&quot;Mileage:%.2f&quot;</span>, Mileage);<span class="comment">//显示里程</span></span><br><span class="line">		HAL_UART_Transmit(&amp;huart3,( <span class="type">uint8_t</span> *)Usart3String,<span class="built_in">strlen</span>(( <span class="type">const</span>  <span class="type">char</span>  *)Usart3String),<span class="number">50</span>);<span class="comment">//阻塞式发送通过串口三输出字符 strlen:计算字符串大小</span></span><br><span class="line">		</span><br><span class="line">		<span class="built_in">sprintf</span>((<span class="type">char</span>*)Usart3String, <span class="string">&quot;U:%.2fV&quot;</span>, adcGetBatteryVoltage());<span class="comment">//显示电池电压</span></span><br><span class="line">		HAL_UART_Transmit(&amp;huart3,( <span class="type">uint8_t</span> *)Usart3String,<span class="built_in">strlen</span>(( <span class="type">const</span>  <span class="type">char</span>  *)Usart3String),<span class="number">50</span>);<span class="comment">//阻塞式发送通过串口三输出字符 strlen:计算字符串大小</span></span><br><span class="line">		</span><br><span class="line">		<span class="built_in">sprintf</span>((<span class="type">char</span> *)Usart3String,<span class="string">&quot;HC_SR04:%.2fcm\r\n&quot;</span>,HC_SR04_Read());<span class="comment">//显示超声波数据</span></span><br><span class="line">		HAL_UART_Transmit(&amp;huart3,( <span class="type">uint8_t</span> *)Usart3String,<span class="built_in">strlen</span>(( <span class="type">const</span>  <span class="type">char</span>  *)Usart3String),<span class="number">50</span>);<span class="comment">//阻塞式发送通过串口三输出字符 strlen:计算字符串大小</span></span><br><span class="line">		</span><br><span class="line">		<span class="built_in">sprintf</span>((<span class="type">char</span> *)Usart3String,<span class="string">&quot;p:%.2f r:%.2f \r\n&quot;</span>,pitch,roll);<span class="comment">//显示6050数据 俯仰角 横滚角</span></span><br><span class="line">		HAL_UART_Transmit(&amp;huart3,( <span class="type">uint8_t</span> *)Usart3String,<span class="built_in">strlen</span>(( <span class="type">const</span>  <span class="type">char</span>  *)Usart3String),<span class="number">50</span>);<span class="comment">//阻塞式发送通过串口三输出字符 strlen:计算字符串大小</span></span><br><span class="line">		</span><br><span class="line">		<span class="built_in">sprintf</span>((<span class="type">char</span> *)Usart3String,<span class="string">&quot;y:%.2f  \r\n&quot;</span>,yaw);<span class="comment">//显示6050数据  航向角</span></span><br><span class="line">		HAL_UART_Transmit(&amp;huart3,( <span class="type">uint8_t</span> *)Usart3String,<span class="built_in">strlen</span>(( <span class="type">const</span>  <span class="type">char</span>  *)Usart3String),<span class="number">50</span>);<span class="comment">//阻塞式发送通过串口三输出字符 strlen:计算字符串大小</span></span><br><span class="line">	</span><br><span class="line">		<span class="comment">//获得6050数据</span></span><br><span class="line">		<span class="keyword">while</span>(mpu_dmp_get_data(&amp;pitch,&amp;roll,&amp;yaw)!=<span class="number">0</span>)&#123;&#125;  <span class="comment">//这个可以解决经常读不出数据的问题</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">//显示模式电机停转</span></span><br><span class="line">		motorPidSetSpeed(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(g_ucMode == <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="comment">///****    红外PID循迹功能******************/</span></span><br><span class="line">	g_ucaHW_Read[<span class="number">0</span>] = READ_HW_OUT_1;<span class="comment">//读取红外对管状态、这样相比于写在if里面更高效</span></span><br><span class="line">	g_ucaHW_Read[<span class="number">1</span>] = READ_HW_OUT_2;</span><br><span class="line">	g_ucaHW_Read[<span class="number">2</span>] = READ_HW_OUT_3;</span><br><span class="line">	g_ucaHW_Read[<span class="number">3</span>] = READ_HW_OUT_4;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(g_ucaHW_Read[<span class="number">0</span>] == <span class="number">0</span>&amp;&amp;g_ucaHW_Read[<span class="number">1</span>] == <span class="number">0</span>&amp;&amp;g_ucaHW_Read[<span class="number">2</span>] == <span class="number">0</span>&amp;&amp;g_ucaHW_Read[<span class="number">3</span>] == <span class="number">0</span> )</span><br><span class="line">	&#123;</span><br><span class="line"><span class="comment">//		printf(&quot;应该前进\r\n&quot;);//注释掉更加高效，减少无必要程序执行</span></span><br><span class="line">		g_cThisState = <span class="number">0</span>;<span class="comment">//前进</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(g_ucaHW_Read[<span class="number">0</span>] == <span class="number">0</span>&amp;&amp;g_ucaHW_Read[<span class="number">1</span>] == <span class="number">1</span>&amp;&amp;g_ucaHW_Read[<span class="number">2</span>] == <span class="number">0</span>&amp;&amp;g_ucaHW_Read[<span class="number">3</span>] == <span class="number">0</span> )<span class="comment">//使用else if更加合理高效</span></span><br><span class="line">	&#123;</span><br><span class="line"><span class="comment">//		printf(&quot;应该右转\r\n&quot;);</span></span><br><span class="line">		g_cThisState = <span class="number">-1</span>;<span class="comment">//应该右转</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(g_ucaHW_Read[<span class="number">0</span>] == <span class="number">1</span>&amp;&amp;g_ucaHW_Read[<span class="number">1</span>] == <span class="number">0</span>&amp;&amp;g_ucaHW_Read[<span class="number">2</span>] == <span class="number">0</span>&amp;&amp;g_ucaHW_Read[<span class="number">3</span>] == <span class="number">0</span> )</span><br><span class="line">	&#123;</span><br><span class="line"><span class="comment">//		printf(&quot;快速右转\r\n&quot;);</span></span><br><span class="line">		g_cThisState = <span class="number">-2</span>;<span class="comment">//快速右转</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(g_ucaHW_Read[<span class="number">0</span>] == <span class="number">1</span>&amp;&amp;g_ucaHW_Read[<span class="number">1</span>] == <span class="number">1</span>&amp;&amp;g_ucaHW_Read[<span class="number">2</span>] == <span class="number">0</span>&amp;&amp;g_ucaHW_Read[<span class="number">3</span>] == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line"><span class="comment">//		printf(&quot;快速右转\r\n&quot;);</span></span><br><span class="line">		g_cThisState = <span class="number">-3</span>;<span class="comment">//快速右转</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(g_ucaHW_Read[<span class="number">0</span>] == <span class="number">0</span>&amp;&amp;g_ucaHW_Read[<span class="number">1</span>] == <span class="number">0</span>&amp;&amp;g_ucaHW_Read[<span class="number">2</span>] == <span class="number">1</span>&amp;&amp;g_ucaHW_Read[<span class="number">3</span>] == <span class="number">0</span> )</span><br><span class="line">	&#123;</span><br><span class="line"><span class="comment">//		printf(&quot;应该左转\r\n&quot;);</span></span><br><span class="line">		g_cThisState = <span class="number">1</span>;<span class="comment">//应该左转	</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(g_ucaHW_Read[<span class="number">0</span>] == <span class="number">0</span>&amp;&amp;g_ucaHW_Read[<span class="number">1</span>] == <span class="number">0</span>&amp;&amp;g_ucaHW_Read[<span class="number">2</span>] == <span class="number">0</span>&amp;&amp;g_ucaHW_Read[<span class="number">3</span>] == <span class="number">1</span> )</span><br><span class="line">	&#123;</span><br><span class="line"><span class="comment">//		printf(&quot;快速左转\r\n&quot;);</span></span><br><span class="line">		g_cThisState = <span class="number">2</span>;<span class="comment">//快速左转</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(g_ucaHW_Read[<span class="number">0</span>] == <span class="number">0</span>&amp;&amp;g_ucaHW_Read[<span class="number">1</span>] == <span class="number">0</span>&amp;&amp;g_ucaHW_Read[<span class="number">2</span>] == <span class="number">1</span>&amp;&amp;g_ucaHW_Read[<span class="number">3</span>] == <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line"><span class="comment">//	    printf(&quot;快速左转\r\n&quot;);</span></span><br><span class="line">		g_cThisState = <span class="number">3</span>;<span class="comment">//快速左转</span></span><br><span class="line">	&#125;</span><br><span class="line">	g_fHW_PID_Out = PID_realize(&amp;pidHW_Tracking,g_cThisState);<span class="comment">//PID计算输出目标速度 这个速度，会和基础速度加减</span></span><br><span class="line"></span><br><span class="line">	g_fHW_PID_Out1 = <span class="number">3</span> + g_fHW_PID_Out;<span class="comment">//电机1速度=基础速度+循迹PID输出速度</span></span><br><span class="line">	g_fHW_PID_Out2 = <span class="number">3</span> - g_fHW_PID_Out;<span class="comment">//电机1速度=基础速度-循迹PID输出速度</span></span><br><span class="line">	<span class="keyword">if</span>(g_fHW_PID_Out1 &gt;<span class="number">5</span>) g_fHW_PID_Out1 =<span class="number">5</span>;<span class="comment">//进行限幅 限幅速度在0-5之间</span></span><br><span class="line">	<span class="keyword">if</span>(g_fHW_PID_Out1 &lt;<span class="number">0</span>) g_fHW_PID_Out1 =<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(g_fHW_PID_Out2 &gt;<span class="number">5</span>) g_fHW_PID_Out2 =<span class="number">5</span>;</span><br><span class="line">	<span class="keyword">if</span>(g_fHW_PID_Out2 &lt;<span class="number">0</span>) g_fHW_PID_Out2 =<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(g_cThisState != g_cLastState)<span class="comment">//如何这次状态不等于上次状态、就进行改变目标速度和控制电机、在定时器中依旧定时控制电机</span></span><br><span class="line">	&#123;</span><br><span class="line">		motorPidSetSpeed(g_fHW_PID_Out1,g_fHW_PID_Out2);<span class="comment">//通过计算的速度控制电机</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	g_cLastState = g_cThisState;<span class="comment">//保存上次红外对管状态	</span></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(g_ucMode == <span class="number">2</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//***************遥控模式***********************//</span></span><br><span class="line">		<span class="comment">//遥控模式的控制在串口三的中断里面</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(g_ucMode == <span class="number">3</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//******超声波避障模式*********************//</span></span><br><span class="line"><span class="comment">////避障逻辑</span></span><br><span class="line">		<span class="keyword">if</span>(HC_SR04_Read() &gt; <span class="number">25</span>)<span class="comment">//前方无障碍物</span></span><br><span class="line">		&#123;</span><br><span class="line">			motorPidSetSpeed(<span class="number">1</span>,<span class="number">1</span>);<span class="comment">//前运动</span></span><br><span class="line">			HAL_Delay(<span class="number">100</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;	<span class="comment">//前方有障碍物</span></span><br><span class="line">			motorPidSetSpeed(<span class="number">-1</span>,<span class="number">1</span>);<span class="comment">//右边运动 原地	</span></span><br><span class="line">			HAL_Delay(<span class="number">500</span>);</span><br><span class="line">			<span class="keyword">if</span>(HC_SR04_Read() &gt; <span class="number">25</span>)<span class="comment">//右边无障碍物</span></span><br><span class="line">			&#123;</span><br><span class="line">				motorPidSetSpeed(<span class="number">1</span>,<span class="number">1</span>);<span class="comment">//前运动</span></span><br><span class="line">				HAL_Delay(<span class="number">100</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span>&#123;<span class="comment">//右边有障碍物</span></span><br><span class="line">				motorPidSetSpeed(<span class="number">1</span>,<span class="number">-1</span>);<span class="comment">//左边运动 原地</span></span><br><span class="line">				HAL_Delay(<span class="number">1000</span>);</span><br><span class="line">				<span class="keyword">if</span>(HC_SR04_Read() &gt;<span class="number">25</span>)<span class="comment">//左边无障碍物</span></span><br><span class="line">				&#123;</span><br><span class="line">					 motorPidSetSpeed(<span class="number">1</span>,<span class="number">1</span>);<span class="comment">//前运动</span></span><br><span class="line">					HAL_Delay(<span class="number">100</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span>&#123;</span><br><span class="line">					motorPidSetSpeed(<span class="number">-1</span>,<span class="number">-1</span>);<span class="comment">//后运动</span></span><br><span class="line">					HAL_Delay(<span class="number">1000</span>);</span><br><span class="line">					motorPidSetSpeed(<span class="number">-1</span>,<span class="number">1</span>);<span class="comment">//右边运动</span></span><br><span class="line">					HAL_Delay(<span class="number">50</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(g_ucMode == <span class="number">4</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="comment">//**********PID跟随功能***********//</span></span><br><span class="line">		g_fHC_SR04_Read=HC_SR04_Read();<span class="comment">//读取前方障碍物距离</span></span><br><span class="line">		<span class="keyword">if</span>(g_fHC_SR04_Read &lt; <span class="number">60</span>)&#123;  <span class="comment">//如果前60cm 有东西就启动跟随</span></span><br><span class="line">			g_fFollow_PID_Out = PID_realize(&amp;pidFollow,g_fHC_SR04_Read);<span class="comment">//PID计算输出目标速度 这个速度，会和基础速度加减</span></span><br><span class="line">			<span class="keyword">if</span>(g_fFollow_PID_Out &gt; <span class="number">6</span>) g_fFollow_PID_Out = <span class="number">6</span>;<span class="comment">//对输出速度限幅</span></span><br><span class="line">			<span class="keyword">if</span>(g_fFollow_PID_Out &lt; <span class="number">-6</span>) g_fFollow_PID_Out = <span class="number">-6</span>;</span><br><span class="line">			motorPidSetSpeed(g_fFollow_PID_Out,g_fFollow_PID_Out);<span class="comment">//速度作用与电机上</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> motorPidSetSpeed(<span class="number">0</span>,<span class="number">0</span>);<span class="comment">//如果前面60cm 没有东西就停止</span></span><br><span class="line">		HAL_Delay(<span class="number">10</span>);<span class="comment">//读取超声波传感器不能过快</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(g_ucMode == <span class="number">5</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="comment">//*************MPU6050航向角 PID转向控制*****************//</span></span><br><span class="line"></span><br><span class="line">		<span class="built_in">sprintf</span>((<span class="type">char</span> *)Usart3String,<span class="string">&quot;pitch:%.2f roll:%.2f yaw:%.2f\r\n&quot;</span>,pitch,roll,yaw);<span class="comment">//显示6050数据 俯仰角 横滚角 航向角</span></span><br><span class="line">		HAL_UART_Transmit(&amp;huart3,( <span class="type">uint8_t</span> *)Usart3String,<span class="built_in">strlen</span>(( <span class="type">const</span>  <span class="type">char</span>  *)Usart3String),<span class="number">0xFFFF</span>);<span class="comment">//通过串口三输出字符 strlen:计算字符串大小	</span></span><br><span class="line">	   </span><br><span class="line">	   <span class="comment">//mpu_dmp_get_data(&amp;pitch,&amp;roll,&amp;yaw);//返回值:0,DMP成功解出欧拉角</span></span><br><span class="line">		<span class="keyword">while</span>(mpu_dmp_get_data(&amp;pitch,&amp;roll,&amp;yaw)!=<span class="number">0</span>)&#123;&#125;  <span class="comment">//这个可以解决经常读不出数据的问题</span></span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		g_fMPU6050YawMovePidOut = PID_realize(&amp;pidMPU6050YawMovement,yaw);<span class="comment">//PID计算输出目标速度 这个速度，会和基础速度加减</span></span><br><span class="line"></span><br><span class="line">		g_fMPU6050YawMovePidOut1 = <span class="number">1.5</span> + g_fMPU6050YawMovePidOut;<span class="comment">//基础速度加减PID输出速度</span></span><br><span class="line">		g_fMPU6050YawMovePidOut2 = <span class="number">1.5</span> - g_fMPU6050YawMovePidOut;</span><br><span class="line">		<span class="keyword">if</span>(g_fMPU6050YawMovePidOut1 &gt;<span class="number">3.5</span>) g_fMPU6050YawMovePidOut1 =<span class="number">3.5</span>;<span class="comment">//进行限幅</span></span><br><span class="line">		<span class="keyword">if</span>(g_fMPU6050YawMovePidOut1 &lt;<span class="number">0</span>) g_fMPU6050YawMovePidOut1 =<span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span>(g_fMPU6050YawMovePidOut2 &gt;<span class="number">3.5</span>) g_fMPU6050YawMovePidOut2 =<span class="number">3.5</span>;</span><br><span class="line">		<span class="keyword">if</span>(g_fMPU6050YawMovePidOut2 &lt;<span class="number">0</span>) g_fMPU6050YawMovePidOut2 =<span class="number">0</span>;</span><br><span class="line">		motorPidSetSpeed(g_fMPU6050YawMovePidOut1,g_fMPU6050YawMovePidOut2);</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>可以测试上面的代码 然后没有问题后，我们添加一个通过蓝牙APP按钮切换模式代码</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230111135256610.png" alt="image-20230111135256610"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(g_ucUsart3ReceiveData == <span class="string">&#x27;J&#x27;</span>) <span class="comment">//改变模式</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(g_ucMode == <span class="number">5</span>) g_ucMode = <span class="number">1</span>;<span class="comment">//g_ucMode模式是0 1 2 3 4 5 </span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		g_ucMode+=<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(g_ucUsart3ReceiveData == <span class="string">&#x27;K&#x27;</span>) g_ucMode=<span class="number">0</span>;<span class="comment">//设置为显示模式</span></span><br></pre></td></tr></table></figure>
<p>然后对应APP也要添加 按钮设置</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230111135837135.png" alt="image-20230111135837135" style="zoom:67%;" /></p>
<p>我们</p>
<p>按键没有消抖效果不好，我们消抖一下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230111161916819.png" alt="image-20230111161916819"></p>
<p>我们增加了 HAL延时和再次判断电平</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">HAL_GPIO_EXTI_Callback</span><span class="params">(<span class="type">uint16_t</span> GPIO_Pin)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(GPIO_Pin == KEY1_Pin) <span class="comment">//判断一下那个引脚触发中断</span></span><br><span class="line">	&#123;</span><br><span class="line">		HAL_Delay(<span class="number">10</span>);<span class="comment">//延时消抖 主要</span></span><br><span class="line">		<span class="keyword">if</span>(HAL_GPIO_ReadPin(KEY1_GPIO_Port, KEY1_Pin) == GPIO_PIN_SET)<span class="comment">//判断KEY1引脚仍为高电平</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//这里编写触发中断后要执行的程序</span></span><br><span class="line">			<span class="keyword">if</span>(g_ucMode == <span class="number">5</span>) g_ucMode = <span class="number">1</span>;<span class="comment">//g_ucMode模式是0 1 2 3 4 5 </span></span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				g_ucMode+=<span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			HAL_GPIO_TogglePin(LED_GPIO_Port,LED_Pin);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(GPIO_Pin == KEY2_Pin) <span class="comment">//判断一下那个引脚触发中断</span></span><br><span class="line">	&#123;</span><br><span class="line">		HAL_Delay(<span class="number">10</span>);<span class="comment">//延时消抖</span></span><br><span class="line">		<span class="keyword">if</span>(HAL_GPIO_ReadPin(KEY2_GPIO_Port, KEY2_Pin) == GPIO_PIN_RESET)<span class="comment">//判断KEY2引脚仍为低电平</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//这里编写触发中断后要执行的程序</span></span><br><span class="line">			g_ucMode=<span class="number">0</span>;</span><br><span class="line">			HAL_GPIO_TogglePin(LED_GPIO_Port,LED_Pin);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>但是测试不能执行中断，程序异常卡死了</p>
<p>原因是HAL_Delay使用的是sysTick 中断优先级在软件初始化是默认最低的，比外部中断优先级低，所以HAL_Delay不能在外部中断服务函数中调用。</p>
<p>所以我们可以通过提高sysTick 中断的优先级，提高的比HAL_Delay高。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230111205153163.png" alt="image-20230111205153163"></p>
<p>然后我们提高至 如下图</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20230111184656982.png" alt="image-20230111184656982"></p>
<p>然后编译烧录测试按键是否更加稳定。</p>
<h1 id="以上是应用篇"><a href="#以上是应用篇" class="headerlink" title="以上是应用篇"></a>以上是应用篇</h1><h1 id="下面19是扩展"><a href="#下面19是扩展" class="headerlink" title="下面19是扩展"></a>下面19是扩展</h1><h1 id="第22章-小车如何查找异常问题"><a href="#第22章-小车如何查找异常问题" class="headerlink" title="第22章-小车如何查找异常问题"></a>第22章-小车如何查找异常问题</h1><p>前面我们已经移植 好了OLED程序，下面我们就直接使用OLED,我们在定时器刷新OLED，我们50ms执行一次</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221108162446208.png" alt="image-20221108162446208"></p>
<p>应该这样写</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221108190207208.png" alt="image-20221108190207208"></p>
<p>显示行进路程累计</p>
<p>但是发现计算不准确，怀疑中断时间不准确，如何确定中断是否按时到达那？</p>
<ol>
<li>使用sysTick统计时间</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221108193053984.png" alt="image-20221108193053984"></p>
<ol>
<li>在要判断时间的地方反转GPIO通过示波器观察 是否按时中断</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221108194432504.png" alt="image-20221108194432504"></p>
<p> 然后示波器测量引脚PC13</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221108194541853.png" alt="image-20221108194541853"></p>
<p>所以调试发现</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221108194818938.png" alt="image-20221108194818938"></p>
<p> 所以更新显示应该放到主函数执行，然后 </p>
<p>我们的中断函数这样写</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221108203833681.png" alt="image-20221108203833681"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">if</span>(EncoderTimer_Count%<span class="number">10</span> == <span class="number">0</span>)  <span class="comment">//每20ms 进入一次</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//进行PID计算、然后作用于电机</span></span><br><span class="line">	Motor_Set(PID_realize(&amp;pid1_speed,Motor1_Speed),PID_realize(&amp;pid2_speed,Motor2_Speed));</span><br><span class="line">	<span class="comment">//向上位机发送数据</span></span><br><span class="line">	ANO_DT_Send_F2(Motor1_Speed*<span class="number">100</span>, <span class="number">3.0</span>*<span class="number">100</span>,Motor2_Speed*<span class="number">100</span>,<span class="number">3.0</span>*<span class="number">100</span>);</span><br><span class="line">	</span><br><span class="line">	HAL_GPIO_TogglePin(LED_GPIO_Port,LED_Pin);<span class="comment">//切换LED GPIO状态</span></span><br><span class="line">	<span class="comment">/*里程数 += 时间周期（s）*车轮转速(转/s)*车轮周长(cm)*/</span></span><br><span class="line">	Mileage += <span class="number">0.02</span>*Motor1_Speed*<span class="number">22</span>;</span><br><span class="line">	</span><br><span class="line">	EncoderTimer_Count = <span class="number">0</span>; <span class="comment">//清空计数值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后主函数刷新</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221108203929170.png" alt="image-20221108203929170"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sprintf</span>((<span class="type">char</span> *)<span class="built_in">string</span>,<span class="string">&quot;V1:%.2fV2:%.2f &quot;</span>,Motor1_Speed,Motor2_Speed);<span class="comment">//显示两个电机转速 单位：转/秒</span></span><br><span class="line">OLED_ShowString(<span class="number">0</span>,<span class="number">0</span>,<span class="built_in">string</span>,<span class="number">12</span>);</span><br><span class="line">		</span><br><span class="line"><span class="built_in">sprintf</span>((<span class="type">char</span> *)<span class="built_in">string</span>,<span class="string">&quot;Mileage%.2f  &quot;</span>,Mileage);<span class="comment">//显示两个电机转速 单位：转/秒</span></span><br><span class="line">OLED_ShowString(<span class="number">0</span>,<span class="number">1</span>,<span class="built_in">string</span>,<span class="number">12</span>);</span><br></pre></td></tr></table></figure>
<h1 id="一些测试中的坑"><a href="#一些测试中的坑" class="headerlink" title="一些测试中的坑"></a>一些测试中的坑</h1><h2 id="DAP识别芯片无法烧录"><a href="#DAP识别芯片无法烧录" class="headerlink" title="DAP识别芯片无法烧录"></a>DAP识别芯片无法烧录</h2><p>使用这个DAP无法下载这个淘宝核心板</p>
<p>点击下载出现这个报错</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Not a genuine ST Device! Abort connection</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220809123109770.png" alt="image-20220809123109770"></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/chunquqiulailll/article/details/113257923">https://blog.csdn.net/chunquqiulailll/article/details/113257923</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220727195345745.png" alt="image-20220727195345745"></p>
<p>如果这里识别为</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220729113616437.png" alt="image-20220729113616437"></p>
<p>安装过程芯片支持包</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220729113514194.png" alt="image-20220729113514194"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220729113643543.png" alt="image-20220729113643543"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220729113906766.png" alt="image-20220729113906766"></p>
<p>这里就会自动切换</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220729113953359.png" alt="image-20220729113953359"></p>
<h2 id="DAP无法识别芯片"><a href="#DAP无法识别芯片" class="headerlink" title="DAP无法识别芯片"></a><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220809124022451.png" alt="image-20220809124022451">DAP无法识别芯片</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220809124049727.png" alt="image-20220809124049727"></p>
<p>解决方法:</p>
<p>断电，将板子上的BOOT0用短路帽接入3.3V高电平，重新插入DAP，不出意外可见程序烧录成功，此时将BOOT0接回低电平，后续烧录程序便不会出现SWD/JTAG Communication Failure</p>
<h3 id="一个DAP可以问题记录"><a href="#一个DAP可以问题记录" class="headerlink" title="一个DAP可以问题记录"></a>一个DAP可以问题记录</h3><p>烧录代码(烧录时候、断掉电池供电、使用DAP给单片机供电)</p>
<h2 id="stlink下载程序"><a href="#stlink下载程序" class="headerlink" title="stlink下载程序"></a>stlink下载程序</h2><p>下载程序出现错误</p>
<p>Debugger - Cortex-M ErrorCannot access target.Shutting down debug session.</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221116175748401.png" alt="image-20221116175748401"></p>
<p>取消这个勾选、然后编译</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221116180051024.png" alt="image-20221116180051024"></p>
<p>然后编译一下</p>
<p>然后再改回来</p>
<p>反复勾选、编译、取消勾选，然后编译，就可以下载了。</p>
<p>然后我勾选这，就可以下载了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221116213433686.png" alt="image-20221116213433686"></p>
<p>说更新最新的支持包试试</p>
<p><a target="_blank" rel="noopener" href="https://www.keil.com/dd2/Pack/#!#eula-container">https://www.keil.com/dd2/Pack/#!#eula-container</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20220807152834504.png" alt="image-20220807152834504"  /></p>
<h2 id="其他的记录"><a href="#其他的记录" class="headerlink" title="其他的记录"></a>其他的记录</h2><p>细分更多、注意那么电机占空比控制函数也要变化</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/Y/OneDrive/学习笔记/单片机学习笔记/好家伙VCC智能小车笔记/STM32小车V3.1笔记.assets/image-20221210172627483.png" alt="image-20221210172627483"></p>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>STM32智能小车</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="http://example.com/2023/11/22/STM32%E6%99%BA%E8%83%BD%E5%B0%8F%E8%BD%A6/">http://example.com/2023/11/22/STM32%E6%99%BA%E8%83%BD%E5%B0%8F%E8%BD%A6/</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>作者</h><div class="post-copyright-cc-info"><h>6+1</h></div></div><div class="post-copyright-c"><h>发布于</h><div class="post-copyright-cc-info"><h>2023-11-22</h></div></div><div class="post-copyright-u"><h>更新于</h><div class="post-copyright-cc-info"><h>2023-11-25</h></div></div><div class="post-copyright-c"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/STM32/">STM32</a></div><div class="post_share"></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%AB%A0-%E7%A1%AC%E4%BB%B6"><span class="toc-number">1.</span> <span class="toc-text">第一章-硬件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E5%85%83%E4%BB%B6%E9%80%89%E5%9E%8B"><span class="toc-number">1.1.</span> <span class="toc-text">1.1-元件选型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E5%8E%9F%E7%90%86%E5%9B%BE%E4%B8%8EPCB"><span class="toc-number">1.2.</span> <span class="toc-text">1.2-原理图与PCB</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E7%84%8A%E6%8E%A5"><span class="toc-number">1.3.</span> <span class="toc-text">1.3-焊接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-%E7%BB%93%E6%9E%84%E4%B8%8E%E7%BB%84%E8%A3%85"><span class="toc-number">1.4.</span> <span class="toc-text">1.4-结构与组装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5-%E6%B5%8B%E8%AF%95"><span class="toc-number">1.5.</span> <span class="toc-text">1.5-测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%AB%A0-GPIO%E4%B8%8E%E4%B8%AD%E6%96%AD"><span class="toc-number">2.</span> <span class="toc-text">第二章-GPIO与中断</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-0-%E6%96%B0%E5%BB%BA%E5%B7%A5%E7%A8%8B"><span class="toc-number">2.1.</span> <span class="toc-text">2.0-新建工程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E7%82%B9%E7%81%AF"><span class="toc-number">2.2.</span> <span class="toc-text">2.1-点灯</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%83%A7%E5%BD%95%E7%A8%8B%E5%BA%8F-%E5%BF%85%E7%9C%8B-%E4%BD%BF%E7%94%A8%E5%85%B6%E4%B8%AD%E4%B8%80%E4%B8%AA%E6%96%B9%E6%B3%95"><span class="toc-number">2.2.1.</span> <span class="toc-text">烧录程序(必看 使用其中一个方法)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80%EF%BC%9A%E4%BD%BF%E7%94%A8DAP-LINK"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">方法一：使用DAP LINK</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C%EF%BC%9A%E4%BD%BF%E7%94%A8stlink"><span class="toc-number">2.2.1.2.</span> <span class="toc-text">方法二：使用stlink</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A5%E5%85%85%E5%8F%AF%E8%83%BD%E9%81%87%E5%88%B0%E7%9A%84%E5%A4%B1%E8%B4%A5%E6%83%85%E5%86%B5"><span class="toc-number">2.2.2.</span> <span class="toc-text">补充可能遇到的失败情况</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8DAP-LINK"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">使用DAP-LINK</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8stlink"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">使用stlink</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E6%8C%89%E9%94%AE"><span class="toc-number">2.3.</span> <span class="toc-text">2.2-按键</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E7%AB%A0-OLED%E4%BD%BF%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">第三章-OLED使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E8%B5%84%E6%96%99%E5%87%86%E5%A4%87"><span class="toc-number">3.1.</span> <span class="toc-text">3.1-资料准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86"><span class="toc-number">3.2.</span> <span class="toc-text">3.2-相关知识</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E8%A7%A3%E5%86%B3%E4%B8%80%E4%BA%9B%E9%94%99%E8%AF%AF"><span class="toc-number">3.3.</span> <span class="toc-text">3.3-解决一些错误</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-%E5%BC%80%E5%A7%8B%E5%88%9D%E5%A7%8B%E5%8C%96OLED"><span class="toc-number">3.4.</span> <span class="toc-text">3.4-开始初始化OLED</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E4%B8%B2%E5%8F%A3%E5%AE%9E%E9%AA%8C-%E7%AE%80%E5%8D%95%E8%BE%93%E5%87%BA"><span class="toc-number">4.</span> <span class="toc-text">第四章-串口实验(简单输出)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E4%B8%B2%E5%8F%A3%E7%BC%96%E5%86%99"><span class="toc-number">4.1.</span> <span class="toc-text">4.1-串口编写</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E4%B8%B2%E5%8F%A3%E5%AE%9E%E9%AA%8C"><span class="toc-number">4.2.</span> <span class="toc-text">4.2-串口实验</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E7%BA%BF%E5%9B%BE"><span class="toc-number">4.2.1.</span> <span class="toc-text">接线图</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E7%AB%A0-PWM%E6%8E%A7%E5%88%B6%E7%94%B5%E6%9C%BA"><span class="toc-number">5.</span> <span class="toc-text">第五章-PWM控制电机</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E8%AE%A4%E8%AF%86PWM"><span class="toc-number">5.1.</span> <span class="toc-text">5.1-认识PWM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-PWM%E9%85%8D%E7%BD%AE"><span class="toc-number">5.2.</span> <span class="toc-text">5.2-PWM配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-PWM%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95"><span class="toc-number">5.3.</span> <span class="toc-text">5.3-PWM测试方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#KEIL%E8%BD%AF%E4%BB%B6%E4%BB%BF%E7%9C%9F%E6%96%B9%E6%B3%95"><span class="toc-number">5.3.1.</span> <span class="toc-text">KEIL软件仿真方法:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E4%BB%BF%E7%9C%9F%E5%99%A8%E7%A1%AC%E4%BB%B6%E4%BB%BF%E7%9C%9F"><span class="toc-number">5.3.2.</span> <span class="toc-text">使用仿真器硬件仿真</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E6%B3%A2%E5%99%A8%E5%B7%A5%E5%85%B7%E6%B5%8B%E9%87%8F%E6%B3%A2%E5%BD%A2-%E9%9D%9E%E9%87%8D%E7%82%B9"><span class="toc-number">5.3.3.</span> <span class="toc-text">使用示波器工具测量波形(非重点)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E7%AB%A0-%E7%94%B5%E6%9C%BA%E9%A9%B1%E5%8A%A8%E5%92%8CPWM"><span class="toc-number">6.</span> <span class="toc-text">第六章-电机驱动和PWM</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E8%AE%A4%E8%AF%86%E7%94%B5%E6%9C%BA%E9%A9%B1%E5%8A%A8"><span class="toc-number">6.1.</span> <span class="toc-text">6.1-认识电机驱动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E4%BD%BF%E7%94%A8%E7%94%B5%E6%9C%BA%E9%A9%B1%E5%8A%A8-%E7%8B%AC%E7%AB%8B%E5%B7%A5%E7%A8%8B"><span class="toc-number">6.2.</span> <span class="toc-text">6.2-使用电机驱动(独立工程)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E5%92%8C%E7%BC%96%E5%86%99%E4%BB%A3%E7%A0%81"><span class="toc-number">6.2.1.</span> <span class="toc-text">分析和编写代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BF%E7%9C%9F%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81"><span class="toc-number">6.2.2.</span> <span class="toc-text">仿真测试代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%89%A9%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81"><span class="toc-number">6.2.3.</span> <span class="toc-text">实物测试代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-%E7%BC%96%E5%86%99%E7%94%B5%E6%9C%BA%E8%BD%AC%E9%80%9F%E5%BC%80%E7%8E%AF%E6%8E%A7%E5%88%B6%E5%87%BD%E6%95%B0-%E5%8F%A6%E5%A4%96%E5%A4%8D%E5%88%B6%E5%B7%A5%E7%A8%8B"><span class="toc-number">6.3.</span> <span class="toc-text">6.3-编写电机转速开环控制函数(另外复制工程)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%83%E7%AB%A0-%E7%BC%96%E7%A0%81%E5%99%A8%E6%B5%8B%E9%80%9F"><span class="toc-number">7.</span> <span class="toc-text">第七章-编码器测速</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-%E8%AE%A4%E8%AF%86%E7%BC%96%E7%A0%81%E5%99%A8"><span class="toc-number">7.1.</span> <span class="toc-text">7.1-认识编码器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2%E5%8D%95%E7%89%87%E6%9C%BA%E5%AE%9A%E6%97%B6%E5%99%A8%E7%9A%84%E7%BC%96%E7%A0%81%E5%99%A8%E5%8A%9F%E8%83%BD"><span class="toc-number">7.2.</span> <span class="toc-text">7.2单片机定时器的编码器功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-3-%E8%8E%B7%E5%BE%97%E5%8D%95%E4%BD%8D%E6%97%B6%E9%97%B4%E8%AE%A1%E6%95%B0%E5%99%A8%E5%80%BC%E5%8F%98%E5%8C%96%E9%87%8F"><span class="toc-number">7.3.</span> <span class="toc-text">7.3-获得单位时间计数器值变化量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-4-%E4%B8%BB%E5%87%BD%E6%95%B0%E5%91%A8%E6%9C%9F%E6%B5%8B%E9%87%8F%E8%BD%AC%E9%80%9F"><span class="toc-number">7.4.</span> <span class="toc-text">7.4-主函数周期测量转速</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-5-%E5%AE%9A%E6%97%B6%E5%99%A8%E4%B8%AD%E6%96%AD%E5%AE%9A%E6%97%B6%E6%B5%8B%E9%87%8F%E9%80%9F%E5%BA%A6"><span class="toc-number">7.5.</span> <span class="toc-text">7.5-定时器中断定时测量速度</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%85%AB%E7%AB%A0-PID-%E9%80%9F%E5%BA%A6%E6%8E%A7%E5%88%B6"><span class="toc-number">8.</span> <span class="toc-text">第八章-PID-速度控制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-%E9%80%9F%E5%BA%A6%E6%8E%A7%E5%88%B6%E6%8E%A2%E7%B4%A2"><span class="toc-number">8.1.</span> <span class="toc-text">8.1-速度控制探索</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C-%E5%8C%BF%E5%90%8D%E4%B8%8A%E4%BD%8D%E6%9C%BA%E6%9B%B2%E7%BA%BF%E6%98%BE%E7%A4%BA%E9%80%9F%E5%BA%A6%E6%B3%A2%E5%BD%A2%E6%96%B9%E4%BE%BF%E8%A7%82%E5%AF%9F%E6%95%B0%E6%8D%AE"><span class="toc-number">8.2.</span> <span class="toc-text">8.2-准备工作-匿名上位机曲线显示速度波形方便观察数据</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E5%8D%95%E7%89%87%E6%9C%BA%E5%A4%A7%E5%B0%8F%E7%AB%AF%E6%A8%A1%E5%BC%8F%EF%BC%9A%EF%BC%881%EF%BC%89KEIL-C51%E4%B8%AD%EF%BC%8C%E5%8F%98%E9%87%8F%E9%83%BD%E6%98%AF%E5%A4%A7%E7%AB%AF%E6%A8%A1%E5%BC%8F%E7%9A%84%EF%BC%8C%E8%80%8CKEIL-MDK%E4%B8%AD%EF%BC%8C%E5%8F%98%E9%87%8F%E6%98%AF%E5%B0%8F%E7%AB%AF%E6%A8%A1%E5%BC%8F%E7%9A%84%E3%80%82%EF%BC%882%EF%BC%89SDCC-C51%E6%98%AF%E5%B0%8F%E7%AB%AF%E5%AF%BB%E5%9D%80%EF%BC%8CAVRGCC-%E5%B0%8F%E7%AB%AF%E5%AF%BB%E5%9D%80-%EF%BC%883%EF%BC%89PC%E5%B0%8F%E7%AB%AF%EF%BC%8C%E5%A4%A7%E9%83%A8%E5%88%86ARM%E6%98%AF%E5%B0%8F%E7%AB%AF-%EF%BC%884%EF%BC%89%E6%80%BB%E8%B5%B7%E6%9D%A5%E8%AF%B451%E5%8D%95%E7%89%87%E6%9C%BA%E4%B8%80%E8%88%AC%E6%98%AF%E5%A4%A7%E7%AB%AF%E6%A8%A1%E5%BC%8F%EF%BC%8C32%E5%8D%95%E7%89%87%E6%9C%BA%E4%B8%80%E8%88%AC%E6%98%AF%E5%B0%8F%E7%AB%AF%E6%A8%A1%E5%BC%8F"><span class="toc-number">8.2.0.0.1.</span> <span class="toc-text">常见的单片机大小端模式：（1）KEIL C51中，变量都是大端模式的，而KEIL MDK中，变量是小端模式的。（2）SDCC-C51是小端寻址，AVRGCC 小端寻址.（3）PC小端，大部分ARM是小端 （4）总起来说51单片机一般是大端模式，32单片机一般是小端模式.</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-3-P-I-D-%E9%80%90%E4%B8%AA%E5%8F%82%E6%95%B0%E7%90%86%E8%A7%A3"><span class="toc-number">8.3.</span> <span class="toc-text">8.3-P I D 逐个参数理解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-4-%E5%8A%A0%E5%85%A5cJSON%E6%96%B9%E4%BE%BF%E4%B8%8A%E4%BD%8D%E6%9C%BA%E8%B0%83%E5%8F%82"><span class="toc-number">8.4.</span> <span class="toc-text">8.4-加入cJSON方便上位机调参</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B9%9D%E7%AB%A0-PID%E6%95%B4%E5%AE%9A%E6%96%B9%E6%B3%95"><span class="toc-number">9.</span> <span class="toc-text">第九章-PID整定方法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1-%E8%B0%83%E6%95%B4%E5%90%88%E9%80%82%E7%9A%84%E9%87%87%E6%A0%B7%E5%91%A8%E6%9C%9F%E5%92%8CPID%E8%B0%83%E5%8F%82%E6%96%B9%E6%B3%95"><span class="toc-number">9.1.</span> <span class="toc-text">9.1-调整合适的采样周期和PID调参方法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%A5%E4%B8%8A%E6%98%AF%E5%85%A5%E9%97%A8%E7%AF%87"><span class="toc-number">10.</span> <span class="toc-text">以上是入门篇</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%8B%E9%9D%A2%E5%BA%94%E7%94%A8%E7%AF%87"><span class="toc-number">11.</span> <span class="toc-text">下面应用篇</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC10%E7%AB%A0-%E5%B0%8F%E8%BD%A6%E8%B7%91%E4%B8%80%E8%B7%91"><span class="toc-number">12.</span> <span class="toc-text">第10章-小车跑一跑</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%B0%8F%E8%BD%A6%E7%9A%84%E5%89%8D%E3%80%81%E5%90%8E%E3%80%81%E5%B7%A6%E3%80%81%E5%8F%B3%E3%80%81%E5%81%9C"><span class="toc-number">12.1.</span> <span class="toc-text">如何实现小车的前、后、左、右、停</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%91%E5%B7%A6%E5%8E%9F%E5%9C%B0%E8%BD%AC%E5%BC%AF%E3%80%81%E5%90%91%E5%8E%9F%E5%9C%B0%E8%BD%AC%E5%BC%AF"><span class="toc-number">12.2.</span> <span class="toc-text">向左原地转弯、向原地转弯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E9%80%9F%E5%87%8F%E9%80%9F%E5%87%BD%E6%95%B0"><span class="toc-number">12.3.</span> <span class="toc-text">加速减速函数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC11%E7%AB%A0-OLED%E9%80%9F%E5%BA%A6%E4%B8%8E%E5%8E%86%E7%A8%8B%E6%98%BE%E7%A4%BA"><span class="toc-number">13.</span> <span class="toc-text">第11章-OLED速度与历程显示</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC12%E7%AB%A0-ADC%E9%87%87%E9%9B%86%E7%94%B5%E5%8E%8B%E5%92%8C%E6%98%BE%E7%A4%BA"><span class="toc-number">14.</span> <span class="toc-text">第12章-ADC采集电压和显示</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC13%E7%AB%A0-%E5%BE%AA%E8%BF%B9%E5%8A%9F%E8%83%BD"><span class="toc-number">15.</span> <span class="toc-text">第13章-循迹功能</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#13-1-%E9%9D%9EPID%E5%BE%AA%E8%BF%B9%E5%8A%9F%E8%83%BD%E5%AE%8C%E6%88%90"><span class="toc-number">15.1.</span> <span class="toc-text">13.1-非PID循迹功能完成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%88%E7%BA%A2%E5%A4%96%E5%AF%B9%E7%AE%A1%E8%B0%83%E8%AF%95"><span class="toc-number">15.1.1.</span> <span class="toc-text">先红外对管调试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%84%B6%E5%90%8E%E5%BE%AA%E8%BF%B9%E5%8A%9F%E8%83%BD%E5%AE%8C%E6%88%90"><span class="toc-number">15.1.2.</span> <span class="toc-text">然后循迹功能完成</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-2-%E5%8A%A0%E5%85%A5%E5%BE%AA%E8%BF%B9PID"><span class="toc-number">15.2.</span> <span class="toc-text">13.2-加入循迹PID</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC14%E7%AB%A0-%E6%89%8B%E6%9C%BA%E9%81%A5%E6%8E%A7%E5%8A%9F%E8%83%BD"><span class="toc-number">16.</span> <span class="toc-text">第14章-手机遥控功能</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#14-1-%E7%94%B5%E8%84%91%E6%8E%A7%E5%88%B6%E5%B0%8F%E8%BD%A6"><span class="toc-number">16.1.</span> <span class="toc-text">14.1-电脑控制小车</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-2-%E6%89%8B%E6%9C%BA%E8%93%9D%E7%89%99%E6%8E%A7%E5%88%B6%E5%B0%8F%E8%BD%A6"><span class="toc-number">16.2.</span> <span class="toc-text">14.2-手机蓝牙控制小车</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%93%9D%E7%89%99%E6%A8%A1%E5%9D%97%E5%92%8C%E7%94%B5%E8%84%91%E9%80%9A%E4%BF%A1"><span class="toc-number">16.2.1.</span> <span class="toc-text">蓝牙模块和电脑通信</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%93%9D%E7%89%99%E6%A8%A1%E5%9D%97%E8%BF%9E%E6%8E%A5%E5%8D%95%E7%89%87%E6%9C%BA"><span class="toc-number">16.2.2.</span> <span class="toc-text">蓝牙模块连接单片机</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%ACA%E7%AB%A0-%E5%AE%9A%E4%BD%8D%E7%A8%8B%E5%BA%8F%E5%BC%82%E5%B8%B8%E4%BD%8D%E7%BD%AE"><span class="toc-number">17.</span> <span class="toc-text">第A章-定位程序异常位置</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC15%E7%AB%A0-%E8%B6%85%E5%A3%B0%E6%B3%A2%E9%81%BF%E9%9A%9C%E5%8A%9F%E8%83%BD"><span class="toc-number">18.</span> <span class="toc-text">第15章-超声波避障功能</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#15-1-%E8%B6%85%E5%A3%B0%E6%B3%A2%E6%B5%8B%E8%B7%9D"><span class="toc-number">18.1.</span> <span class="toc-text">15.1-超声波测距</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-2-%E9%81%BF%E9%9A%9C%E9%80%BB%E8%BE%91%E7%BC%96%E5%86%99"><span class="toc-number">18.2.</span> <span class="toc-text">15.2-避障逻辑编写</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC16%E7%AB%A0-%E8%B6%85%E5%A3%B0%E6%B3%A2%E8%B7%9F%E9%9A%8F%E5%8A%9F%E8%83%BD"><span class="toc-number">19.</span> <span class="toc-text">第16章-超声波跟随功能</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A0PID%E8%B7%9F%E9%9A%8F%E5%8A%9F%E8%83%BD"><span class="toc-number">19.1.</span> <span class="toc-text">无PID跟随功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PID%E8%B7%9F%E9%9A%8F%E5%8A%9F%E8%83%BD"><span class="toc-number">19.2.</span> <span class="toc-text">PID跟随功能</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC17%E7%AB%A0-%E7%94%A86050%E8%B5%B0%E7%9B%B4%E7%BA%BF%E5%92%8C%E8%BD%AC90%E5%BA%A6%E5%8A%9F%E8%83%BD"><span class="toc-number">20.</span> <span class="toc-text">第17章-用6050走直线和转90度功能</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#17-1-6050%E5%A7%BF%E6%80%81%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%8F%96"><span class="toc-number">20.1.</span> <span class="toc-text">17.1-6050姿态数据读取</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#STM32%E8%AF%BB%E5%8F%966050%E6%95%B0%E6%8D%AE"><span class="toc-number">20.1.1.</span> <span class="toc-text">STM32读取6050数据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#17-2-%E5%88%A9%E7%94%A86050%E7%9B%B4%E7%BA%BF%E5%92%8C90%E5%BA%A6-%E6%9C%89%E4%BB%A3%E7%A0%81"><span class="toc-number">20.2.</span> <span class="toc-text">17.2-利用6050直线和90度(有代码)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B5%B0%E7%9B%B4%E7%BA%BF-%E6%8E%A7%E5%88%B6%E6%9C%9D%E4%B8%80%E4%B8%AA%E6%96%B9%E5%90%91%E8%BF%90%E5%8A%A8"><span class="toc-number">20.2.1.</span> <span class="toc-text">走直线(控制朝一个方向运动)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%AC%E5%BC%AF90%E5%BA%A6%E5%8A%9F%E8%83%BD-%E6%8E%A7%E5%88%B6%E8%BD%AC%E5%BC%AF%E8%A7%92%E5%BA%A6"><span class="toc-number">20.2.2.</span> <span class="toc-text">转弯90度功能(控制转弯角度)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC18%E7%AB%A0-%E7%BB%BC%E5%90%88%E4%BB%A5%E4%B8%8A%E5%8A%9F%E8%83%BD"><span class="toc-number">21.</span> <span class="toc-text">第18章-综合以上功能</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#18-%E6%8C%89%E9%94%AE%E5%92%8Capp%E6%8C%89%E9%92%AE%E5%88%87%E6%8D%A2%E5%8A%9F%E8%83%BD"><span class="toc-number">21.1.</span> <span class="toc-text">18-按键和app按钮切换功能</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%A5%E4%B8%8A%E6%98%AF%E5%BA%94%E7%94%A8%E7%AF%87"><span class="toc-number">22.</span> <span class="toc-text">以上是应用篇</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%8B%E9%9D%A219%E6%98%AF%E6%89%A9%E5%B1%95"><span class="toc-number">23.</span> <span class="toc-text">下面19是扩展</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC22%E7%AB%A0-%E5%B0%8F%E8%BD%A6%E5%A6%82%E4%BD%95%E6%9F%A5%E6%89%BE%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98"><span class="toc-number">24.</span> <span class="toc-text">第22章-小车如何查找异常问题</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E6%B5%8B%E8%AF%95%E4%B8%AD%E7%9A%84%E5%9D%91"><span class="toc-number">25.</span> <span class="toc-text">一些测试中的坑</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#DAP%E8%AF%86%E5%88%AB%E8%8A%AF%E7%89%87%E6%97%A0%E6%B3%95%E7%83%A7%E5%BD%95"><span class="toc-number">25.1.</span> <span class="toc-text">DAP识别芯片无法烧录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DAP%E6%97%A0%E6%B3%95%E8%AF%86%E5%88%AB%E8%8A%AF%E7%89%87"><span class="toc-number">25.2.</span> <span class="toc-text">DAP无法识别芯片</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%B8%AADAP%E5%8F%AF%E4%BB%A5%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95"><span class="toc-number">25.2.1.</span> <span class="toc-text">一个DAP可以问题记录</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#stlink%E4%B8%8B%E8%BD%BD%E7%A8%8B%E5%BA%8F"><span class="toc-number">25.3.</span> <span class="toc-text">stlink下载程序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E7%9A%84%E8%AE%B0%E5%BD%95"><span class="toc-number">25.4.</span> <span class="toc-text">其他的记录</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-color: transparent;"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 11 6+1</div><div class="footer_custom_text"><div class="github-badge"><a href="http://beian.miit.gov.cn/" target="_blank" title="粤ICP备 2023144467号-1" ), pointer;"><span class="badge-subject">粤ICP备</span><span class="badge-value bg-green">2023144467号-1</span></a></div></div><div id="running-time" style="color: #bbbbbb;"><script>setInterval(()=>{let create_time=Math.round(new Date('2023/11/21 08:00:00').getTime()/1000);let timestamp=Math.round((new Date().getTime()+8*60*60*1000)/1000);
let second=timestamp-create_time;let time=new Array(0,0,0,0,0);if(second>=365*24*3600){time[0]=parseInt(second/(365*24*3600));second%=365*24*3600;}if(second>=24*3600){time[1]=
parseInt(second/(24*3600));second%=24*3600;}if(second>=3600){time[2]=parseInt(second/3600);second%=3600;}if(second>=60){time[3]=parseInt(second/60);second%=60;}if(second>0){time[4]=second;}currentTimeHtml= 
  '<svg t="1700709558688" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1687" width="200" height="200"><path d="M471.49511147 378.65244479c62.57777813-20.02488853 153.48622187-17.6355552 190.80533333 44.032-27.76177813-2.50311147-55.5235552-5.46133333-83.17155627-8.64711146-1.70666667 2.95822187-5.23377813 8.76088853-6.94044373 11.60533333-41.64266667 3.52711147-77.5964448 26.51022187-103.08266667 58.82311147-12.17422187-34.70222187-9.55733333-71.4524448 2.38933334-105.81333334zM257.59288853 378.19733333c24.00711147-1.8204448 48.01422187-2.95822187 71.90755627-4.20977814 10.69511147 10.24 21.39022187 20.36622187 32.1991104 30.4924448-2.61688853 24.3484448-8.07822187 48.24177813-15.01866667 71.68-7.3955552-3.52711147-22.3004448-10.4675552-29.696-13.88088853-44.48711147-25.71377813-97.28-29.4684448-147.00088853-20.59377813 13.19822187-38.6844448 65.19466667-31.40266667 87.60888853-63.488z" fill="#FDFEFA" p-id="1688"></path><path d="M506.88 470.69866666c32.5404448-26.96533333 75.88977813-30.26488853 116.39466667-30.83377813-39.02577813 35.95377813-38.912 101.26222187 3.75466666 133.6888896-39.936-4.096-84.42311147-2.16177813-118.10133333-27.53422294-25.8275552-15.5875552-27.07911147-58.48177813-2.048-75.32088853zM116.05333333 521.78488853c10.24-51.65511147 62.6915552-65.3084448 107.7475552-69.0631104-32.88177813 38.57066667-28.4444448 92.04622187 0.7964448 131.2995552-43.46311147-3.64088853-89.65688853-19.11466667-108.544-62.2364448zM238.93333333 465.69244479c8.4195552 0.11377813 25.3724448 0.45511147 33.792 0.56888854 1.70666667 5.00622187 5.12 14.79111147 6.71288854 19.6835552-11.83288853 3.18577813-23.66577813 6.25777813-35.49866667 9.32977813l-5.00622187-29.58222187zM654.67733333 587.43466666c23.09688853-4.77866667 45.73866667-11.37777813 68.608-17.29422187 65.7635552 7.73688853 133.46133333 16.04266667 190.80533334 51.88266667 1.024 13.88088853 1.8204448 27.76177813 2.73066666 41.64266667 3.52711147 37.31911147-18.2044448 70.4284448-34.5884448 102.17244373-30.4924448 58.1404448-79.53066667 103.08266667-130.5031104 142.9048896-15.01866667 7.9644448-29.80977813 16.27022187-44.37333333 24.8035552-23.66577813 10.12622187-47.44533333 19.91111147-71.2248896 29.9235552-135.168 39.48088853-287.63022187 11.0364448-396.5155552-78.848-49.60711147-44.37333333-96.82488853-96.59733333-116.16711147-161.67822187-6.3715552-25.14488853-13.19822187-50.176-19.9111104-75.20711146 68.26666667-9.67111147 116.62222187 42.09777813 173.5111104 68.608 19.56977813 35.95377813 52.4515552 60.416 89.6568896 75.88977813-5.80266667 13.42577813-8.76088853 28.672-18.432 40.04977813-44.48711147 19.00088853-88.51911147-7.85066667-129.5928896-22.528 18.54577813 25.03111147 41.87022187 48.9244448 73.84177814 54.95466667 64.7395552 13.42577813 132.096 12.288 197.8595552 6.5991104 54.61333333-4.096 101.71733333-53.93066667 95.0044448-110.13688853-16.95288853 22.7555552-26.51022187 53.13422187-51.54133334 68.608-54.0444448 23.7795552-132.096 23.3244448-162.24711146-36.18133334 36.6364448-16.49777813 67.01511147-42.89422187 90.6808896-75.20711146 68.49422187-31.40266667 114.34666667-97.96266667 187.50577706-120.0355552 1.2515552-2.73066667 3.64088853-8.192 4.8924448-10.92266667M526.67733333 931.83999999c-54.38577813 12.288-109.68177813-1.70666667-163.38488853-11.15022186 5.12 42.2115552 48.46933333 28.672 76.45866667 36.75022186 25.8275552 26.05511147 65.7635552 17.52177813 98.07644373 12.40177814 38.6844448-12.62933333 79.98577813-33.22311147 93.7528896-75.09333334-35.72622187 10.4675552-69.51822187 26.05511147-104.90311147 37.0915552z" fill="#FDFEFA" p-id="1689"></path><path d="M799.63022187 8.53333333h16.1564448c28.21688853 22.7555552 55.86488853 47.9004448 70.76977813 81.80622186 34.36088853 72.9315552 55.86488853 154.96533333 45.62488853 235.97511147-7.168 36.75022187 11.60533333 70.54222187 21.16266667 105.01688853 55.63733333 179.4275552-19.6835552 388.096-172.8284448 495.50222294-105.2444448 76.34488853-244.05333333 106.04088853-370.80177707 75.43466666-109.568-25.6-210.37511147-91.3635552-273.63555626-184.8888896-82.7164448-117.87377813-108.99911147-277.04888853-56.5475552-412.672 42.7804448-91.70488853-5.80266667-190.35022187-19.56977814-283.0791104-8.9884448-43.2355552 37.54666667-77.36888853 77.48266667-70.08711146 66.7875552 8.30577813 119.35288853 52.67911147 174.76266667 86.47111146 44.14577813-10.80888853 85.44711147-32.31288853 131.18577813-37.31911146 73.728-13.88088853 148.7075552-0.7964448 220.04622187 18.77333333C709.06311147 83.05777813 735.80088853 15.13244479 799.63022187 8.53333333m-30.37866667 38.00177813c-28.10311147 37.0915552-57.5715552 73.728-92.84266667 104.22044373-28.78577813 2.61688853-55.75111147-13.42577813-83.85422186-18.20444373-96.93866667-16.72533333-199.68-3.2995552-286.26488854 44.60088853-54.38577813-49.60711147-120.14933333-92.84266667-195.92533333-96.71111146-8.53333333 9.32977813-17.06666667 18.54577813-25.48622293 27.87555626 19.456 62.80533333 32.5404448 127.54488853 40.27733333 192.7395552 13.88088853-15.92888853 27.19288853-32.31288853 40.16355627-49.03822186 7.85066667 0 23.66577813-0.2275552 31.63022186-0.22755627-22.3004448 45.62488853-60.87111147 81.6924448-77.5964448 130.38933333-52.11022187 112.29866667-43.008 242.80177813-4.096 357.48977814l8.192-16.72533334C142.79111147 788.02488853 190.00888853 840.24888853 239.616 884.62222186c108.88533333 89.8844448 261.3475552 118.32888853 396.5155552 78.848 23.7795552-10.0124448 47.55911147-19.79733333 71.2248896-29.9235552 14.5635552-8.53333333 29.35466667-16.83911147 44.37333333-24.8035552 50.9724448-39.82222187 100.01066667-84.7644448 130.5031104-142.9048896 16.384-31.744 38.1155552-64.85333333 34.5884448-102.17244373l20.02488854-0.7964448c-0.34133333-70.4284448 9.78488853-142.22222187-7.96444374-211.28533334-14.79111147-65.3084448-49.3795552-124.1315552-90.6808896-176.01422186-1.59288853-38.79822187-35.49866667-59.50577813-62.9191104-80.78222294 14.22222187-39.36711147 28.55822187-79.41688853 28.1031104-121.96977706 22.98311147 40.39111147 41.1875552 83.28533333 53.248 128.2275552 1.47911147 37.888 8.4195552 80.6684448 47.21777814 98.0764448-0.68266667-79.872-19.2284448-163.84-66.44622187-229.60355627-14.79111147-24.3484448-42.89422187-25.03111147-68.1528896-22.9831104z" fill="#9F4B06" p-id="1690"></path><path d="M469.10577813 484.46577813c25.48622187-32.31288853 61.44-55.296 103.08266667-58.82311147 56.43377813-2.73066667 128.11377813-10.92266667 170.09777707 35.38488853 29.35466667 34.70222187 15.47377813 83.85422187-19.00088854 109.1128896-22.86933333 5.9164448-45.51111147 12.5155552-68.608 17.29422187-55.75111147 3.52711147-121.0595552 7.28177813-165.54666666-32.88177813-20.93511147-17.1804448-19.79733333-45.62488853-20.02488854-70.0871104m37.77422187-13.76711147c-25.03111147 16.83911147-23.7795552 59.73333333 2.048 75.32088853 33.67822187 25.3724448 78.16533333 23.43822187 118.10133333 27.53422294-42.66666667-32.42666667-42.7804448-97.73511147-3.75466666-133.6888896-40.50488853 0.56888853-83.85422187 3.8684448-116.39466667 30.83377813m143.01866667 2.16177813c14.90488853 4.77866667 29.80977813 4.55111147 44.71466666-0.5688896-0.56888853-16.04266667-16.83911147-21.39022187-27.30666666-30.1511104-8.53333333 8.87466667-22.528 15.92888853-17.408 30.72zM101.83111147 533.39022186c-9.89866667-44.8284448 31.9715552-76.34488853 68.15288853-91.70488853 49.72088853-8.87466667 102.51377813-5.12 147.00088853 20.59377813 21.2764448 27.98933333 36.864 70.08711147 7.85066667 98.7591104-58.70933333 60.07466667-186.5955552 54.272-223.00444373-27.648m14.22222186-11.60533333c18.88711147 43.12177813 65.08088853 58.5955552 108.544 62.2364448-29.24088853-39.25333333-33.67822187-92.72888853-0.7964448-131.2995552-45.056 3.75466667-97.5075552 17.408-107.7475552 69.0631104M238.93333333 465.69244479l5.00622187 29.58222187c11.83288853-3.072 23.66577813-6.144 35.49866667-9.32977813-1.59288853-4.8924448-5.00622187-14.67733333-6.71288854-19.6835552-8.4195552-0.11377813-25.3724448-0.45511147-33.792-0.56888854zM325.29066667 671.40266666c48.69688853-0.7964448 118.89777813-12.74311147 136.9884448 46.99022187-23.66577813 32.31288853-54.0444448 58.70933333-90.6808896 75.20711146 30.15111147 59.50577813 108.20266667 59.96088853 162.24711146 36.18133334 25.03111147-15.47377813 34.5884448-45.8524448 51.54133334-68.608 6.71288853 56.20622187-40.39111147 106.04088853-95.0044448 110.13688853-65.7635552 5.68888853-133.12 6.82666667-197.8595552-6.5991104-31.9715552-6.03022187-55.296-29.9235552-73.84177814-54.95466667 41.07377813 14.67733333 85.10577813 41.52888853 129.5928896 22.528 9.67111147-11.37777813 12.62933333-26.624 18.432-40.04977813-37.20533333-15.47377813-70.08711147-39.936-89.6568896-75.88977813 11.94666667-14.5635552 23.89333333-29.12711147 35.95377814-43.69066667 2.048 9.4435552 6.25777813 28.4444448 8.4195552 37.888 0.91022187-9.78488853 2.8444448-29.35466667 3.8684448-39.1395552z" fill="#9F4B06" p-id="1691"></path><path d="M769.2515552 46.53511146c25.25866667-2.048 53.36177813-1.36533333 68.1528896 22.9831104 47.21777813 65.7635552 65.7635552 149.7315552 66.44622187 229.60355627-38.79822187-17.408-45.73866667-60.1884448-47.21777814-98.0764448-12.0604448-44.94222187-30.26488853-87.8364448-53.248-128.2275552 0.45511147 42.55288853-13.88088853 82.60266667-28.1031104 121.96977706 27.4204448 21.2764448 61.32622187 41.984 62.9191104 80.78222294 41.30133333 51.88266667 75.88977813 110.70577813 90.6808896 176.01422186 17.74933333 69.06311147 7.62311147 140.85688853 7.96444374 211.28533334l-20.02488854 0.7964448c-0.91022187-13.88088853-1.70666667-27.76177813-2.73066666-41.64266667-57.344-35.84-125.04177813-44.14577813-190.80533334-51.88266667 34.47466667-25.25866667 48.3555552-74.41066667 19.00088854-109.1128896-41.984-46.3075552-113.664-38.1155552-170.09777707-35.38488853 1.70666667-2.8444448 5.23377813-8.64711147 6.94044373-11.60533333 27.648 3.18577813 55.40977813 6.144 83.17155627 8.64711146-37.31911147-61.6675552-128.2275552-64.05688853-190.80533333-44.032-11.94666667 34.36088853-14.5635552 71.11111147-2.38933334 105.81333334 0.2275552 24.46222187-0.91022187 52.90666667 20.02488854 70.0871104 44.48711147 40.1635552 109.7955552 36.40888853 165.54666666 32.88177813-1.2515552 2.73066667-3.64088853 8.192-4.8924448 10.92266667-73.15911147 22.07288853-119.0115552 88.63288853-187.50577706 120.0355552-18.09066667-59.73333333-88.2915552-47.78666667-136.9884448-46.99022187-1.024 9.78488853-2.95822187 29.35466667-3.8684448 39.1395552-2.16177813-9.4435552-6.3715552-28.4444448-8.4195552-37.888-12.0604448 14.5635552-24.00711147 29.12711147-35.95377814 43.69066667-56.88888853-26.51022187-105.2444448-78.27911147-173.5111104-68.608 6.71288853 25.03111147 13.5395552 50.06222187 19.9111104 75.20711146l-8.192 16.72533334c-38.912-114.688-48.01422187-245.19111147 4.096-357.48977814 16.72533333-48.69688853 55.296-84.7644448 77.5964448-130.38933333-7.9644448 0-23.7795552 0.2275552-31.63022186 0.22755627A1108.13866667 1108.13866667 0 0 1 125.1555552 301.05599999c-7.73688853-65.19466667-20.82133333-129.93422187-40.27733333-192.7395552 8.4195552-9.32977813 16.95288853-18.54577813 25.48622293-27.87555626 75.776 3.8684448 141.5395552 47.104 195.92533333 96.71111146 86.58488853-47.9004448 189.32622187-61.32622187 286.26488854-44.60088853 28.10311147 4.77866667 55.0684448 20.82133333 83.85422186 18.20444373 35.27111147-30.4924448 64.7395552-67.12888853 92.84266667-104.22044373M257.59288853 378.19733333c-22.41422187 32.08533333-74.41066667 24.8035552-87.60888853 63.488-36.18133333 15.36-78.0515552 46.8764448-68.15288853 91.70488853 36.40888853 81.92 164.29511147 87.72266667 223.00444373 27.648 29.01333333-28.672 13.42577813-70.76977813-7.85066667-98.7591104 7.3955552 3.41333333 22.3004448 10.35377813 29.696 13.88088853 6.9404448-23.43822187 12.40177813-47.3315552 15.01866667-71.68-10.80888853-10.12622187-21.504-20.2524448-32.1991104-30.4924448-23.89333333 1.2515552-47.9004448 2.38933333-71.90755627 4.20977814z" fill="#FEE173" p-id="1692"></path><path d="M649.89866667 472.86044479c-5.12-14.79111147 8.87466667-21.84533333 17.408-30.72 10.4675552 8.76088853 26.73777813 14.1084448 27.30666666 30.1511104-14.90488853 5.12-29.80977813 5.3475552-44.71466666 0.5688896zM526.67733333 931.83999999c35.38488853-11.0364448 69.17688853-26.624 104.90311147-37.0915552-13.76711147 41.87022187-55.0684448 62.464-93.7528896 75.09333334-32.31288853 5.12-72.24888853 13.65333333-98.07644373-12.40177814-27.98933333-8.07822187-71.33866667 5.46133333-76.45866667-36.75022186 53.70311147 9.4435552 108.99911147 23.43822187 163.38488853 11.15022186z" fill="#FEE173" p-id="1693"></path></svg> 已经活了 '+time[0]+' 年 '+time[1]+' 天 '+time[2]+' 时 '+time[3]+' 分 '+time[4]+' 秒';document.getElementById("running-time").innerHTML=currentTimeHtml;},1000);</script></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><a class="icon-V hidden" onclick="switchNightMode()" title="浅色和深色模式转换"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button class="share" type="button" title="右键模式" onclick="changeMouseMode()"><i class="fas fa-mouse"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i><span id="percent">0<span>%</span></span></button><button id="go-down" type="button" title="直达底部" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa fa-copy"></i><span>复制</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-search"></i><span>百度搜索</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();"><i class="fa fa-link"></i><span>转到链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()"><i class="fa fa-copy"></i><span>粘贴</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="javascript:rmf.copyWordsLink()"><i class="fa fa-link"></i><span>复制本文地址</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>新窗口打开</span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()"><i class="fa fa-link"></i><span>转到链接</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>复制链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()"><i class="fa fa-download"></i><span>保存图片</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>在新窗口打开</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>复制图片链接</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:randomPost()"><i class="fa fa-paper-plane"></i><span>随便逛逛</span></a><a class="rightMenu-item" href="javascript:switchNightMode();"><i class="fa fa-moon"></i><span>昼夜切换</span></a><a class="rightMenu-item" href="javascript:rmf.switchReadMode();"><i class="fa fa-book"></i><span>阅读模式</span></a><a class="rightMenu-item" href="javascript:toggleWinbox();"><i class="fas fa-cog"></i><span>美化设置</span></a><a class="rightMenu-item" href="javascript:rmf.fullScreen();"><i class="fas fa-expand"></i><span>切换全屏</span></a><a class="rightMenu-item" href="javascript:window.print();"><i class="fa-solid fa-print"></i><span>打印页面</span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script><script async data-pjax src="/js/txmap.js"></script><script defer src="/js/fomal.js"></script><canvas id="universe"></canvas><script defer src="/js/universe.js"></script><script async src="//at.alicdn.com/t/c/font_4341224_thz0gklagdp.js"></script><script async src="https://cdn1.tianli0.top/npm/vue@2.6.14/dist/vue.min.js"></script><script async src="https://cdn1.tianli0.top/npm/element-ui@2.15.6/lib/index.js"></script><script src="/js/sun_moon.js" async></script><script type="text/javascript" src="https://cdn1.tianli0.top/npm/jquery@latest/dist/jquery.min.js"></script><script type="text/javascript" src="/js/rightmenu.js"></script><script async src="/js/title.js"></script><script defer data-pjax src="/js/readPercent.js"></script><script async type="text/javascript" src="https://jsd.onmicrosoft.cn/npm/izitoast@1.4.0/dist/js/iziToast.min.js"></script><script>
    document.body.oncopy = function () {
        iziToast.info({
            timeout: 4000, // 关闭弹窗的时间
          // icon: 'Fontawesome', // 图标类别
            closeOnEscape: 'true', // 允许使用Esc键关闭弹窗
            transitionIn: 'bounceInLeft', // 弹窗打开动画
            transitionOut: 'fadeOutRight', // 弹窗关闭动画
            displayMode: 'replace', // 替换已经打开的弹窗
            layout: '2', // Medium模式
            position: 'topLeft', // 弹窗位置
            //icon: 'fad fa-copy', // 图标类名
            iconUrl:'https://blogblog-1322568013.cos.ap-guangzhou.myqcloud.com/image/%E6%98%9F%E6%98%9F.svg',
            backgroundColor: 'rgb(179, 182, 180)', // 弹窗背景色
            title: '复制成功', // 通知标题
            message: '😝好好学习，天天向上😝' // 通知消息内容
        });
    }
</script>
<script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '1s');
    arr[i].setAttribute('data-wow-offset', '100');
    arr[i].setAttribute('data-wow-iteration', '2');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('pagination');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__rotateInDownLeft');
    arr[i].setAttribute('data-wow-duration', '');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v6.2.0" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" data-title="主题版本Butterfly_v4.6.0" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="本站项目由Github托管" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" alt=""/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></p>';
    console.log('已挂载butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/11/18/STM32HAL库/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/num9.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-11-18</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/11/18/STM32HAL库/&quot;);" href="javascript:void(0);" alt="">STM32HAL库</a><div class="blog-slider__text">HAL库</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/11/18/STM32HAL库/&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/11/18/江科大STM32/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/num6.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-11-18</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/11/18/江科大STM32/&quot;);" href="javascript:void(0);" alt="">STM32标准库</a><div class="blog-slider__text">标准库</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/11/18/江科大STM32/&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/11/18/FreeRTOS/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/num11.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-11-18</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/11/18/FreeRTOS/&quot;);" href="javascript:void(0);" alt="">FreeRTOS</a><div class="blog-slider__text">单片机操作系统</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/11/18/FreeRTOS/&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('已挂载butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><!-- hexo injector body_end end --></body></html>